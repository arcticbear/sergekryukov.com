<? $stopwatch=microtime(); define('E2_VERSION',2416); define('E2_VERSION_NAME','Эгея Бета'); define('E2_RELEASE','2.0&beta;'); define('E2_VERSION_DETAILS','(релиз '. E2_RELEASE .', v'. E2_VERSION .')'); define('E2_VERSION_DESCRIPTION',E2_VERSION_NAME .' '. E2_VERSION_DETAILS); define('E2_UA_STRING','E2 (v'.E2_VERSION.'; Aegea Beta)'); header('X-Powered-By: E2 '. E2_VERSION_DESCRIPTION); setlocale(LC_CTYPE,'ru_RU.CP1251'); if(function_exists('date_default_timezone_set'))date_default_timezone_set('GMT'); error_reporting(E_ALL); define('RUN_ID',chr(rand(65,90))); define('DEV_TRACK_TIME',false); define('DEV_HOST','e2'); define('SECONDS_IN_A_MINUTE',60); define('SECONDS_IN_AN_HOUR',3600); define('SECONDS_IN_A_DAY',86400); define('SECONDS_IN_A_MONTH',2592000); define('SECONDS_IN_A_YEAR',31536000); define('YEAR_DISPLAY_THRESH',7884000); define('KILO_THRESH',768); define('BYTES_DECIMALS',1); define('FILE_READ_BUFFER',64*1024); define('KEYWORDS_MANY_THRESH',50); define('NEW_FILES_RIGHTS',0777); define('DOWNLOAD_UPDATES',false); define('ROOT_FOLDER',$_SERVER['DOCUMENT_ROOT'] . (($_SERVER['DOCUMENT_ROOT']!='/')?'/':'')); define('CACHES_FOLDER','caches/'); define('TEMPLATES_FOLDER','themes/'); define('PICTURES_FOLDER','pictures/'); define('THUMBNAILS_FOLDER','pictures/thumbs/'); define('SYSTEM_FOLDER','system/'); define('SCRIPTS_FOLDER','system/js/'); define('DEFAULT_TEMPLATE_FOLDER','system/theme/'); define('DEFAULTS_FOLDER','system/default/'); define('USER_FOLDER','user/'); define('EXTRAS_FOLDER','user/extras/'); define('BACKUP_FOLDER','backups/'); define('MTMPL_FOLDER','system/default/mail/'); define('NO_REASON',''); define('CACHE',true); define('CACHE_NOTES',CACHE and true); define('CACHE_NOTES_COMMENTS',CACHE and true); define('CACHE_HOT',CACHE and true); define('CACHE_FAVS',CACHE and true); define('CACHE_FAVTAGS',CACHE and true); define('CACHE_NOTES_COUNTS',CACHE and true); define('CACHE_EDGE_TIMEINFO',CACHE and true); define('CACHE_FRONTPAGE',CACHE and true); define('CACHE_FULLLIST',CACHE and true); define('CACHE_FILENAMES_NOTES',CACHES_FOLDER.'note-*.ctree.psa'); define('CACHE_FILENAMES_NOTES_COMMENTS', CACHES_FOLDER.'note-*-comments.ctree.psa' ); define('CACHE_FILENAMES_NOTES_COUNTS',CACHES_FOLDER.'notes-count-*.txt'); define('CACHE_FILENAMES_EDGE_TIMEINFO',CACHES_FOLDER.'*.e2time.psa'); define('CACHE_FILENAME_HOT',CACHES_FOLDER.'hot.ctree.psa'); define('CACHE_FILENAME_HOT_EXPIRES',CACHES_FOLDER.'hot-expires.txt'); define('CACHE_FILENAME_FAVS',CACHES_FOLDER.'favourites.ctree.psa'); define('CACHE_FILENAME_FAVTAGS',CACHES_FOLDER.'favtags.ctree.psa'); define('CACHE_FILENAME_FRONTPAGE',CACHES_FOLDER.'frontpage.ctree.psa'); define('CACHE_FILENAME_FRONTPAGE_AUTHOR',CACHES_FOLDER.'frontpage-author.ctree.psa'); define('CACHE_FILENAME_FRONTPAGE_RSS',CACHES_FOLDER.'index.xml'); define('CACHE_FILENAME_FULLLIST',CACHES_FOLDER.'notes-list.ctree.psa'); define('IMPORT_DB_SETTINGS',true); define('DB_PASSWORD_RECOVER_AND_SHOW',false); define('RSS_LANGUAGE','ru'); define('OUTPUT_CHARSET','Windows-1251'); define('DEFAULT_BLOG_TITLE','Мой блог'); define('DEFAULT_BLOG_AUTHOR','Автор блога'); define('DEFAULT_ITEMS_PER_PAGE',10); define('MAX_ITEMS_PER_PAGE',100); define('DB_CANNOT_FIND', -1); define('DB_CANNOT_CONNECT', -2); define('FP_NO_ID_OR_NEW', -1); define('FP_INSERT_ERROR', -10); define('FP_UPDATE_ERROR', -11); define('FP_EMPTY_FIELD', -20); define('FP_TITLE_OR_TEXT_EMPTY', -21); define('FP_NOT_COMMENTABLE', -30); define('FP_COMMENT_DOUBLE_POST', -101); define('FP_COMMENT_TOO_LONG', -102); define('FP_COMMENT_SPAM_SUSPECT', -103); define('NOTE_COMMENTABLE_NOW', -1); define('NOTE_COMMENTABLE_NOW_CONDITIONALLY', -2); define('CSS_CLASS_HIGHLIGHT','e2-marked'); define('THUMB_WIDTH',86); define('THUMB_HEIGHT',64); define('THUMB_JPG_QUALITY',80); define('TRANS_TAGS_UTF8_URLS',false); @include DEFAULTS_FOLDER. 'config.php'; $_default_config=$_config; @include USER_FOLDER. 'config.php'; $_config=array_merge($_default_config,$_config); if($_config['write_log']) { define('__LOG',1); } else { define('__LOG',0); } $ya57c1=substr($_SERVER['PHP_SELF'],0,strpos($_SERVER['PHP_SELF'],'/index.php')); $a57de2=$_SERVER['SERVER_NAME']; if(80!=$_SERVER['SERVER_PORT'])$a57de2.=':'. $_SERVER['SERVER_PORT']; $lf97aa='http://'. $a57de2.$ya57c1; $c097cc='http://'. $a57de2.$_SERVER['REQUEST_URI']; $q5269f=@$_SERVER['HTTP_USER_AGENT'] or $q5269f=''; $_ios=strstr($q5269f,'iPhone') || strstr($q5269f,'iPad'); $_macintosh=strstr($q5269f,'Macintosh'); $_opera=strstr($q5269f,'Opera'); error_reporting(E_ALL); $_db_error=false; $_fp_error=false; $user_globals=array(); $h589b3=true; if(strstr(__FILE__,'all.php'))$h589b3=false; function __log($t1cb25,$uc9e9a=0){ global$_live_log,$stopwatch; $r605ac=str_pad(round(f7f78(),5),19,' ',STR_PAD_RIGHT); $qaf240=str_pad(round(f7f78()-$stopwatch,5),10,' ',STR_PAD_RIGHT); $_live_log[] = array (time(),$qaf240,$t1cb25,$uc9e9a); $l8e13f=$r605ac .' <'. RUN_ID .'> '. $qaf240 .' '. $t1cb25."\n"; if(function_exists('file_put_contents')) { @file_put_contents(USER_FOLDER.'log.txt',$l8e13f,FILE_APPEND); @chmod(USER_FOLDER.'log.txt',NEW_FILES_RIGHTS); } } function e2_go_to($p56790=''){ global $a57de2,$ya57c1; @session_start(); $_SESSION['errors']=xf8d8(); if(substr($p56790,0,7)!='http://'){ header('Location: http://'. $a57de2.$ya57c1 .'/'. $p56790); } else { header('Location: '. $p56790); } flush(); return TRUE; } function i4930(){ $v469bb=$_SERVER['HTTP_REFERER']; return e2_go_to($v469bb); } function y4924($p56790){ if($_SERVER['HTTP_REFERER'])$p56790=$_SERVER['HTTP_REFERER']; return e2_go_to($p56790); } function o8c3b($vb2145=''){ $r9dd4e=substr_count($_SERVER['SERVER_NAME'],'.'); $t2cb9d=@str_repeat('_',$r9dd4e).$vb2145; return $t2cb9d; } function rc64a($vb2145,$j2063c='',$nb0b70=true){ $gcd91e=$nb0b70? (time()+3600*24*365) : (0); $oad5f8=$_SERVER['SERVER_NAME']; $ue9c6c=substr_count($oad5f8,'.'); if ($ue9c6c < 3)$oad5f8=str_repeat('.',3-$ue9c6c).$oad5f8; $r9dd4e=setcookie(o8c3b($vb2145),$j2063c,$gcd91e,'/'); } function v163d($v183d6,$lb45cf,$zcadc8=''){ if(trim($lb45cf)!=''){ $lb45cf=explode($v183d6,$lb45cf); foreach ($lb45cf as $h865c0 => $q8ce4b)$lb45cf[$h865c0]=trim($q8ce4b); foreach ($lb45cf as $h865c0 => $q8ce4b) if ($q8ce4b=='') unset ($lb45cf[$h865c0]); $n7b774=array_unique($lb45cf); if ('sort'==$zcadc8)sort($n7b774); return $n7b774; } else return array (); } function sbb8d($lb45cf){ global$_macintosh,$_opera,$_ios; if($_ios) return ''; $k902bc='<span class="tsp">&nbsp;</span>'; $wd7d18=$k902bc .'+'. $k902bc; $k902bc=''; if ($lb45cf=='submit'){ if($_opera and $_macintosh){ return '&#x2318;'. $k902bc .'&#x21a9;'; } elseif($_macintosh){ return '&#x2303;'. $k902bc .'&#x21a9;'; } else { return 'Ctrl'. $wd7d18 .'Enter'; } } if ($lb45cf=='login'){ return 'L'; } if ($lb45cf=='livesave'){ if($_opera and $_macintosh){ return '&#x2303;'. $k902bc .'S'; } elseif($_macintosh){ return '&#x2318;'. $k902bc .'S'; } else { return 'Ctrl'. $wd7d18 .'S'; } } if ($lb45cf=='navigation'){ if($_opera and $_macintosh){ return '&#x2318;'. $k902bc .'&#x21e7;'; } elseif($_macintosh){ return '&#x2303;'; } else { return 'Ctrl'; } } } function e2_htmlentities($lb45cf){ for ($h865c0=0; $h865c0<strlen($lb45cf); $h865c0++) $t2cb9d.='&#'.ord($lb45cf{$h865c0}).';'; return $t2cb9d; } function e2_unhtmlentities($lb45cf){ $lb45cf=preg_replace('/\&\#([0-9]+?)\;/e','chr ($1)',$lb45cf); if(function_exists('mb_convert_encoding')) $lb45cf=mb_convert_encoding($lb45cf,'ascii'); return $lb45cf; } function k01d3($lb45cf){ $v2db95=strlen($lb45cf); return strspn($lb45cf,'abcdefghijklmnopqrstuvwxyz-1234567890')==$v2db95 and $v2db95 > 0; } function e7b91($t1cb25){ $t1cb25=str_replace('<','&lt;',$t1cb25); $t1cb25=str_replace('>','&gt;',$t1cb25); return $t1cb25; } function bc4b6($t1cb25){ $t1cb25=str_replace('"','&quot;',$t1cb25); return $t1cb25; } function e2_preserve_string($u03c7c){ $u03c7c=$u03c7c[1]; $u03c7c=str_replace('<br />',"\n",$u03c7c); $u03c7c=htmlspecialchars($u03c7c,ENT_NOQUOTES); return '<font color="#dd0000">'.$u03c7c.'</font>'; } function e2_unpreserve_string($u03c7c){ $u03c7c=$u03c7c[1]; $u03c7c=nce9b($u03c7c); return $u03c7c; } function bc198($we358e){ $we358e=highlight_string($we358e,true); $we358e=preg_replace('/\<font color\=\"\#ff8000\"\>(.*?)\<\/font\>/i','',$we358e); $we358e=preg_replace_callback('/\<font color\=\"\#dd0000\"\>(.*?)\<\/font\>/i','e2_preserve_string',$we358e); $we358e=preg_replace('/(\<br \/\>|\s)+/',' ',$we358e); $we358e=preg_replace_callback('/\<font color\=\"\#dd0000\"\>(.*?)\<\/font\>/i','e2_unpreserve_string',$we358e); $we358e=preg_replace('/\<(?!\?)(.*?)(?<!\?)\>/','',$we358e); $we358e=str_replace('&nbsp;',' ',$we358e); $we358e=nce9b($we358e); $we358e=trim($we358e); return $we358e; } function wd738($qcbb11){ $qcbb11=iconv('CP1251','UTF-8',$qcbb11); header('Content-type: text/html; charset=utf-8'); echo $qcbb11; } function gd056($j2063c,$x5d6db){ return str_replace('.',',',round($j2063c,$x5d6db)); } function cada7($lb45cf){ $t2cb9d=''; for ($h865c0==0; $h865c0 <= strlen($lb45cf); ++ $h865c0){ $t2cb9d.='\\'. $lb45cf[$h865c0]; } return $t2cb9d; } function g0786($e957b5){ return sprintf('%u',ip2long($e957b5)); } function s7c85($mb1bc2){ return long2ip(sprintf('%d',$mb1bc2)); } function tace2($t1cb25,$mb1bc2=null){ $y2f713=$t1cb25; if ($mb1bc2===null){ $mb1bc2=substr($t1cb25,0,strpos($t1cb25,' ')); $y2f713=substr($t1cb25,strpos($t1cb25,' ')+1); } $rf07c9=strpos($y2f713,'('); $h46901=strpos($y2f713,')'); if ($h46901 > $rf07c9)$p22b9f=substr($y2f713,$rf07c9,$h46901-$rf07c9+1); $i93da6=explode(',',trim(@$p22b9f,'()')); if(count($i93da6)==2)array_unshift($i93da6,''); $sc78bd=array (2,0,1,1,1,2,2,2,2,2); if ($mb1bc2%100 > 10 and $mb1bc2%100 < 20)$ecd14c=2; else $ecd14c=$sc78bd[$mb1bc2%10]; $def3e3=$i93da6[$ecd14c]; $t1cb25=str_replace($p22b9f,$def3e3,$t1cb25); if(strstr($t1cb25,'(') and strstr($t1cb25,')')) { return tace2($t1cb25,$mb1bc2); } else { return $t1cb25; } } define('_SIZE_UNIT', -1); define('_SIZE_AUTO',0); define('_SIZE_B', 1); define('_SIZE_KB', 2); define('_SIZE_MB', 3); define('_SIZE_GB', 4); define('_SIZE_TB', 5); function p2d88($o4a202,$we5431=_SIZE_AUTO){ global$_format_size_latest_unit; if ($o4a202==_SIZE_UNIT) return$_format_size_latest_unit; $x4b3a6=$o4a202; $xb98b3=array ('Б','КБ','МБ','ГБ','ТБ'); for ($h865c0=0; $h865c0 < count($xb98b3)-1; ++ $h865c0){ if ( (!$we5431 and $x4b3a6 < KILO_THRESH) or ($we5431 and $h865c0==$we5431-1) ) break; $x4b3a6 /= 1024; } $j2063c=str_replace('.',',',round($x4b3a6,BYTES_DECIMALS)); if ($we5431!=_SIZE_AUTO){ if (!strstr($j2063c,','))$j2063c.=','; $j2063c=str_pad($j2063c,strpos($j2063c,',')+1+BYTES_DECIMALS,'0'); } $_format_size_latest_unit=$xb98b3[$h865c0]; return $j2063c; } function vc5a6($jf2ce1){ $d87e9e=glob($jf2ce1,GLOB_NOSORT); if(is_array($d87e9e)) { foreach ($d87e9e as $l435ed){ @unlink($l435ed); } } } function f74dc($e73600){ $d87e9e=glob($e73600 .'*',GLOB_NOSORT); if(is_array($d87e9e)) { foreach ($d87e9e as $l435ed){ if(basename($l435ed)!='.' and basename($l435ed)!='..'){ if(is_dir($l435ed)) { if (f74dc($l435ed .'/')) { if (!rmdir($l435ed)) { return false; } } else { return false; } } else { @unlink($l435ed); } } } return true; } else { return false; } } function tcc38($z572d4){ global $a57de2,$ya57c1; if(__LOG)__log('Spawn '. $z572d4 .'...'); $z572d4=str_replace('http://'. $a57de2,'',$z572d4); $w0666f=@fsockopen($_SERVER['SERVER_NAME'],$_SERVER['SERVER_PORT'],$d70106,$g809b1,1); if(__LOG)__log('Spawn fsockopen returns '. $w0666f .', (errno='. $d70106 .', errstr='. $g809b1 .')...'); if ($w0666f){ @socket_set_timeout($w0666f,1); $n8d777 = 'GET '. $z572d4 ." HTTP/1.0\r\n". 'Host: '. $a57de2 ."\r\n". 'User-Agent: '. E2_UA_STRING ."\r\n". uff2e(); $r5e369=@fwrite($w0666f,$n8d777 ."\r\n"); $r5e369=@fclose($w0666f); return true; } else { return false; } } function saf42($qd6fe1){ $qd6fe1=trim($qd6fe1,'/'); $qd6fe1=explode('/',$qd6fe1); $e73600=''; foreach ($qd6fe1 as $j83878){ $e73600=$e73600.$j83878; if (!is_dir($e73600)) { if (@mkdir($e73600)) { @chmod($e73600,NEW_FILES_RIGHTS); } else { return false; } } $e73600=$e73600.'/'; } return true; } function u4d36($qd6fe1){ return preg_replace('/\/([^\/]+?)\/\.\./','',$qd6fe1); } function nce9b($lb45cf){ $mcee6f=get_html_translation_table(HTML_ENTITIES); $mcee6f=array_flip($mcee6f); return strtr($lb45cf,$mcee6f); } function f7f78($v32c11=NULL){ if(NULL==$v32c11)$v32c11=microtime(); list ($d6021b,$i74459)=explode(' ',$v32c11); return ((float)$d6021b + (float)$i74459); } $stopwatch=f7f78($stopwatch); function pedd9($le98a6,$b98df3=false){ $v80a41=''; $jf5a8e=strlen($le98a6); for ($h865c0=0; $h865c0 < 256; ++ $h865c0){ $sf3d13[$h865c0]=0; $d0fc3c=$h865c0; while ($d0fc3c & 0x00000080){ $d0fc3c <<= 1; ++ $sf3d13[$h865c0]; } } for ($h865c0=0xd090; $h865c0 <= 0xd0bf; $h865c0++)$z84a26[$h865c0]=chr(($h865c0 & 0x000000ff)+48); for ($h865c0=0xd180; $h865c0 <= 0xd18f; $h865c0++)$z84a26[$h865c0]=chr(($h865c0 & 0x000000ff)+112); $z84a26[0xd081]="\xa8"; $z84a26[0xd191]="\xb8"; $z84a26[0xc299]="\x99"; $z84a26[0xc2a9]="\xa9"; $z84a26[0xc2ae]="\xae"; $z84a26[0xc2ab]="\xab"; $z84a26[0xc2bb]="\xbb"; $z84a26[0xc2a0]="\xa0"; $h865c0=0; while ($h865c0 < $jf5a8e){ $bac558=$le98a6{$h865c0}; $vc267c=ord($bac558); if ($sf3d13[$vc267c]==0){ $v80a41.=$bac558; ++ $h865c0; } elseif ($sf3d13[$vc267c]==2){ $e06214=$z84a26[($vc267c << 8) | ord($le98a6{$h865c0+1})]; $v80a41 .= ($e06214!=null)? $e06214 : ( $b98df3? ('((html '. mebe5(substr($le98a6,$h865c0,2)) .'))'):'?' ); $h865c0+=2; } else { $edfbc9=substr($le98a6,$h865c0,$sf3d13[$vc267c]); if ($edfbc9=="\xe2\x84\x96")$v80a41.="\xb9"; elseif ($edfbc9=="\xe2\x80\x93")$v80a41.="\x96"; elseif ($edfbc9=="\xe2\x80\x94")$v80a41.="\x97"; elseif ($edfbc9=="\xe2\x80\x98")$v80a41.="\x91"; elseif ($edfbc9=="\xe2\x80\x99")$v80a41.="\x92"; elseif ($edfbc9=="\xe2\x80\x9a")$v80a41.="\x82"; elseif ($edfbc9=="\xe2\x80\x9c")$v80a41.="\x93"; elseif ($edfbc9=="\xe2\x80\x9d")$v80a41.="\x94"; elseif ($edfbc9=="\xe2\x80\x9e")$v80a41.="\x84"; elseif ($edfbc9=="\xe2\x80\xa6")$v80a41.="\x85"; elseif ($edfbc9=="\xe2\x80\xb9")$v80a41.="\x8b"; elseif ($edfbc9=="\xe2\x80\xba")$v80a41.="\x9b"; elseif ($edfbc9=="\xe2\x82\xac")$v80a41.="\x88"; elseif ($edfbc9=="\xe2\x84\xa2")$v80a41.="\x99"; else $v80a41.=$b98df3? ('((html '. mebe5($edfbc9) .'))'):'?'; $h865c0+=$sf3d13[$vc267c]; } } return $v80a41; } function mebe5($j4a8a0){ $acc411=''; $jf5a8e=strlen($j4a8a0); for ($h865c0=0; $h865c0 < $jf5a8e; ++ $h865c0){ $acc411.=preg_replace('/^1*0/','',decbin(ord($j4a8a0{$h865c0}))); } return '&#'. bindec($acc411) .';'; } function ufd97($b341be) { $t2cb9d=$b341be; $t2cb9d=preg_replace_callback('/([\x80-\xFF])/','e2_utf_from_windows_1251_char',$t2cb9d); return $t2cb9d; } function e2_utf_from_windows_1251_char($j4a8a0){ list (, $j4a8a0)=$j4a8a0; if ($j4a8a0=="\xA8") return "\xD0\x81"; if ($j4a8a0=="\xB8") return "\xD1\x91"; if ($j4a8a0 >= "\xC0" && $j4a8a0 <= "\xEF") return "\xD0".chr(ord($j4a8a0)-48); if ($j4a8a0 >= "\xF0") return "\xD1".chr(ord($j4a8a0)-112); if ($j4a8a0=="\x85") return "&#8230;"; if ($j4a8a0=="\x96") return "&#8211;"; if ($j4a8a0=="\x97") return "&#8212;"; if ($j4a8a0=="\xAB") return "&#0171;"; if ($j4a8a0=="\xBB") return "&#0187;"; if ($j4a8a0=="\x91") return "&#8216;"; if ($j4a8a0=="\x92") return "&#8217;"; if ($j4a8a0=="\x93") return "&#8220;"; if ($j4a8a0=="\x94") return "&#8221;"; if ($j4a8a0=="\x84") return "&#8222;"; if ($j4a8a0=="\x99") return "&#8482;"; if ($j4a8a0=="\xb9") return "&#8470;"; if ($j4a8a0=="\xa0") return "&#0160;"; return '?'; }; function acdf0($s8c7dd){ if(function_exists('file_get_contents')) { return @file_get_contents($s8c7dd); } else { $o8fa14=fopen($s8c7dd,"rb"); clearstatcache(); $we358e=fread($o8fa14,filesize($s8c7dd)); fclose($o8fa14); return $we358e; } } function t6e52($s8c7dd,$lb45cf){ if(function_exists('file_put_contents')) { if (!file_put_contents($s8c7dd,$lb45cf,LOCK_EX)) { return false; } } else { if ($w0666f=@fopen($s8c7dd,'a+b')) { flock($w0666f,LOCK_EX); ftruncate($w0666f,0); fseek($w0666f,0); fwrite($w0666f,$lb45cf); fclose($w0666f); } else { return false; } } @chmod($s8c7dd,NEW_FILES_RIGHTS); return true; } function scd2d($s8c7dd,$lb45cf){ if(function_exists('file_put_contents')) { $t2cb9d=@file_put_contents($s8c7dd,$lb45cf); @chmod($s8c7dd,NEW_FILES_RIGHTS); return $t2cb9d; } else { $o8fa14=@fopen($s8c7dd,'ab'); if ($o8fa14){ if (@flock($o8fa14,LOCK_EX)) { $eb92d9=ignore_user_abort(1); @ftruncate($o8fa14,0); @fseek($o8fa14,0); fwrite($o8fa14,$lb45cf); fflush($o8fa14); @flock($o8fa14,LOCK_UN); fclose($o8fa14); @chmod($s8c7dd,NEW_FILES_RIGHTS); ignore_user_abort($eb92d9); return true; } else { fclose($o8fa14); return false; } } else { return false; } } } function p1825($b96704){ $m89484='абвгдеёжзийклмнопрстуфхцчшщъыьэюяАБВГДЕЁЖЗИЙКЛМНОПРСТУФХЦЧШЩЪЫЬЭЮЯ'; if(strspn($b96704,$m89484) > 0){ $b96704=strtr($b96704,$m89484,'abvgdеёжzijklmnoprstufhcчшщъyьeюяABVGDЕЁЖZIJKLMNOPRSTUFHCЧШЩЪYЬEЮЯ'); $b96704=strtr($b96704, array ( 'е' => 'je', 'ё' => 'jo', 'ж' => 'zh', 'ч' => 'ch', 'ш' => 'sh', 'щ' => 'sch', 'ъ' => '\'', 'ь' => '\'', 'ю' => 'ju', 'я' => 'ja', 'Е' => 'Je', 'Ё' => 'Jo', 'Ж' => 'Zh', 'Ч' => 'Ch', 'Ш' => 'Sh', 'Щ' => 'Sch', 'Ъ' => '\'', 'Ь' => '\'', 'Ю' => 'Ju', 'Я' => 'Ja', )); w8a40('В имени файла использовались русские буквы. Во избежание проблем, они были заменены латинскими: "'.$b96704.'"'); } if(strstr($b96704,' ')) { $b96704=strtr($b96704, array (' ' => '-')); w8a40('В имени файла использовались пробелы. Во избежание проблем, они были заменены дефисами: "'.$b96704.'"'); } if(is_file(PICTURES_FOLDER.$b96704)) { $w5c917=substr($b96704,0,strrpos($b96704,'.')); $wabf77=substr($b96704,strrpos($b96704,'.')); $h865c0=0; while (is_file($w5c917.'_'.++$h865c0.$wabf77)); $b96704=$w5c917.'_'.$h865c0.$wabf77; w8a40('Файл с таким именем уже есть, поэтому новый файл был закачан под именем "'.$b96704.'"'); } return $b96704; } function v291d($qaf721){ global$_config; $fa93b8=pathinfo($qaf721); $wabf77=$fa93b8['extension']; if(in_array(strtolower($wabf77), array ('jpg','gif','png'))) { $if1210=THUMBNAILS_FOLDER.str_replace($wabf77,'thumb.'. $wabf77,$qaf721); if (!is_file($if1210)) { if (@saf42(THUMBNAILS_FOLDER)) { w15e4( PICTURES_FOLDER.$qaf721, THUMB_WIDTH,THUMB_HEIGHT,THUMB_JPG_QUALITY,$if1210 ); if(is_file($if1210)) { chmod($if1210,$_config['uploaded_files_mode']); } else { return false; } } } return $if1210; } return false; } function e2j_file_upload(){ global$_config; @saf42(PICTURES_FOLDER); @chmod(PICTURES_FOLDER,$_config['uploaded_files_mode']); foreach($_FILES as $s8c7dd){ if (!$s8c7dd['error']) { if(__LOG)__log('Ajax file upload: <'. $s8c7dd['name'].'>'); $b96704=p1825($s8c7dd['name']); move_uploaded_file($s8c7dd['tmp_name'],PICTURES_FOLDER.$b96704); @chmod(PICTURES_FOLDER.$b96704,$_config['uploaded_files_mode']); if ($if1210=v291d($b96704)) { if(__LOG)__log('Ajax file upload: thumbnail, done'); die ('image|'. $b96704 .'|'. $if1210); } else { @unlink(PICTURES_FOLDER.$b96704); die ('error|could-not-create-thumbnail'); } } elseif(4!=$s8c7dd['error']) { if ($s8c7dd['error']==1){ die ('error|too-big'); } elseif ($s8c7dd['error']==2){ die ('error|too-big'); } elseif ($s8c7dd['error']==3){ die ('error|partial'); } else { die ('error|'. $s8c7dd['error']); } } } if(__LOG)__log('Ajax file upload error: no files'); die ('error|no-files'); } function e2j_file_remove(){ $s8c7dd=$if1210=''; if(array_key_exists('file',$_POST))$s8c7dd=$_POST['file']; if(array_key_exists('thumb',$_POST))$if1210=$_POST['thumb']; if ($s8c7dd){ $rf6347=@unlink(PICTURES_FOLDER.$s8c7dd); $b8f458=@unlink($if1210); if ($rf6347 and $b8f458) die ('done-file-and-thumb'); if ($rf6347) die ('done-file'); if ($b8f458) die ('done-thumb'); die ('nothing'); } die ('error|no-filename-passed'); } function d74e0(){ global $r2e5d8; if (!isset ($r2e5d8))$r2e5d8=array(); if(is_file(USER_FOLDER.'settings.psa')) { $kfa816=unserialize(acdf0(USER_FOLDER.'settings.psa')); if (!is_array($kfa816))$kfa816=array(); $r2e5d8=array_merge($r2e5d8,$kfa816); } if ( !is_numeric(@$r2e5d8['appearance']['notes_per_page']) or @$r2e5d8['appearance']['notes_per_page'] < 1 ){ $r2e5d8['appearance']['notes_per_page']=DEFAULT_ITEMS_PER_PAGE; } if ( @$r2e5d8['appearance']['notes_per_page'] > MAX_ITEMS_PER_PAGE ){ $r2e5d8['appearance']['notes_per_page']=MAX_ITEMS_PER_PAGE; } if ( !array_key_exists('comments',$r2e5d8) or !array_key_exists('on', @$r2e5d8['comments']) ) { $r2e5d8['comments']['on']=true; } return true; } function e2m_name_and_author(){ global $r2e5d8,$_template; $t2cb9d['title']='Название и автор'; $t2cb9d['heading']='Название и автор'; $t2cb9d['form']='form-name-and-author'; $t2cb9d['form-name-and-author'] = array ( 'form-action' => x83c8('e2s_name_and_author'), 'blog-title-default' => htmlspecialchars(DEFAULT_BLOG_TITLE,ENT_NOQUOTES), 'blog-title' => htmlspecialchars(r6f51(),ENT_NOQUOTES), 'blog-description' => htmlspecialchars(@$r2e5d8['description'],ENT_NOQUOTES), 'blog-author-default' => htmlspecialchars(DEFAULT_BLOG_AUTHOR,ENT_NOQUOTES), 'blog-author' => htmlspecialchars(@$r2e5d8['author'],ENT_NOQUOTES), 'submit-text' => 'Сохранить изменения', ); return $t2cb9d; } function e2s_name_and_author(){ global $r2e5d8; $e05df2=$r67daf=''; if(array_key_exists('blog-title',$_POST)) $e05df2=trim($_POST['blog-title']); if(array_key_exists('blog-description',$_POST))$r67daf = trim($_POST['blog-description']); if(array_key_exists('blog-author',$_POST)) $l02bd9=trim($_POST['blog-author']); $r2e5d8['site_title']=$e05df2; $r2e5d8['site_title']=r6f51(); $r2e5d8['description']=$r67daf; $r2e5d8['author']=$l02bd9; vc5a6(CACHE_FILENAMES_NOTES_COMMENTS); if (!t6e52(USER_FOLDER.'settings.psa',serialize($r2e5d8))) { w8a40('Не получается сохранить информацию'); } e2_go_to(x83c8('e2m_frontpage')) and die; } function e2m_settings(){ global $r2e5d8,$_template; $t2cb9d['title']='Настройка'; $t2cb9d['heading']='Настройка'; $t2cb9d['form']='form-preferences'; $t2cb9d['form-preferences'] = array ( 'form-action' => x83c8('e2s_settings_save'), 'notes-per-page' => $r2e5d8['appearance']['notes_per_page'], 'email-notify?' => (bool) @$r2e5d8['notifications']['new_comments'], 'email' => htmlspecialchars(@$r2e5d8['user']['email'],ENT_NOQUOTES), 'comments-on?' => (bool) @$r2e5d8['comments']['on'], 'comments-fresh-only?' => (bool) @$r2e5d8['comments']['fresh_only'], 'hot-block?' => (bool) (@$r2e5d8['appearance']['hot_frontpage']), 'favourites-block?' => (bool) @$r2e5d8['appearance']['favourites_frontpage'], 'template-name' => $_template['name'], 'templates' => h94dd(), 'submit-text' => 'Сохранить изменения', ); return $t2cb9d; } function e2s_settings_save(){ global $r2e5d8; $e05df2=$r67daf=''; if(array_key_exists('email',$_POST)) $z0c83f=trim($_POST['email']); if(array_key_exists('template',$_POST)) $v66f61=trim($_POST['template']); $r2e5d8['user']['email']=$z0c83f; $q0c2bd=(int)$_POST['notes-per-page']; if ( $r2e5d8['appearance']['notes_per_page']!=$q0c2bd or $r2e5d8['comments']['on'] != isset ($_POST['comments-on']) or $r2e5d8['comments']['fresh_only'] != isset ($_POST['comments-fresh-only']) ) { @unlink(CACHE_FILENAME_FRONTPAGE); @unlink(CACHE_FILENAME_FRONTPAGE_AUTHOR); $r2e5d8['appearance']['notes_per_page']=$q0c2bd; $r2e5d8['comments']['on'] = isset ($_POST['comments-on']); $r2e5d8['comments']['fresh_only'] = isset ($_POST['comments-fresh-only']); } $r2e5d8['notifications']['new_comments'] = isset ($_POST['email-notify']); $r2e5d8['appearance']['favourites_frontpage'] = isset ($_POST['favourites-block']); $r2e5d8['appearance']['hot_frontpage'] = isset ($_POST['hot-block']); $r2e5d8['template']=$v66f61; if (!t6e52(USER_FOLDER.'settings.psa',serialize($r2e5d8))) { w8a40('Не получается сохранить настройку'); } e2_go_to(x83c8('e2m_frontpage')) and die; } function e2m_database(){ global $r2e5d8; $t2cb9d['title']='База данных'; $t2cb9d['heading']='База данных'; $t2cb9d['form']='form-database'; $t2cb9d['form-database'] = array ( 'form-action' => x83c8('e2s_database_save'), 'db-server' => htmlspecialchars(@$r2e5d8['db']['server']? $r2e5d8['db']['server']:'localhost'), 'db-user' => htmlspecialchars(@$r2e5d8['db']['user_name']? $r2e5d8['db']['user_name']:'root'), 'db-password' => htmlspecialchars(@$r2e5d8['db']['passw']), 'db-database' => htmlspecialchars(@$r2e5d8['db']['name']), 'db-prefix' => htmlspecialchars(@$r2e5d8['db']['table_prefix']? $r2e5d8['db']['table_prefix']:'e2Blog'), 'submit-text' => 'Подключиться к базе с этими параметрами', ); return $t2cb9d; } function e2s_database_save(){ global $r2e5d8; if(array_key_exists('db-server',$_POST)) { $r2e5d8['db']['server'] = @$_POST['db-server']; $r2e5d8['db']['user_name'] = @$_POST['db-user']; $r2e5d8['db']['passw'] = @$_POST['db-password']; $r2e5d8['db']['name'] = @$_POST['db-database']; $r2e5d8['db']['table_prefix'] = @$_POST['db-prefix']; if (!t6e52(USER_FOLDER.'settings.psa',serialize($r2e5d8))) { w8a40('Не получается сохранить настройку'); } e2_drop_all_kinds_of_cache(); } e2_go_to(x83c8('e2m_settings')) and die; } d74e0(); function w8a40($r67daf,$v599dc='error'){ global$errors,$r2e5d8,$_config; $r90f2d='Не удалось сформировать backtrace. Функция не поддерживается вашей версией PHP (необходима 4.3 или выше)'; if(function_exists('debug_backtrace'))$r90f2d=debug_backtrace(); $errors[] = array ( 'description' => $r67daf, 'location' => NULL, 'backtrace' => $r90f2d, 'type' => $r90f2d, ); if(count($errors) == @$_config['max_errors']) { w8a40('Слишком много ошибок'); echo eec07(); die; } return true; } function me1c4($xc1336,$r67daf){ if(0==error_reporting() or ($xc1336 & 8)) return; global$errors; w8a40('PHP ('.$xc1336.'): '.$r67daf); $errors[count($errors)-1]['phpcode']=$xc1336; } function h4193(){ global$errors; return (count($errors) > 0); } function xf8d8(){ global$errors; return$errors; } function o2616($j69206){ global $ya57c1; $j69206=array_reverse($j69206); $j69206=array_splice($j69206,0,count($j69206)-1); $te1671='<div style="background: #fea; padding: .25em .5em; margin: .5em 1em 1em 0; line-height: 1em; overflow: hidden">'; foreach ($j69206 as $h865c0 => $we358e){ $b195df=@$we358e['args'] or $b195df=array(); $za956a=array(); foreach ($b195df as $l5919c){ $za956a[] = var_export($l5919c,true); } $s8c7dd=@$we358e['file']; $s8c7dd=str_replace($_SERVER['DOCUMENT_ROOT'],'',$s8c7dd); $m6438c=(@$we358e['line']? (' #'. $we358e['line']) : '?'); $te1671.='<div style="margin: .25em 0 .5em '. $h865c0*3 .'em">'; $te1671.='<span style="float: right; color: #666"> '. $s8c7dd.$m6438c .'</span>'; $te1671.='<tt><b>'. @$we358e['function'] .' (</b>'; if(count($za956a)) { $ceb84a=str_replace("array (\n)",'array ()',$za956a); $ceb84a=implode(', ',$ceb84a); if(0){ $ceb84a=highlight_string('<?'. $ceb84a .'?'.'>',true); $ceb84a=substr($ceb84a,77, -28); } $ceb84a=str_replace('&nbsp;',' ',$ceb84a); $ceb84a=nl2br($ceb84a); $te1671.='<div style="margin: 0 0 0 1.12em">'. $ceb84a .'</div>'; } $te1671.='<b>)</b> &rarr;</tt></div>'; } $te1671.='</div>'; return $te1671; } function eec07(){ global$errors,$r2e5d8,$_config; @session_start(); if(is_array(@$_SESSION['errors'])) { $te1671=array_merge(@$_SESSION['errors'],$errors); } else { $te1671=$errors; } $v1897a=(!oe852()+1 <= (int)$_config['show_call_stack']); if (@$_config['store_backtrace'] and $v1897a and $te1671!=NULL){ t6e52('backtrace.psa',serialize($te1671)); } else { @unlink('backtrace.psa'); } if (isset ($_SESSION['errors'])) unset($_SESSION['errors']); if(count($te1671) > 0){ foreach ($te1671 as $h865c0 => $n08a44){ $te1671[$h865c0]='<li><b>'.$n08a44['description'].'</b>'; if ($v1897a){ $te1671[$h865c0].='<br /><small>'. o2616($n08a44['backtrace']). '</small>'; } $te1671[$h865c0].='</li>'; } if (@$_config['store_backtrace'] and $v1897a and is_file('debug.php')) return @('<ul>'.implode('<br />',$te1671).'</ul>').'<p><a href="debug.php">Отладка</a></p>'; else return @('<ul>'.implode('<br />',$te1671).'</ul>'); } else { return ''; } } set_error_handler('me1c4'); function e2_error404_mode($pfc259=FALSE){ global $r2e5d8,$ya57c1,$a57de2; header('HTTP/1.1 404 Not found'); $z572d4=substr($_SERVER['REQUEST_URI'],strlen($ya57c1)+1); ecede($z572d4); $se70c4=array(); if ($pfc259!==false){ $se70c4['error-404-description']=$pfc259; } else { $se70c4['error-404-description']='Страница не найдена'; } $se70c4['title']=$se70c4['error-404-description']; return $se70c4; } function ecede($z572d4){ if(preg_match('/^([0-9]+)[.-]([0-9]+)[.-]([0-9]+)(.*)/',$z572d4,$j9c28d)) { if(2==strlen($j9c28d[3]))$j9c28d[3]='20'.$j9c28d[3]; e2_go_to($j9c28d[3].'/'.$j9c28d[2].'/'.$j9c28d[1].$j9c28d[4]) and die; } if(preg_match('/keywords(.*)/',$z572d4,$j9c28d)) { e2_go_to('tags'. $j9c28d[1]) and die; } if(preg_match('/tags\/(.+?\/.+?)\/?$/',$z572d4,$j9c28d)) { e2_go_to('tags/'. ltrim(substr($j9c28d[1],strrpos($j9c28d[1],'/')), '/'). '/') and die; } if(preg_match('/tags\-rss\/(.*?)\/?$/',$z572d4,$j9c28d)) { $fe4d23=substr($j9c28d[1],strrpos($j9c28d[1],'/')+1); e2_go_to('tags/'. $fe4d23.'/rss/') and die; } return FALSE; } define('HEL_VERSION','1.54'); define('HEL_SPECIAL_CHAR',"\x1"); define('HEL_SPECIAL_SEQUENCE_LENGTH',6); define('HEL_ADVANCED_FORMATTING',false); define( 'HEL_GLUE_WORDS', '(а|в|во|въ|и|к|ко|къ|о|об|обо|объ|с|со|cъ|у|я|без|безо|безъ|для|до|за|из|изъ|или|на|над|надъ|не|ни|но|от|отъ|по|под|подъ|при|про|a|an|as|and|\&|at|but|by|for|in|no|not|of|on|or|per|the|to)' ); define('HEL_TAG','\\'.HEL_SPECIAL_CHAR .'\d{'. HEL_SPECIAL_SEQUENCE_LENGTH .'}'); define('HEL_TAGS','('. HEL_TAG .')*'); define('HEL_CODEPAGE','win-1251'); function hel_version(){ return HEL_VERSION; } function hel_expand_index($x6a992){ return str_pad($x6a992,HEL_SPECIAL_SEQUENCE_LENGTH,'0',STR_PAD_LEFT); } function hel_savetag($fe4d23){ global $r16234; $x6a992=count($r16234); $r16234[$x6a992]=$fe4d23[0]; return HEL_SPECIAL_CHAR.hel_expand_index($x6a992).HEL_SPECIAL_CHAR; } function hel_restore_tags($t1cb25){ global $r16234; if ($r16234){ foreach ($r16234 as $x6a992 => $j2063c){ $t1cb25=str_replace(HEL_SPECIAL_CHAR. hel_expand_index($x6a992).HEL_SPECIAL_CHAR,$j2063c,$t1cb25); } } return $t1cb25; } function hel_kavychki($t1cb25){ global $r16234; if(HEL_ADVANCED_FORMATTING)$xf5613=hel_savetag(array (0 => "<span class=\"tsp\">&nbsp;</span>")); $yf2119=hel_savetag(array (0 => "<nobr>")); $j63637=hel_savetag(array (0 => "</nobr>")); $t1cb25=trim($t1cb25); $t1cb25=preg_replace_callback( "/(?:(?:\<(script|style|pre|code|tt|textarea|e2\:preserve)[^\>]*\>.*?\<\/\\1\>)". "|(?:\<\!\-\-.*?\-\-\>)|(?:\<[^\>]+\>)|(?:\&\#.*?;))+/isx", 'hel_savetag', $t1cb25 ); $t1cb25=str_replace('<br />',"<br />\n",$t1cb25); $t1cb25=preg_replace("/ {2,}/is",' ',$t1cb25); $t1cb25=preg_replace("/((^|\s|\&nbsp\;)". HEL_TAGS .")\\\"(?!". HEL_TAGS ."($|\&nbsp\;|\s))/m",'$1&laquo;',$t1cb25); $t1cb25=preg_replace("/(?<!^|\s|\&nbsp\;)(". HEL_TAGS ."\\\")(?=". HEL_TAGS ."($|\&nbsp\;|\s))/m",'$2&raquo;',$t1cb25); $jf5a8e=strlen('&laquo;'); $id3ecf=0; for ($h865c0=0; $h865c0 < strlen($t1cb25)-1; ++ $h865c0){ $c53aef=substr($t1cb25,$h865c0,$jf5a8e); if ($c53aef=='&laquo;'){ $id3ecf ++; if ($id3ecf > 1)$t1cb25=substr($t1cb25,0,$h865c0) .'&bdquo;'. substr($t1cb25,$h865c0+$jf5a8e); $h865c0+=$jf5a8e; } if ($c53aef=='&raquo;'){ if ($id3ecf > 1)$t1cb25=substr($t1cb25,0,$h865c0) .'&ldquo;'. substr($t1cb25,$h865c0+$jf5a8e); $id3ecf --; $h865c0+=$jf5a8e; } if ($h865c0 > strlen($t1cb25)-1) break; if ($t1cb25{$h865c0} == '"'){ if ($id3ecf > 0){ if ($id3ecf > 1) $t1cb25=substr($t1cb25,0,$h865c0) .'&ldquo;'. substr($t1cb25,$h865c0+1); else $t1cb25=substr($t1cb25,0,$h865c0) .'&raquo;'. substr($t1cb25,$h865c0+1); -- $id3ecf; } else { $t1cb25=substr($t1cb25,0,$h865c0) .'&laquo;'. substr($t1cb25,$h865c0+1); ++ $id3ecf; } } } if(HEL_CODEPAGE=='win-1251'){ $t1cb25=str_replace("\xab","&laquo;",$t1cb25); $t1cb25=str_replace("\xbb","&raquo;",$t1cb25); } if(HEL_CODEPAGE=='utf-8'){ } if(HEL_ADVANCED_FORMATTING){ $t1cb25=preg_replace( "/(?<=\d)(\%|\\$|\°C|\°F|\&deg\;C|\&deg\;F)/", $xf5613 ."$1", $t1cb25 ); $t1cb25=preg_replace( "/(\#|\№|\\$|\§|\&sect\;)(?=\d)/", "$1". $xf5613, $t1cb25 ); $t1cb25=preg_replace( "/(?<=[A-ZА-Я][a-zа-я])((\/|\+|\=|\–|\@|\&times\;|\&minus\;|\&ndash\;)+)(?=\w)/", $xf5613 ."$1". $xf5613, $t1cb25 ); } if(HEL_ADVANCED_FORMATTING){ $t1cb25=str_replace('и т.д.',$yf2119 .'и т.'. $xf5613 .'д.'. $j63637,$t1cb25); $t1cb25=str_replace('и т.п.',$yf2119 .'и т.'. $xf5613 .'п.'. $j63637,$t1cb25); $t1cb25=str_replace('т.к.',$yf2119 .'т.'. $xf5613 .'к.'. $j63637,$t1cb25); $t1cb25=str_replace('т.е.',$yf2119 .'т.'. $xf5613 .'е.'. $j63637,$t1cb25); $t1cb25=str_replace('т.о.',$yf2119 .'т.'. $xf5613 .'о.'. $j63637,$t1cb25); $t1cb25=str_replace('т.н.',$yf2119 .'т.'. $xf5613 .'н.'. $j63637,$t1cb25); $t1cb25=str_replace('Т.к.',$yf2119 .'Т.'. $xf5613 .'к.'. $j63637,$t1cb25); $t1cb25=str_replace('Т.е.',$yf2119 .'Т.'. $xf5613 .'е.'. $j63637,$t1cb25); $t1cb25=str_replace('Т.о.',$yf2119 .'Т.'. $xf5613 .'о.'. $j63637,$t1cb25); $t1cb25=str_replace('Т.н.',$yf2119 .'Т.'. $xf5613 .'н.'. $j63637,$t1cb25); $t1cb25=preg_replace( "/([A-ZА-Я]\.)(". HEL_TAG .")? *(". HEL_TAG .")?([A-ZА-Я]\.)(". HEL_TAG .")? *(". HEL_TAG .")?([A-ZА-Я][a-zа-я]+)/" . ((HEL_CODEPAGE=='utf-8')? "u":''), $yf2119 .'$1$2'. $xf5613 .'$3$4$5&nbsp;$6$7'. $j63637, $t1cb25 ); $t1cb25=preg_replace( "/([A-ZА-Я][a-zа-я]+)(". HEL_TAG .")? +(". HEL_TAG .")?([A-ZА-Я]\.)(". HEL_TAG .")? *(". HEL_TAG .")?([A-ZА-Я]\.)/" . ((HEL_CODEPAGE=='utf-8')? "u":''), $yf2119 .'$1$2&nbsp;$3$4$5'. $xf5613 .'$6$7'. $j63637, $t1cb25 ); } else { $t1cb25=str_replace('и т.д.',$yf2119 .'и т.&nbsp;д.'. $j63637,$t1cb25); $t1cb25=str_replace('и т.п.',$yf2119 .'и т.&nbsp;п.'. $j63637,$t1cb25); $t1cb25=str_replace('т.к.',$yf2119 .'т.&nbsp;к.'. $j63637,$t1cb25); $t1cb25=str_replace('т.е.',$yf2119 .'т.&nbsp;е.'. $j63637,$t1cb25); $t1cb25=str_replace('т.о.',$yf2119 .'т.&nbsp;о.'. $j63637,$t1cb25); $t1cb25=str_replace('т.н.',$yf2119 .'т.&nbsp;н.'. $j63637,$t1cb25); $t1cb25=str_replace('Т.к.',$yf2119 .'Т.&nbsp;к.'. $j63637,$t1cb25); $t1cb25=str_replace('Т.е.',$yf2119 .'Т.&nbsp;е.'. $j63637,$t1cb25); $t1cb25=str_replace('Т.о.',$yf2119 .'Т.&nbsp;о.'. $j63637,$t1cb25); $t1cb25=str_replace('Т.н.',$yf2119 .'Т.&nbsp;н.'. $j63637,$t1cb25); $t1cb25=preg_replace( "/([A-ZА-Я]\.)(". HEL_TAG .")? *(". HEL_TAG .")?([A-ZА-Я]\.)(". HEL_TAG .")? *(". HEL_TAG .")?([A-ZА-Я][a-zа-я]+)/" . ((HEL_CODEPAGE=='utf-8')? "u":''), $yf2119 .'$1$2&nbsp;$3$4$5&nbsp;$6$7'. $j63637, $t1cb25 ); $t1cb25=preg_replace( "/([A-ZА-Я][a-zа-я]+)(". HEL_TAG .")? +(". HEL_TAG .")?([A-ZА-Я]\.)(". HEL_TAG .")? *(". HEL_TAG .")?([A-ZА-Я]\.)/" . ((HEL_CODEPAGE=='utf-8')? "u":''), $yf2119 .'$1$2&nbsp;$3$4$5&nbsp;$6$7'. $j63637, $t1cb25 ); } $t1cb25=preg_replace("/(([A-ZА-Я][a-zа-я]+)\-([A-ZА-Я][a-zа-я]+))/" . ((HEL_CODEPAGE=='utf-8')? "u":''),$yf2119 .'$0'. $j63637,$t1cb25); $t1cb25=preg_replace( "/([^A-ZА-Я])". HEL_TAGS.HEL_GLUE_WORDS.HEL_TAGS."\s+". HEL_TAGS ."([A-ZА-Я]{3,})/is" . ((HEL_CODEPAGE=='utf-8')? "u":''), '$1$2$3$4&nbsp;$5$6', $t1cb25 ); $t1cb25=preg_replace("/(?<=\s)(\d+)\s+([A-ZА-Я]+)/". ((HEL_CODEPAGE=='utf-8')? "u":''),'\\1&nbsp;\\2',$t1cb25); $t1cb25=str_replace('(c)','&copy;',$t1cb25); $t1cb25=str_replace('(r)','&reg;',$t1cb25); $t1cb25=str_replace('(tm)','&trade;',$t1cb25); $t1cb25=str_replace('(C)','&copy;',$t1cb25); $t1cb25=str_replace('(R)','&reg;',$t1cb25); $t1cb25=str_replace('(TM)','&trade;',$t1cb25); $t1cb25=str_replace("'",'&rsquo;',$t1cb25); $t1cb25=str_replace('--&gt;','&rarr;',$t1cb25); $t1cb25=str_replace('&lt;--','&larr;',$t1cb25); $t1cb25=preg_replace('/( |\&nbsp\;)\-( |\&nbsp\;)/m','\\1&mdash;\\2',$t1cb25); $t1cb25=preg_replace('/^('. HEL_TAGS .')\- /m','$1&mdash; ',$t1cb25); $t1cb25=preg_replace('/ \-('. HEL_TAGS .')$/m','&nbsp;&mdash;$1',$t1cb25); $t1cb25=str_replace('–','&mdash;',$t1cb25); $t1cb25=str_replace(' &mdash;','&nbsp;&mdash;',$t1cb25); $t1cb25=str_replace('--','&mdash;',$t1cb25); $t1cb25=hel_restore_tags($t1cb25); $t1cb25=trim($t1cb25); return $t1cb25; } function q6f10($t1cb25){ return hel_kavychki($t1cb25); } function k154e($af2ffc,$t1cb25,$u5c18e){ if ($af2ffc=='calliope'){ return j5599($t1cb25,$u5c18e); } else { return $t1cb25; } } function wb7f1($t1cb25,$u5c18e){ global$_config; return k154e($_config['default_formatter'],$t1cb25,$u5c18e); } function j5599($t1cb25,$u5c18e){ global$_config,$lf97aa; @ (list ($u5c18e,$ce8fab)=explode('|',$u5c18e)); require_once 'calliope/WikiFormatter.php'; if ('full'==$u5c18e)$wad910=WF_FULL_MODE; elseif ('simple'==$u5c18e)$wad910=WF_SIMPLE_MODE; else return $t1cb25; $k0a1d3=new WikiFormatter(); $k0a1d3 -> replace=array ( '/' => 'i', '+' => 'small', '-' => 's', '*' => 'b', '^' => 'sup', 'v' => 'sub', '#' => 'tt', '!' => 'blockquote', ); $k0a1d3 -> settings=array ( 'hrefSize' => 100, 'localImgDir' => $lf97aa .'/'. PICTURES_FOLDER, 'mode' => $wad910, 'enableShrinkLongHref' => 1, 'enableHr' => 0, 'enableBr' => 1, 'enableHeaders' => 1, 'headersStartWith' => 1, 'enableTables' => 1, 'simpleTableCSSClass' => 'e2-text-table', 'enableAutoAcronymEngine' => 0, 'enableAcronym' => 0, 'acronymBase' => '', 'enableList' => 1, 'mailSafe' => "<a href=\"\" onmouseover=\"this.href='mailto:'+{email}\">{icon}<script language=\"JavaScript\">document.write({name});</script></a>", 'ljUserTag' => '<a href="http://livejournal.com/users/{name}/">{name}</a>', 'fullVersionURL' => $ce8fab, 'enableTagIcons' => 0, 'outerUrlInNewWindow' => 0, 'lineBreak' => "\n", 'extLinkHrefPrefix' => '', ); if (@$_config['link_redirect']) { $m1c55c=u4d36($lf97aa .'/'. trim($_config['link_redirect'],'/')); $k0a1d3 -> settings['extLinkHrefPrefix']=''; $k0a1d3 -> settings['linkredirValue']=$m1c55c .'?'; $k0a1d3 -> settings['ljUserTag'] = ( '<a href="http://livejournal.com/users/{name}/" linkredir="'. $m1c55c .'" >{name}</a>' ); } $t1cb25=$k0a1d3 -> Wiki2HTML($t1cb25); if($_config['autotypography']) { $t1cb25=q6f10($t1cb25); } return $t1cb25; } function e2m_timezone(){ global $r2e5d8; $rde2fd=array ( 'form-action' => x83c8('e2s_select_timezone'), 'submit-text' => 'Выбрать', 'timezone-selector' => e2_timezone_selector($r2e5d8['timezone']['offset'],1), 'dst?' => $r2e5d8['timezone']['is_dst'], ); return array ( 'title' => 'Часовой пояс по умолчанию', 'heading' => 'Часовой пояс по умолчанию', 'form' => 'form-timezone', 'form-timezone' => $rde2fd, ); } function e2_timezones(){ $c5cacd=array ( -720 => '', -660 => '', -600 => '', -540 => '', -480 => '', -420 => '', -360 => '', -300 => '', -240 => '', -210 => '', -180 => '', -120 => '', -60 => '', 0 => 'Время по Гринвичу', 60 => 'Центрально-европейское время', 120 => 'Восточно-европейское время', 180 => 'Московское время', 210 => '', 240 => '', 270 => '', 300 => 'Челябинское время', 330 => '', 345 => '', 360 => '', 390 => '', 420 => '', 480 => '', 540 => '', 570 => '', 600 => '', 660 => '', 720 => '', 780 => '', 840 => '', ); return $c5cacd; } function e2_timezone_name_by_offset($d7a86c){ $c5cacd=e2_timezones(); return @$c5cacd[(int)$d7a86c/SECONDS_IN_A_MINUTE]; } function e2_format_timezone_offset($d7a86c){ $w04b29='+'; if ($d7a86c < 0)$w04b29='&ndash;'; $z73cdd=str_pad((int) (abs($d7a86c)/3600),2,'0',STR_PAD_LEFT); $n640fd=str_pad(abs($d7a86c)/60 % 60,2,'0',STR_PAD_LEFT); return 'GMT'. $w04b29.$z73cdd .':'. $n640fd; } function e2_timezone_selector($q0743a,$b5784d=''){ $c5cacd=e2_timezones(); $t2cb9d=''; if (!$b5784d)$b5784d=count($c5cacd); $t2cb9d.='<select name="offset" size="'. $b5784d .'">'; foreach ($c5cacd as $d7a86c => $n83bce){ $cc03a8=''; if ($d7a86c*SECONDS_IN_A_MINUTE==$q0743a)$cc03a8=' selected="selected"'; $t2cb9d.='<option'. $cc03a8 .' value="'.$d7a86c.'">'; $z73cdd=(int) (abs($d7a86c*SECONDS_IN_A_MINUTE)/3600); $n640fd=(int) (abs($d7a86c*SECONDS_IN_A_MINUTE)/60 % 60); if ($z73cdd)$t2cb9d.=$w04b29.$z73cdd .' ч '. ($n640fd? ($n640fd .' мин'):''); if ($d7a86c and $n83bce){ $t2cb9d .= ' ('. $n83bce. ')'; } elseif (!$d7a86c){ $t2cb9d .= 'нет'; } $t2cb9d.='</option>'; } $t2cb9d.='</select>'; return $t2cb9d; } function e2s_select_timezone(){ global $r2e5d8; if (@$_POST['offset'] >= -720 and @$_POST['offset'] <= 780){ $r2e5d8['timezone']['offset'] = @$_POST['offset']*SECONDS_IN_A_MINUTE; $r2e5d8['timezone']['is_dst'] = isset ($_POST['is_dst']); } if (!t6e52(USER_FOLDER.'settings.psa',serialize($r2e5d8))) { w8a40('Не получается сохранить часовой пояс'); } e2_go_to(x83c8('e2m_settings')) and die (); } function e2_note_timezone($oaad65){ return array ( 'offset' => (int)$oaad65['Offset'], 'is_dst' => (bool)$oaad65['IsDST'], ); } function e2_no_timezone(){ return array ( 'offset' => 0, 'is_dst' => false, ); } function e2_current_timezone(){ global $r2e5d8; return $r2e5d8['timezone']; } function e2_is_dst_in_timezone($qb2c6c,$ydf491){ if (@$qb2c6c['is_dst']) { $b30481=(int)date('I',$ydf491); $f6b7ea=date('Z',$ydf491)-$b30481*SECONDS_IN_AN_HOUR; $q3e61a=$qb2c6c['offset']; $l178ae=$q3e61a-$f6b7ea; $l75b02=date('I',$ydf491+$l178ae); return $l75b02; } else { return 0; } } function e2_timezone_gmt_offset_of_timezone($qb2c6c,$ydf491){ global $r2e5d8; return ( $qb2c6c['offset'] + e2_is_dst_in_timezone($qb2c6c,$ydf491)*SECONDS_IN_AN_HOUR ); } function e2_timezone_gmt_offset_of_current_timezone($ydf491){ return e2_timezone_gmt_offset_of_timezone(e2_current_timezone(),$ydf491); } function e2_format_dt_of_timezone($j1ddcb,$o4a202,$qb2c6c){ return gmdate($j1ddcb,$o4a202+e2_timezone_gmt_offset_of_timezone($qb2c6c,$o4a202)); } function e2_format_dt_of_current_timezone($j1ddcb,$o4a202){ return e2_format_dt_of_timezone($j1ddcb,$o4a202,e2_current_timezone()); } function e2_boundaries_in_gmt($m41529,$n6f8f5=false,$s8277e=false){ if(is_numeric($s8277e)) { $oea2b2=gmmktime(0,0,0,$n6f8f5,$s8277e,$m41529); $o7f021=gmmktime(0,0,0,$n6f8f5,$s8277e+1,$m41529)-1; } elseif(is_numeric($n6f8f5)) { $oea2b2=gmmktime(0,0,0,$n6f8f5,1,$m41529); $o7f021=gmmktime(0,0,0,$n6f8f5+1,1,$m41529)-1; } else { $oea2b2=gmmktime(0,0,0,1,1,$m41529); $o7f021=gmmktime(0,0,0,1,1,$m41529+1)-1; } return array ($oea2b2,$o7f021); } function e2_boundaries_in_timezone($qb2c6c,$m41529,$n6f8f5=false,$s8277e=false){ list ($oea2b2,$o7f021)=e2_boundaries_in_gmt($m41529,$n6f8f5,$s8277e); $oea2b2 -= e2_timezone_gmt_offset_of_timezone($qb2c6c,$oea2b2); $o7f021 -= e2_timezone_gmt_offset_of_timezone($qb2c6c,$o7f021); return array ($oea2b2,$o7f021); } function e2_boundaries_in_current_timezone($m41529,$n6f8f5=false,$s8277e=false){ return e2_boundaries_in_timezone(e2_current_timezone(),$m41529,$n6f8f5,$s8277e); } function e2_boundaries_worldwide($m41529,$n6f8f5=false,$s8277e=false){ $m32038=0; $rda4f0=0; $m32038=13; $rda4f0=-12; $m32038+=1; $rda4f0 -= 1; list ($oea2b2,$o7f021)=e2_boundaries_in_gmt($m41529,$n6f8f5,$s8277e); $oea2b2 -= $m32038*3600; $o7f021 -= $rda4f0*3600; return array ($oea2b2,$o7f021); } function e2_ru_month_nominative($mb1bc2){ $kfa816=array ('Декабрь','Январь','Февраль','Март','Апрель','Май','Июнь', 'Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь','Январь'); return $kfa816[(int)$mb1bc2]; } function e2_ru_month_short_nominative($mb1bc2){ $kfa816=array ('дек','янв','фев','март','апр','май','июнь', 'июль','авг','сен','окт','ноя','дек','янв'); return $kfa816[(int)$mb1bc2]; } function e2_ru_month_genitive($mb1bc2){ $kfa816=array (0 => 'декабря',1 => 'января',2 => 'февраля',3 => 'марта',4 => 'апреля',5 => 'мая',6 => 'июня', 7 => 'июля',8 => 'августа',9 => 'сентября',10 => 'октября',11 => 'ноября',12 => 'декабря',13 => 'января'); return $kfa816[(int)$mb1bc2]; } function e2_plusminus_gmt_offset($d7a86c){ if ((int) @$d7a86c > 0) return (string)'+'.abs(@$d7a86c); elseif ((int) @$d7a86c < 0) return (string)'-'.abs(@$d7a86c); else return ''; } function e2_timezone_gmt_offset_of_current_timezone_rfc2822($ydf491){ $x2ab64=e2_timezone_gmt_offset_of_current_timezone($ydf491); $w04b29=($x2ab64 >= 0)?'+':'-'; $x2ab64=abs($x2ab64); $u03c7c=$x2ab64 % 60; $x2ab64 -= $u03c7c; $n6f8f5=$x2ab64 % 3600/60; $x2ab64 -= $n6f8f5*60; $e2510c=$x2ab64/3600; if ($e2510c < 10)$e2510c='0'.$e2510c; if ($n6f8f5 < 10)$n6f8f5='0'.$n6f8f5; return $w04b29.$e2510c.$n6f8f5; } function e2_timezone_from_posted_offset($caa759){ global $r2e5d8; if(is_numeric($caa759)) { $result['offset']=SECONDS_IN_A_MINUTE*$caa759; $result['is_dst']=false; $ad8935=SECONDS_IN_A_MINUTE*$caa759-SECONDS_IN_AN_HOUR; $ha6cfc=array ('offset' => $ad8935,'is_dst' => true); $ha6cfc=(int)e2_timezone_gmt_offset_of_timezone($ha6cfc,time()); if($result['offset']==$ha6cfc){ $result['offset']=$ad8935; $result['is_dst']=true; } } else { if(array_key_exists('timezone',$r2e5d8)) { $result=$r2e5d8['timezone']; } else { $result['offset']=0; $result['is_dst']=false; } } return$result; } function z692f($z96b8c){ $e2510c=e2_format_dt_of_current_timezone('H',$z96b8c); if ($e2510c <= 4) return 4; elseif ($e2510c <= 10) return 1; elseif ($e2510c <= 16) return 2; elseif ($e2510c <= 22) return 3; else return 4; } function e2_ru_ago($a0e524,$vb65f7=null){ $qb2c6c=e2_current_timezone(); $p97bc5=time(); $c0b375=z692f($p97bc5); $i3dfda=z692f($a0e524); $sdb42a=e2_format_dt_of_timezone('d.m.Y',$p97bc5,$qb2c6c); $q33284=e2_format_dt_of_timezone('d.m.Y',$a0e524,$qb2c6c); $i74459=$p97bc5-$a0e524; if ($i74459 < 0){ return 'Из будущего'; } if ($i74459 >= 0 and $i74459 < 5){ return 'Только что'; } if ($i74459 >= 5 and $i74459 < 25){ $z98bd1=$i74459 .' секунд'; if (($i74459 < 10) || ($i74459 >= 20)) { if (($i74459 % 10)==1)$z98bd1.='у'; if ((($i74459 % 10) >= 2) && (($i74459 % 10) <= 4))$z98bd1.='ы'; } } if ($i74459 >= 25 and $i74459 < 35){ $z98bd1='Полминуты'; } if ($i74459 >= 35 and $i74459 < 55){ $z98bd1='Меньше минуты'; } if ($i74459 >= 55 and $i74459 < 75){ $z98bd1='Минуту'; } if ($i74459 >= 75 and $i74459 < 105){ $z98bd1='Полторы минуты'; } if ($i74459 >= 105 and $i74459 < 25*SECONDS_IN_A_MINUTE){ $q7eccb=$i74459+20; $s7828e=floor($q7eccb/60); $z98bd1=$s7828e .' минут'; if (($s7828e < 10) || ($s7828e >= 20)) { if (($s7828e % 10)==1)$z98bd1.='у'; if ((($s7828e % 10) >= 2) && (($s7828e % 10) <= 4))$z98bd1.='ы'; } } if ($i74459 >= 25*SECONDS_IN_A_MINUTE and $i74459 < 35*SECONDS_IN_A_MINUTE){ $z98bd1='Полчаса'; } if ($i74459 >= 35*SECONDS_IN_A_MINUTE and $i74459 < 60*SECONDS_IN_A_MINUTE){ $z98bd1='Меньше часа'; } if ($i74459 >= 55*SECONDS_IN_A_MINUTE and $i74459 < 75*SECONDS_IN_A_MINUTE){ $z98bd1='Час'; } if ($i74459 >= 75*SECONDS_IN_A_MINUTE and $i74459 < 105*SECONDS_IN_A_MINUTE){ $z98bd1='Полтора часа'; } if ($i74459 >= 105*SECONDS_IN_A_MINUTE and $i74459 < 4*SECONDS_IN_AN_HOUR){ $q7eccb=$i74459+20*SECONDS_IN_A_MINUTE; $kfa816=floor($q7eccb/SECONDS_IN_AN_HOUR); $q7eccb=$q7eccb-$kfa816*SECONDS_IN_AN_HOUR; $z98bd1.=' '.$kfa816.' час'; if (($kfa816 < 10) || ($kfa816 >= 20)) { if ((($kfa816 % 10) >= 2) && (($kfa816 % 10) <= 4))$z98bd1.='а'; if ((($kfa816 % 10) >= 5) || (!($kfa816 % 10)))$z98bd1.='ов'; } else $z98bd1.='ов'; } if ($i74459 >= 4*SECONDS_IN_AN_HOUR and $c0b375 > $i3dfda and $sdb42a==$q33284){ return 'Сегодня в '. e2_format_dt_of_timezone('G:i',$a0e524,$qb2c6c); } if ($z98bd1!=''){ return ltrim($z98bd1). ' назад'; } else { return e2_format_dt_of_timezone('j',$a0e524,$vb65f7). ' '. e2_ru_month_genitive(e2_format_dt_of_timezone('m',$a0e524,$vb65f7)). ((($p97bc5-$a0e524) > YEAR_DISPLAY_THRESH)? (' '. e2_format_dt_of_timezone('Y',$a0e524,$vb65f7)) : ''). ', '. e2_format_dt_of_timezone('G:i',$a0e524,$vb65f7); } } $_model_contractions=array ( 'key' => "INT UNSIGNED AUTO_INCREMENT PRIMARY KEY", 'pkey' => "INT UNSIGNED DEFAULT '0' NOT NULL", 'int' => "INT DEFAULT '0' NOT NULL", 'uint' => "INT UNSIGNED DEFAULT '0' NOT NULL", 'time' => "INT UNSIGNED DEFAULT '0' NOT NULL", '0' => "TINYINT( 1 ) DEFAULT '0' NOT NULL", '1' => "TINYINT( 1 ) DEFAULT '1' NOT NULL", 'v15' => "VARCHAR( 15 ) NOT NULL", 'v32' => "VARCHAR( 32 ) NOT NULL", 'fid' => "VARCHAR( 32 ) DEFAULT '". $_config['default_formatter'] ."' NOT NULL", 'v255' => "VARCHAR( 255 ) NOT NULL", 'text' => "TEXT NOT NULL", ); $_model=array ( 'Notes' => array ( array ('ID', 'key'), array ('Title', 'v255'), array ('URLName', 'v32'), array ('Text', 'text'), array ('FormatterID', 'fid'), array ('IsPublished', '0'), array ('IsIssue', '0'), array ('IsCommentable', '1'), array ('IsVisible', '1'), array ('IsFavourite', '0'), array ('Stamp', 'time'), array ('LastModified', 'time'), array ('Offset', 'int'), array ('IsDST', '0'), array ('IP', 'v15'), ), 'Comments' => array ( array ('ID', 'key'), array ('NoteID', 'pkey'), array ('AuthorName', 'v255'), array ('AuthorEmail', 'v255'), array ('Text', 'text'), array ('Reply', 'text'), array ('Formatter', '0'), array ('IsVisible', '1'), array ('IsFavourite', '0'), array ('IsReplyVisible', '0'), array ('IsReplyFavourite', '0'), array ('IsAnswerAware', '1'), array ('IsSubscriber', '0'), array ('IsSpamSuspect', '0'), array ('IsNew', '0'), array ('Stamp', 'time'), array ('LastModified', 'time'), array ('ReplyStamp', 'time'), array ('ReplyLastModified','time'), array ('IP', 'v15'), ), 'Keywords' => array ( array ('ID', 'key'), array ('ParentKeywordID', 'pkey'), array ('Keyword', 'v255'), array ('URLName', 'v32'), array ('Description', 'text'), array ('IsFavourite', '0'), ), 'NotesKeywords' => array ( array ('ID', 'key'), array ('NoteID', 'pkey'), array ('KeywordID', 'pkey'), ), ); function rf1ac($qaab9e){ global $r2e5d8,$_model,$_model_contractions; if(array_key_exists($qaab9e,$_model)) { $u54ca8=array(); foreach($_model[$qaab9e] as $i1afd3){ list ($ab0689,$v599dc)=$i1afd3; $u54ca8[] = "`". $ab0689 ."` ". $_model_contractions[$v599dc]; } $g1b1cc=( "CREATE TABLE `". $r2e5d8['db']['table_prefix'].$qaab9e ."` ". "(". implode(" ,",$u54ca8) .") ". "ENGINE=MyISAM DEFAULT CHARSET=cp1251" ); if (z0738($g1b1cc)) return true; } } function p9943($qaab9e,$vde17f){ global $r2e5d8; $sd05b6="`". implode("`, `",array_keys($vde17f)). "`"; $vf09cc="'". implode("', '",array_values($vde17f)). "'"; $g1b1cc=( "INSERT INTO `". $r2e5d8['db']['table_prefix'].$qaab9e ."` ". "(".$sd05b6 .") VALUES (". $vf09cc .");" ); if (z0738($g1b1cc)) { $vde17f['ID']=mysql_insert_id(); return $vde17f; } } function taa79($qaab9e,$vde17f,$k7692d=false){ global $r2e5d8; if(__LOG)__log('Model: update record, table <'. $qaab9e .'>'); $f6a7f2=array(); foreach(e2model__soft_fields_for_table_($qaab9e) as $m06e3d){ if(array_key_exists($m06e3d,$vde17f)) { $f6a7f2[] = '`'. $m06e3d .'`'."='". h7928($vde17f[$m06e3d]) ."'"; } } $ub5b39=array(); if(is_array($k7692d)) { foreach(e2model__soft_fields_for_table_($qaab9e) as $m06e3d){ if(array_key_exists($m06e3d,$k7692d)) { $ub5b39[] = '`'. $m06e3d .'`'."='". h7928($k7692d[$m06e3d]) ."'"; } } } if(count($ub5b39)) { $p56790=implode(" AND ",$ub5b39); } else { if (!array_key_exists('ID',$vde17f) or !is_numeric($vde17f['ID'])) { die ('API MISUSE: e2_update_record must be called with an ID field in $record when updating single row'); } $p56790="`ID`=". $vde17f['ID']; } if(count($f6a7f2) > 0){ $g1b1cc=( "UPDATE `". $r2e5d8['db']['table_prefix'].$qaab9e ."` ". "SET ". implode(', ',$f6a7f2) ." WHERE ". $p56790 ); if (z0738($g1b1cc)) return true; } } function e2model__soft_fields_for_table_($qaab9e){ global$_model; $t2cb9d=array(); if(array_key_exists($qaab9e,$_model)) { foreach($_model[$qaab9e] as $m06e3d){ if (!in_array($m06e3d[1], array ('key'))) { $t2cb9d[] = $m06e3d[0]; } } } return $t2cb9d; } function e2m_install(){ global $r2e5d8; $t2cb9d=array(); if(e2_is_installed()) { w8a40('Движок уже установлен'); e2_go_to(''); } else { $t2cb9d['heading']='Новый блог'; $dc50d0='Установить движок и начать блог'; $qd77d5['server'] = @$_COOKIE[o8c3b('install_db_server')]; $qd77d5['user_name'] = @$_COOKIE[o8c3b('install_db_user_name')]; $qd77d5['passw'] = @$_COOKIE[o8c3b('install_db_passw')]; $qd77d5['name'] = @$_COOKIE[o8c3b('install_db_name')]; $qd77d5['table_prefix'] = @$_COOKIE[o8c3b('install_db_table_prefix')]; $qd77d5['exists'] = @$_COOKIE[o8c3b('install_db_exists')]; $t2cb9d['form-install'] = array ( 'form-action' => x83c8('e2s_install'), 'form-check-db-config-action' => x83c8('e2j_check_db_config'), 'form-list-databases-action' => x83c8('e2j_list_databases'), 'submit-text' => $dc50d0, 'db-server' => htmlspecialchars(@$qd77d5['server']? $qd77d5['server']:'localhost'), 'db-user' => htmlspecialchars(@$qd77d5['user_name']? $qd77d5['user_name']:'root'), 'db-password' => htmlspecialchars(DB_PASSWORD_RECOVER_AND_SHOW? (@$qd77d5['passw']) : ''), 'db-database' => htmlspecialchars(@$qd77d5['name']), 'db-prefix' => htmlspecialchars(@$qd77d5['table_prefix']? $qd77d5['table_prefix']:'e2Blog'), 'db-exists?' => (bool)$qd77d5['exists'], ); $x444bc=true; $db5d6c=array (USER_FOLDER,CACHES_FOLDER,PICTURES_FOLDER); $y90fec=array(); $w45a93=array(); foreach ($db5d6c as $e45684){ @saf42($e45684); if(is_dir($e45684)) { if(false !== @scd2d($kfa816=$e45684 .'installer-check.tmp','')) { @unlink($kfa816); } else { $w45a93[] = $e45684; } } else { $y90fec[] = $e45684; } } if(count($y90fec)==0 and count($w45a93)==0){ $t2cb9d['form-install']['installation-possible?']=true; } else { $t2cb9d['form-install']['installation-possible?']=false; $t2cb9d['message']='<p>Так, нужно кое-что поправить.</p>'; if(count($y90fec) > 0){ $t2cb9d['message'].='<p>Не найдены следующие папки из дистрибутива движка:<br />'; foreach ($y90fec as $u987dd){ $t2cb9d['message'].='&nbsp;&nbsp;&nbsp;<tt>'. $u987dd .'</tt>'; } $t2cb9d['message'].='</p>'; $t2cb9d['message'].='<p>Создать их автоматически не удалось из-за недостатка прав. Загрузите на сервер полный дистрибутив.</p>'; } if(count($w45a93) > 0){ $t2cb9d['message'].='<p>Дайте скриптам права на запись в папках:<br />'; foreach ($w45a93 as $m23ce6){ $t2cb9d['message'].='&nbsp;&nbsp;&nbsp;<tt>'. $m23ce6 .'</tt><br />'; } $t2cb9d['message'].='</p>'; } $t2cb9d['message'].='<p>И перезагрузите установщик.</p>'; } } return $t2cb9d; } function e2_instantiate($g2af72){ global$_instance; $_instance['version']=$g2af72; t6e52(USER_FOLDER. '/instance.psa',serialize($_instance)); return true; } function e2s_instantiate($parameters){ if(e2_is_installed()) { w8a40('Сначала удалите <tt>'. USER_FOLDER .'instance.psa</tt>'); e2_go_to(x83c8('e2m_frontpage')); die; } else { if(is_numeric($parameters['version'])) { if(e2_instantiate($parameters['version'])) { w8a40('Инстанциирована версия v'. $parameters['version']); e2_go_to(x83c8('e2m_frontpage')); die; } } } die ('Could not create instance of engine'); } function e2s_install(){ global $r2e5d8,$_instance; if(e2_is_installed()) { e2_go_to(x83c8('e2m_install')); die; } else { e2_drop_all_kinds_of_cache(); $qd77d5['server'] = @$_POST['db-server']; $qd77d5['user_name'] = @$_POST['db-user']; $qd77d5['passw'] = @$_POST['db-password']; $qd77d5['name'] = @$_POST['db-database']; $qd77d5['table_prefix'] = @$_POST['db-prefix']; $qd77d5['exists'] = isset ($_POST['db-exists']); $qb2c6c=e2_timezone_from_posted_offset(@$_POST['gmt-offset']); foreach ($qd77d5 as $q8ce4b => $d9e366){ rc64a('install_db_' .$q8ce4b,$d9e366); } @session_start(); if (!array_key_exists('password',$_POST) or $_POST['password']==''){ w8a40('Вы не ввели пароль'); } if (!h4193()) { $x444bc=true; $e88162=trim($_POST['password']); $w2d6d8['sessions'] = array (array ( 'stamp' => time(), 'remote_ip' => $_SERVER['REMOTE_ADDR'], 'key_hash' => me8ed(true), 'ua' => $_SERVER['HTTP_USER_AGENT'], )); if (!d1d21($w2d6d8)) { $x444bc=false; } if (!@t6e52(USER_FOLDER.'password-hash.psa',serialize(h4c49($e88162)))) { $x444bc=false; } if (!$qd77d5['exists']) { $r2e5d8=array(); } $r2e5d8['db']=$qd77d5; $r2e5d8['timezone']=$qb2c6c; if (!@t6e52(USER_FOLDER.'settings.psa',serialize($r2e5d8))) { $x444bc=false; } if (!$x444bc){ w8a40('Возникли проблемы при записи файлов, возможно недостаточно прав доступа'); } else { if ($qd77d5['exists']) { if(__LOG)__log('Installer: No need to create DB'); $cba46b=q0f7c(); if (!$cba46b){ if(__LOG)__log('Installer: DB not OK'); w8a40('Перепроверьте реквизиты базы'); } } else { if(__LOG)__log('Installer: Creating DB...'); $cba46b=( rf1ac('Notes') and rf1ac('Comments') and rf1ac('Keywords') and rf1ac('NotesKeywords') ); if (!$cba46b){ if(__LOG)__log('Installer: DB not OK'); w8a40('Ошибка при создании таблиц в базе данных. Перепроверьте реквизиты базы'); } } if ($cba46b){ if(__LOG)__log('Installer: DB OK, instantiating...'); e2_instantiate(E2_VERSION); if(__LOG)__log('Installer: Done'); if (!$qd77d5['exists']) { if(__LOG)__log('Installer: Adding indexes...'); z0738( "ALTER TABLE `". $r2e5d8['db']['table_prefix']."Notes` ". "ADD FULLTEXT (`Title`, `Text`)" ); z0738( "ALTER TABLE `". $r2e5d8['db']['table_prefix']."NotesKeywords` ". "ADD INDEX (`NoteID`)" ); if(__LOG)__log('Installer: Done'); } if(__LOG)__log('Installer: Complete'); e2_go_to(); die; } } } if (h4193()) { e2_go_to(x83c8('e2m_install')); die; } } } function e2_is_installed(){ global$_instance; return (bool)$_instance; } function e2_make_sure_that_installed(){ global $a57de2,$ya57c1,$_instance; if(e2_is_installed()) { if(E2_VERSION < $_instance ['version']) { header('HTTP/1.1 503 Service Unavailable'); die ('<big style="background: #a00; color: #ccc; padding: .1em .33em">DOWNDATE</big>'); } elseif(E2_VERSION > $_instance ['version']) { header('Location: http://'. $a57de2.$ya57c1 .'/perform_update/'); header('Location: '. x83c8('e2s_update_perform')); die; } else { return; } } e2_go_to(x83c8('e2m_install')); die; } function e2_dbserver_usable_databases($vcf1e8,$pee11c,$h5f4dc){ $b32e95=array(); if (($t2a304=mysql_connect($vcf1e8,$pee11c,$h5f4dc)) !== false){ $xe61ce=mysql_list_dbs($t2a304); while ($vf1965=mysql_fetch_row($xe61ce)) { if ( mysql_select_db($vf1965[0],$t2a304) and !in_array($vf1965[0], array ('information_schema','mysql')) ) { $b32e95[] = $vf1965[0]; } } } return $b32e95; } function e2j_check_db_config(){ $b0b2a6=array ( 'Notes', 'Keywords', 'NotesKeywords', 'Comments', ); $vcf1e8=$pee11c=$h5f4dc=$y11e0e=$c851f5=''; if(array_key_exists('server',$_POST)) $vcf1e8= $_POST['server']; if(array_key_exists('user',$_POST)) $pee11c= $_POST['user']; if(array_key_exists('password',$_POST))$h5f4dc=$_POST['password']; if(array_key_exists('database',$_POST))$y11e0e=$_POST['database']; if(array_key_exists('prefix',$_POST)) $c851f5= $_POST['prefix']; $we0879=(bool) ($_POST['exists']=='true'); ini_set('mysql.connect_timeout',1); if (($r098f6=mysql_connect($vcf1e8,$pee11c,$h5f4dc)) === false){ if (($r098f6=mysql_connect($vcf1e8)) === false){ die ('no-connect'); } else { die ('server-responding'); } } else { if (!$y11e0e){ $b32e95=e2_dbserver_usable_databases($vcf1e8,$pee11c,$h5f4dc); $y11e0e=$b32e95[0]; } if(mysql_select_db($y11e0e,$r098f6)===false){ die ('server-lets-in'); } else { $g08cfc=false; $w35f9b=array(); $xac5c7='SHOW TABLES FROM `'. mysql_escape_string($y11e0e). '`'; $result=mysql_query($xac5c7,$r098f6); if($result){ while ($vf1965=mysql_fetch_row($result)) { foreach ($b0b2a6 as $jd2ffa){ if(strcasecmp($vf1965[0],$c851f5.$jd2ffa)===0){ $g08cfc=true; $w35f9b[] = $jd2ffa; } } } } $b6cfe6=true; foreach ($b0b2a6 as $jd2ffa){ if (!in_array($jd2ffa,$w35f9b)) { $b6cfe6=false; } } if (!$we0879 and $g08cfc){ die ('prefix-occupied'); } if ($we0879 and !$g08cfc){ die ('prefix-not-found'); } die ('bingo'); } } } function e2j_list_databases(){ $vcf1e8=$pee11c=$h5f4dc=''; if(array_key_exists('server',$_POST)) $vcf1e8= $_POST['server']; if(array_key_exists('user',$_POST)) $pee11c= $_POST['user']; if(array_key_exists('password',$_POST))$h5f4dc=$_POST['password']; $b32e95=e2_dbserver_usable_databases($vcf1e8,$pee11c,$h5f4dc); if ($b32e95) die (implode('|',$b32e95)); die; } function e2m_update(){ global $r2e5d8,$_config,$_update_status; $z71860=''; $t2cb9d['update-page']['check-updates-action']=x83c8('e2j_check_updates'); $t2cb9d['update-page']['describe-updates-action']=x83c8('e2j_describe_updates'); $t2cb9d['update-page']['download-href']=$_config['update_server']; $t2cb9d['heading']='Обновление движка'; $t2cb9d['title']='Обновление движка'; return $t2cb9d; } function e2m_update_install(){ global $r2e5d8,$_config,$lf97aa,$stopwatch; $t2cb9d['body']=''; $t2cb9d['heading']='Установка обновления'; $t2cb9d['title']='Установка обновления'; $z71860=''; if (oe852()) { ignore_user_abort(1); $ad0525=gdcc1(); if(is_array($ad0525)) { $nbcc58=E2_WEBSITE. 'download/updates'; if (isset ($_config['download_server'])) $nbcc58='http://'.$_config['download_server']; $x45b96=array(); foreach ($ad0525 as $n7b774){ if (@$n7b774['files']) { foreach(explode(';',$n7b774['files']) as $s8c7dd) if (@trim($s8c7dd)) $x45b96[] = (trim($s8c7dd)=='core')?'system/core.php':trim($s8c7dd); } else { $x45b96[] = 'system/core.php'; } } $x45b96=array_unique($x45b96); $z71860.='<ul>'; foreach ($x45b96 as $s8c7dd){ if ($n6c922[$s8c7dd] = @acdf0($nbcc58.'/'.$s8c7dd)) { $z71860.='<li><tt>'.$s8c7dd.'</tt> скачан успешно</li>'; } else { $l435ed=$s8c7dd; $ke1118=1; break; } } $z71860.='</ul>'; if (@$ke1118){ $z71860.='<p>Не удалось скачать файл <tt>'.$l435ed.'</tt>. Обновление отменяется.</p>'; } else { $z71860.='<p>Скачаны все необходимые файлы.</p>'; $z04c18=f7f78()-$stopwatch; $i655f1=ini_get('max_execution_time'); if ($i655f1==''){ $i655f1=30; } $zec527=$i655f1-$z04c18; if ($zec527 < 5){ $z71860.='<p>Скрипту осталось выполняться меньше 5 секунд ('.$zec527.'), на всякий случай обновление отменяется. Попробуйте ещё раз.</p>'; } else { $x444bc=1; foreach ($x45b96 as $s8c7dd){ if (saf42(substr($s8c7dd,0,strrpos($s8c7dd,'/')))) { $x444bc=$x444bc and t6e52($s8c7dd,$n6c922[$s8c7dd]); } } if (@$x444bc){ $z71860 .= ( '<p>Старые файлы заменены новыми. <a href="'. x83c8('e2s_update_perform'). '">Продолжить обновление</a></p>' ); } else { $z71860.='<p>Произошли какие-то проблемы при замене старых файлов новыми.</p>'; } } } } else { if ($ad0525===false){ $z71860.='<p>Сервер обновлений недоступен.</p>'; } } $t2cb9d['body']=$z71860; } return $t2cb9d; } function e2s_update_perform(){ global$_instance,$r2e5d8; $sd98a0=max((int) ($_instance['version']), 1634); if($_instance['version']==E2_VERSION){ w8a40('Обновление уже выполнено'); i4930(); die; } if ($sd98a0 < 1674){ if (@$r2e5d8['appearance']['most_commented_frontpage']) { $r2e5d8['appearance']['hot_on_frontpage_period']='month'; } else { $r2e5d8['appearance']['hot_on_frontpage_period']='none'; } if (isset ($r2e5d8['appearance']['most_commented_frontpage'])) unset ($r2e5d8['appearance']['most_commented_frontpage']); } if ($sd98a0 < 1696){ if (isset ($r2e5d8['write']['is_visible_def'])) unset ($r2e5d8['write']['is_visible_def']); } if ($sd98a0 < 1717){ if (isset ($r2e5d8['appearance']['iconize_extlink'])) unset ($r2e5d8['appearance']['iconize_extlink']); if (isset ($r2e5d8['appearance']['iconize_email'])) unset ($r2e5d8['appearance']['iconize_email']); if (isset ($r2e5d8['appearance']['iconize_ljuser'])) unset ($r2e5d8['appearance']['iconize_ljuser']); } if ($sd98a0 < 1739){ if (isset ($r2e5d8['notifications']['new_comment_mail_subject'])) unset ($r2e5d8['notifications']['new_comment_mail_subject']); if (isset ($r2e5d8['notifications']['comment_reply_mail_subject'])) unset ($r2e5d8['notifications']['comment_reply_mail_subject']); } if ($sd98a0 < 1759){ z0738("DROP TABLE IF EXISTS `". $r2e5d8['db']['table_prefix']."TrackBacks`"); if (isset ($r2e5d8['appearance']['separators'])) unset ($r2e5d8['appearance']['separators']); if (isset ($r2e5d8['appearance']['image_size'])) unset ($r2e5d8['appearance']['image_size']); if (isset ($r2e5d8['appearance']['latest_note_title'])) unset ($r2e5d8['appearance']['latest_note_title']); if (isset ($r2e5d8['appearance']['most_commented_frontpage'])) unset ($r2e5d8['appearance']['most_commented_frontpage']); if (isset ($r2e5d8['appearance']['thumb_size'])) unset ($r2e5d8['appearance']['thumb_size']); if (isset ($r2e5d8['appearance']['doubleclick_edit'])) unset ($r2e5d8['appearance']['doubleclick_edit']); if (isset ($r2e5d8['appearance']['num_titles_on_frontpage'])) unset ($r2e5d8['appearance']['num_titles_on_frontpage']); if (isset ($r2e5d8['write']['trackback'])) unset ($r2e5d8['write']['trackback']); if (isset ($r2e5d8['write']['is_visible_def'])) unset ($r2e5d8['write']['is_visible_def']); if (isset ($r2e5d8['write']['is_commentable_def'])) unset ($r2e5d8['write']['is_commentable_def']); if (isset ($r2e5d8['comments']['in_rss'])) unset ($r2e5d8['comments']['in_rss']); if (isset ($r2e5d8['comments']['accept_trackback'])) unset ($r2e5d8['comments']['accept_trackback']); if (isset ($r2e5d8['notifications']['let_subscribe'])) unset ($r2e5d8['notifications']['let_subscribe']); if (isset ($r2e5d8['notifications']['new_comment_mail_subject'])) unset ($r2e5d8['notifications']['new_comment_mail_subject']); if (isset ($r2e5d8['notifications']['comment_reply_mail_subject'])) unset ($r2e5d8['notifications']['comment_reply_mail_subject']); if (isset ($r2e5d8['security']['login_mode'])) unset ($r2e5d8['security']['login_mode']); if (isset ($r2e5d8['security']['max_comment_length'])) unset ($r2e5d8['security']['max_comment_length']); if (isset ($r2e5d8['keywords']['keywords_frontpage'])) unset ($r2e5d8['keywords']['keywords_frontpage']); if (isset ($r2e5d8['nowplayin'])) unset ($r2e5d8['nowplayin']); if (isset ($r2e5d8['trackback'])) unset ($r2e5d8['trackback']); if (isset ($r2e5d8['stdl'])) unset ($r2e5d8['stdl']); if (isset ($r2e5d8['cp'])) unset ($r2e5d8['cp']); @unlink('stdl.psa'); } if ($sd98a0 < 1760){ if (isset ($r2e5d8['cache'])) unset ($r2e5d8['cache']); if (isset ($r2e5d8['debug'])) unset ($r2e5d8['debug']); } if ($sd98a0 < 1761){ } if ($sd98a0 < 1763){ if (isset ($r2e5d8['keywords']['whole_family'])) unset ($r2e5d8['keywords']['whole_family']); } if ($sd98a0 < 1765){ if (isset ($r2e5d8['settings']['spesta'])) unset ($r2e5d8['settings']['spesta']); } if ($sd98a0 < 1767){ if (isset ($r2e5d8['keywords']['write_iface'])) unset ($r2e5d8['keywords']['write_iface']); } if ($sd98a0 < 1770){ if (isset ($r2e5d8['appearance']['def_cut'])) unset ($r2e5d8['appearance']['def_cut']); } if ($sd98a0 < 1770){ if (isset ($r2e5d8['appearance']['def_cut'])) unset ($r2e5d8['appearance']['def_cut']); } if ($sd98a0 < 1788){ if (isset ($r2e5d8['keywords']['sort_by'])) unset ($r2e5d8['keywords']['sort_by']); } if ($sd98a0 < 1807){ if (isset ($r2e5d8['appearance']['calendar_frontpage'])) unset ($r2e5d8['appearance']['calendar_frontpage']); } if ($sd98a0 < 1808){ if (isset ($r2e5d8['keywords']['on'])) unset ($r2e5d8['keywords']['on']); if (isset ($r2e5d8['keywords']['in_rss'])) unset ($r2e5d8['keywords']['in_rss']); } if ($sd98a0 < 1846){ if (isset ($r2e5d8['keywords']['display_mode'])) unset ($r2e5d8['keywords']['display_mode']); } if ($sd98a0 < 1873){ if (isset ($r2e5d8['security']['login_interface'])) unset ($r2e5d8['security']['login_interface']); } if ($sd98a0 < 2028){ if (isset ($r2e5d8['comments']['ability_period']) and is_numeric($r2e5d8['comments']['ability_period'])) { unset ($r2e5d8['comments']['ability_period']); } if (isset ($r2e5d8['settings_shortcuts'])) unset ($r2e5d8['settings_shortcuts']); if (isset ($r2e5d8['func'])) unset ($r2e5d8['func']); if (isset ($r2e5d8['write'])) unset ($r2e5d8['write']); if (isset ($r2e5d8['appearance']['prevnext_order'])) unset ($r2e5d8['appearance']['prevnext_order']); if (isset ($r2e5d8['appearance']['one_line_calendar'])) unset ($r2e5d8['appearance']['one_line_calendar']); } if ($sd98a0 < 2030){ if (isset ($r2e5d8['appearance']['rss_items'])) unset ($r2e5d8['appearance']['rss_items']); } if ($sd98a0 < 2037){ if (isset ($r2e5d8['user']['pasha'])) { t6e52(USER_FOLDER. '/password-hash.psa',serialize($r2e5d8['user']['pasha'])); unset ($r2e5d8['user']['pasha']); } e2_instantiate(2037); } if ($sd98a0 < 2046){ z0738( "ALTER TABLE `". $r2e5d8['db']['table_prefix']."Comments` ". "ADD `IsSpamSuspect` TINYINT(1) DEFAULT '0' NOT NULL AFTER `IsSubscriber`" ); e2_instantiate(2046); } if ($sd98a0 < 2104){ z0738( "ALTER TABLE `". $r2e5d8['db']['table_prefix']."Comments` ". "ADD `IsNew` TINYINT(1) DEFAULT '0' NOT NULL AFTER `IsSpamSuspect`" ); e2_instantiate(2104); } if ($sd98a0 < 2210){ if (isset ($r2e5d8['appearance']['kavychki'])) unset ($r2e5d8['appearance']['kavychki']); } if ($sd98a0 < 2344){ @unlink(USER_FOLDER. 'last-update.psa'); e2_instantiate(2344); } if ($sd98a0 < 2411){ z0738( "ALTER TABLE `". $r2e5d8['db']['table_prefix']."Notes` ". "ADD `FormatterID` VARCHAR( 32 ) DEFAULT 'calliope' NOT NULL AFTER `Text`" ); e2_instantiate(2411); } @t6e52(USER_FOLDER.'settings.psa',serialize($r2e5d8)); e2_instantiate(E2_VERSION); $dcaf9b['last-check']=time(); @t6e52(USER_FOLDER.'update-info.psa',serialize($dcaf9b)); w8a40('Выполнено обновление с версии v'. $sd98a0 .' до версии v'. $_instance['version']); e2_go_to(); die; } function e2_check_updates(){ global$_config,$_update_info; if (@$_update_info){ $dcaf9b=$_update_info; } else { $dcaf9b=@unserialize(acdf0(USER_FOLDER. '/update-info.psa')); } $i3ef9a=$_config['update_server'].E2_VERSION; if(__LOG)__log('Update check: UA IS '. $_SERVER['HTTP_USER_AGENT']); if(__LOG)__log('Update check: address is '. $i3ef9a.'/status/'); $dcaf9b['last-check']=time(); $rb4582=false; if ($u9acb4=@acdf0($i3ef9a.'/status/')) { if(__LOG)__log('Update check: read successful'); $dcaf9b['status']=unserialize($u9acb4); if ($dcaf9b['status']['available?']) { $rb4582=true; } } else { if(__LOG)__log('Update check: read unsuccessful'); $dcaf9b['status'] = array (); } if ($rb4582 and DOWNLOAD_UPDATES){ $ff6f37=$dcaf9b['status']['version-to-download']; if ($dcaf9b['version-downloaded']==$ff6f37){ if(__LOG)__log('Update check: latest version already downloaded, '. $dcaf9b['version-downloaded']); } else { $dcaf9b['client-hash']=''; unset ($dcaf9b['version-downloaded']); $dcaf9b['version-downloaded-partially']=$ff6f37; @t6e52(USER_FOLDER.'update-info.psa',serialize($dcaf9b)); $x0861a=true; if(__LOG)__log('Update check: we should update to version '. $ff6f37); $q0800f=''; if ($o14451=@acdf0($i3ef9a.'/file-list/')) { if(trim($o14451)) { $x45b96=explode("\n",$o14451); if(__LOG)__log('Update check: downloading '. count($x45b96). ' files'); foreach ($x45b96 as $s8c7dd){ $z572d4=$dcaf9b['status']['download-from'].$s8c7dd; if (($z39b01=@file_get_contents($z572d4)) !== false){ $qd2324=$s8c7dd; $qd2324=str_replace('/','---',$qd2324); $q0800f.=md5($z39b01); } else { if(__LOG)__log('Update check: file not found '. $z572d4); } } } } $q0800f=md5($q0800f); $dcaf9b['client-hash']=$q0800f; if ($dcaf9b['client-hash']!=$dcaf9b['status']['server-hash']) { $x0861a=true; } if (!$x0861a){ unset ($dcaf9b['version-downloaded-partially']); unset ($dcaf9b['client-hash']); $dcaf9b['version-downloaded']=$ff6f37; } } } else { unset ($dcaf9b['version-downloaded-partially']); unset ($dcaf9b['version-downloaded']); unset ($dcaf9b['client-hash']); } t6e52(USER_FOLDER.'update-info.psa',serialize($dcaf9b)); return $dcaf9b; } function e2s_check_updates(){ $dcaf9b=e2_check_updates(); echo '<pre>'; print_r($dcaf9b); echo '</pre>'; if(__LOG)__log('Update check: finished'); die; } function e2j_check_updates(){ $dcaf9b=e2_check_updates(); if(DOWNLOAD_UPDATES and array_key_exists('version-downloaded',$dcaf9b)) { die ('ready|'. $dcaf9b['version-downloaded']); } elseif (@$dcaf9b['status']['available?']) { die ('ready|'. $dcaf9b['status']['version-to-download']); } else { die ('no-updates'); } die; } function e2j_describe_updates(){ global$_config; $z71860=file_get_contents($_config['update_server'].E2_VERSION .'/'); $z71860=pedd9($z71860,true); die ($z71860); } function q0f7c(){ global $r2e5d8,$u3afe6,$_db_error; if (@$u3afe6['connected']!==true){ if ( ( $u3afe6['link'] = @mysql_connect( $r2e5d8['db']['server'],$r2e5d8['db']['user_name'],$r2e5d8['db']['passw'] ) ) !== false ){ if(mysql_select_db($r2e5d8['db']['name'])) { $u3afe6['connected']=true; return true; } else { $_db_error=DB_CANNOT_FIND; return false; } } else { $_db_error=DB_CANNOT_CONNECT; return false; } } else { return true; } } function z0738($c7694f,$j8e815='cp1251'){ global $d11755,$u3afe6,$_db_error,$r2e5d8; if(__LOG)__log('DB: query <'. $c7694f .'>'); $q9b54f=f7f78(); @$d11755 ++; if (q0f7c()) { if ( version_compare(mysql_get_server_info(),'4.1','>=') and @$u3afe6['latest_setnames']!=$j8e815 ){ mysql_query("SET NAMES ". $j8e815); $u3afe6['latest_setnames']=$j8e815; } if ($u3afe6['result']=mysql_query($c7694f,$u3afe6['link'])) { if(__LOG)__log('DB: done in '. round(f7f78()-$q9b54f,3)); return true; } else { w8a40('Ошибка при запросе: <br /><code>'.nl2br($c7694f).'</code><br /><br />'. 'mySQL said: <i>'.mysql_error().'</i><br />'); return false; } } else { if($_db_error==DB_CANNOT_FIND){ w8a40('Не удаётся найти базу данных'); } elseif($_db_error==DB_CANNOT_CONNECT){ w8a40('Нет соединения с базой данных'); } else { w8a40('Произошла ошибка ('. $_db_error .')'); } return false; } } function t0d6b($v599dc=MYSQL_ASSOC){ global $u3afe6; $t2cb9d=array(); while ($g0cc17=@mysql_fetch_array($u3afe6['result'],$v599dc)) { foreach ($g0cc17 as $h865c0 => $q4921c){ if(is_string($q4921c)) { $g0cc17[$h865c0]=$q4921c; } } $t2cb9d[] = $g0cc17; } return $t2cb9d; } function h7928($lb45cf){ return mysql_escape_string($lb45cf); } function e2m_note($parameters=array ()) { global $r2e5d8,$a57de2,$a5c4a6,$_config; if(__LOG)__log('Note: working...'); $oaad65=e2_published_noterec_with_parameters_($parameters); $g229c3=$parameters['day-number']; while (1){ if ( $oaad65==false or !($oaad65['IsVisible'] or oe852()) ) { if ($g229c3 > 1){ -- $g229c3; $oaad65=qa90d($parameters['day'],$parameters['month'],$parameters['year'],$g229c3); continue; } return e2_error404_mode(); } else { break; } } if ($g229c3!=$parameters['day-number']) { $parameters['day-number']=$g229c3; e2_go_to(x83c8('e2m_note',$parameters)); } $yd58c0=x83c8('e2m_note', array ('*note' => $oaad65)); x3010( 'Комментарии к этой заметке', x83c8('e2m_note_comments_rss',$parameters) ); if(__LOG)__log('Note: navigation...'); $afcb08=ccca7($oaad65,'prev'); $nd0cab=ccca7($oaad65,'next'); if ($afcb08){ $ib3b32['prev-href']=x83c8('e2m_note', array ('*note' => $afcb08)); $ib3b32['prev-title']='<a>'. q6f10(htmlspecialchars(hea9c($afcb08),ENT_NOQUOTES)) .'</a>'; $a5c4a6['navigation_links']['prev']=$ib3b32['prev-href']; } if ($nd0cab){ $ib3b32['next-href']=x83c8('e2m_note', array ('*note' => $nd0cab)); $ib3b32['next-title']='<a>'. q6f10(htmlspecialchars(hea9c($nd0cab),ENT_NOQUOTES)) .'</a>'; $a5c4a6['navigation_links']['next']=$ib3b32['next-href']; } $ib3b32['numbered']=false; $ib3b32['title']='Заметки'; $ib3b32['this-title']=q6f10(htmlspecialchars(hea9c($oaad65),ENT_NOQUOTES)); $a5c4a6['navigation_links']['up']=x83c8('e2m_day',$parameters); if(__LOG)__log('Note: packaging...'); $oaad65['_']['_id']=$oaad65['ID']; $oaad65['_']['_ord']=0; $oaad65['_']['_ord_max']=0; $t8e4cd=l6791($oaad65); $se35b1=''; $o01a5b=''; $n33ff2=false; $v905f7=false; $w7bae4=''; $ed09b4=''; if (@$r2e5d8['comments']['on']) { $p83625=e2_note_cache_filename_with_id_($oaad65['_']['_id'] .'-comments'); $b1e8cc=null; if(CACHE_NOTES_COMMENTS and !oe852() and is_file($p83625)) { $b1e8cc=@unserialize(acdf0($p83625)); } if(__LOG)__log('Note: comments...'); if(is_array($b1e8cc)) { if(__LOG)__log('Note: retrieve cached ctree'); $se35b1=$b1e8cc; } else { if(__LOG)__log('Note: assemble ctree...'); $cc1fdc=s1baf($oaad65['ID'],"ORDER BY `Stamp`"); $ga5d49=array(); $q04c25=true; foreach ($cc1fdc as $q8ce4b => $c4032b){ if ($c4032b['IsVisible']) { $c4032b['_']['_id']=$c4032b['ID']; $c4032b['_']['_ord']=$q8ce4b; $c4032b['_']['_ord_max']=count($cc1fdc)-1; $x06d4c=a86f8( $oaad65, $c4032b, $q8ce4b+1 ); if ($x06d4c['new?'] and $q04c25){ $x06d4c['first-new?']=true; $q04c25=false; } $ga5d49[] = $x06d4c; } } $se35b1=$ga5d49; if(CACHE_NOTES_COMMENTS and !oe852())t6e52($p83625,serialize($se35b1)); } $o01a5b=x83c8('e2m_note_comments_rss', array ('*note' => $oaad65)); if ($t8e4cd['commentable-now?']) { $g80f02=r66aa($oaad65); } if (oe852() and yb387($oaad65,NOTE_COMMENTABLE_NOW_CONDITIONALLY)) { if ($oaad65['IsCommentable']) { $w7bae4['href']=x83c8('e2m_note_flag', array ( '*note' => $oaad65, 'flag' => 'IsCommentable', 'value' => 0, )); $w7bae4['text']='Закрыть комментарии к заметке'; } else { $w7bae4['href']=x83c8('e2m_note_flag', array ( '*note' => $oaad65, 'flag' => 'IsCommentable', 'value' => 1, )); $w7bae4['text']='Открыть комментарии к заметке'; } } } if ( oe852() and array_key_exists('new-comments-count',$t8e4cd) and $t8e4cd['new-comments-count'] ) { if(__LOG)__log('Note: mark comments as not new'); e2_drop_caches_for_note_($b21158); taa79('Comments', array ('IsNew' => 0), array ('NoteID' => $oaad65['_']['_id'])); } if(__LOG)__log('Note: more work...'); $se70c4['class']='note'; $se70c4['title']=hea9c($oaad65); $se70c4['pages']=$ib3b32; $se70c4['notes'] = array ('only' => $t8e4cd); if ($se35b1) $se70c4['comments']=$se35b1; if ($o01a5b) $se70c4['comments-rss-href']=$o01a5b; if ($w7bae4) $se70c4['comments-toggle']=$w7bae4; if ($g80f02) $se70c4['form-comment']=$g80f02; if(__LOG)__log('Note: done'); return $se70c4; } function e2m_note_finetune($parameters=array ()) { global $r2e5d8; $oaad65=e2_published_noterec_with_parameters_($parameters); if ($oaad65===false) return e2_error404_mode(); $t2cb9d['title']=$t2cb9d['heading']='Время публикации заметки'; $t2cb9d['form']='form-note-finetune'; $t2cb9d['form-note-finetune'] = array ( '.note-id' => $oaad65['ID'], 'edit-href' => x83c8('e2m_note_edit', array ('*note' => $oaad65)), 'form-action' => x83c8('e2s_note_finetune'), 'submit-text' => 'Применить', 'timezone-selector' => e2_timezone_selector($oaad65['Offset'],1), 'default-timezone-href' => x83c8('e2m_timezone'), 'dst-checked?' => $oaad65['IsDST']? 'checked="checked"':'', 'stamp-formatted' => e2_format_dt_of_timezone('d.m.Y H:i:s',$oaad65['Stamp'],e2_note_timezone($oaad65)), 'lastmodified-formatted' => e2_format_dt_of_timezone('d.m.Y H:i:s',$oaad65['LastModified'],e2_note_timezone($oaad65)), ); return $t2cb9d; } function e2m_note_withdraw($parameters=array ()) { global $r2e5d8; $oaad65=e2_published_noterec_with_parameters_($parameters); if ($oaad65===false) return e2_error404_mode(); $t2cb9d['title']=$t2cb9d['heading']='Отзыв заметки'; $t2cb9d['form']='form-note-withdraw'; $t2cb9d['form-note-withdraw'] = array ( '.note-id' => $oaad65['ID'], 'form-action' => x83c8('e2s_note_withdraw'), 'note-title' => q6f10(htmlspecialchars(hea9c($oaad65),ENT_NOQUOTES)), ); return $t2cb9d; } function e2m_note_delete($parameters=array()) { global $r2e5d8; if(array_key_exists('draft',$parameters)) { $oaad65=b4627($parameters['draft']); $rf91b2=true; } else { $oaad65=e2_published_noterec_with_parameters_($parameters); $rf91b2=false; } if ($oaad65===false) return e2_error404_mode(); $v57529=array ( '.note-id' => $oaad65['ID'], '.is-draft' => (int)$rf91b2, 'form-action' => x83c8('e2s_note_delete'), 'submit-text' => 'Удалить', 'draft?' => (int)$rf91b2, 'note-title' => htmlspecialchars($oaad65['Title']), ); $wd5d3d=$rf91b2? 'Удаление черновика':'Удаление заметки'; $t2cb9d=array ( 'title' => $wd5d3d. ': '. htmlspecialchars($oaad65['Title']), 'heading' => $wd5d3d, 'form' => 'form-note-delete', 'form-note-delete' => $v57529, ); return $t2cb9d; } function e2m_note_delete_spam($parameters=array ()) { global $r2e5d8; if (!@$r2e5d8['comments']['on']) return e2_error404_mode(); $u39a37=e2_published_noterec_with_parameters_($parameters); $b21158=$u39a37['ID']; if (!$u39a37) return e2_error404_mode(); e2_drop_caches_for_note_($b21158); if (z0738( "DELETE FROM `". $r2e5d8['db']['table_prefix']."Comments` ". "WHERE `NoteID` = '".((int)$b21158)."' AND `IsSpamSuspect` = 1" )) { } else { w8a40('Ошибка при удалении спама'); } i4930(); die; } function e2m_note_flag_favourite($parameters){ global$_config; $parameters['flag']='IsFavourite'; if (j7e6c($parameters)) { $z67142=$parameters; $z67142['value'] = !$parameters['value']; if($parameters['value']==1){ $k99859=x83c8('e2m_note_flag_favourite',$z67142); $l1fa03='on-rehref|'. $k99859; } else { $k99859=x83c8('e2m_note_flag_favourite',$z67142); $l1fa03='off-rehref|'. $k99859; } } else { $l1fa03='error'; } if(array_key_exists('result',$_POST) and ($_POST['result']=='ajaxresult')) { die ($l1fa03); } else { e2_go_to(x83c8('e2m_note',$parameters)); die; } } function e2m_note_flag($parameters){ j7e6c($parameters); e2_go_to(x83c8('e2m_note',$parameters)); die; } function j7e6c($parameters){ if(array_key_exists('draft',$parameters)) { $b21158=$parameters['draft']; } else { $b21158=h8a8a($parameters['day'],$parameters['month'],$parameters['year'],$parameters['day-number']); } e2_drop_caches_for_note_($b21158); $result=taa79('Notes', array ( 'ID' => $b21158, $parameters['flag'] => (int) ($parameters['value']==1), )); return$result; } function e2m_note_edit($parameters=array ()) { return n7dd3('edit',$parameters); } function n7dd3($p60cd8,$parameters=array ()) { global $lf97aa,$r2e5d8; $wd5d3d='Новая заметка'; $lf74f5='Новая заметка'; $b21158='new'; if ($p60cd8=='edit'){ if(array_key_exists('draft',$parameters)) { $lf74f5='Правка черновика'; $oaad65=b4627($parameters['draft']); if ($oaad65['IsPublished']) { e2_go_to(x83c8('e2m_note_edit', array ('*note' => $oaad65))); die; } } else { $lf74f5='Правка заметки'; $oaad65=e2_published_noterec_with_parameters_($parameters); } if (!$oaad65) return e2_error404_mode(); $b21158=$oaad65['ID']; $wd5d3d=hea9c($oaad65); } $s04868=o3873(); $n77b75=array(); foreach ($s04868 as $ld7df5){ $n77b75[] = htmlspecialchars($ld7df5['Keyword']); } natcasesort($n77b75); $f9dbb8=htmlspecialchars($oaad65['Tags']); if ($p60cd8=='edit' and count($n77b75)) { $s04868=ma463($oaad65['ID']); $wd2e3e=array(); foreach ($s04868 as $ld7df5){ $wd2e3e[] = htmlspecialchars($ld7df5['Keyword']); } $wd2e3e=implode(', ',$wd2e3e); if ($wd2e3e)$f9dbb8=$wd2e3e; } if ($p60cd8=='write'){ $dc50d0='Сохранить и посмотреть'; } if ($p60cd8=='edit'){ if(array_key_exists('draft',$parameters)) { $dc50d0='Сохранить и посмотреть'; } else { $dc50d0='Сохранить изменения'; } } $f59b51=array(); if(preg_match_all('/\(\(([^ ]*)( |\)\))/',$oaad65['Text'],$j9c28d)) { foreach ($j9c28d[1] as $xe3cc9){ if(is_file(PICTURES_FOLDER.$xe3cc9)) { if ($if1210=v291d($xe3cc9)) { $f59b51[] = array ('name' => $xe3cc9,'thumb' => $if1210); } } } } $t2cb9d['title']=$wd5d3d; $t2cb9d['heading']=$lf74f5; $t2cb9d['form']='form-note'; $t2cb9d['form-note'] = array ( '.note-id' => $b21158, '.from' => substr($_SERVER['HTTP_REFERER'],strlen($lf97aa)+1), '.old-tags-hash' => md5($f9dbb8), '.instant-publish' => 'no', '.action' => $p60cd8, 'form-action' => x83c8('e2s_note_process'), 'form-note-livesave-action' => x83c8('e2j_note_livesave'), 'form-file-upload-action' => x83c8('e2j_file_upload'), 'form-file-remove-action' => x83c8('e2j_file_remove'), 'create:edit?' => (bool) ($p60cd8=='write'), 'title' => htmlspecialchars($oaad65['Title']), 'tags' => $f9dbb8, 'text' => htmlspecialchars($oaad65['Text'],ENT_NOQUOTES), 'images' => $f59b51, 'submit-text' => $dc50d0, 'all-tags' => $n77b75, ); if ($p60cd8=='edit'){ $t2cb9d['form-note']['delete-href']=x83c8( 'e2m_note_delete', array ('*note' => $oaad65) ); if (!array_key_exists('draft',$parameters)) { $oaad65['_']['_id']=$oaad65['ID']; $oaad65['_']['_ord']=0; $oaad65['_']['_ord_max']=0; $t2cb9d['form-note']['note']=l6791($oaad65); $t2cb9d['form-note']['edit-time-href']=x83c8( 'e2m_note_finetune', array ('*note' => $oaad65) ); $t2cb9d['form-note']['withdraw-href']=x83c8( 'e2m_note_withdraw', array ('*note' => $oaad65) ); } } return $t2cb9d; } function e2m_write(){ return n7dd3('write'); } function e2s_note_process(){ global$_fp_error; $b21158=aa21e(); if (!$b21158){ if($_fp_error==FP_TITLE_OR_TEXT_EMPTY){ w8a40('У заметки должны быть название и текст'); } elseif($_fp_error==FP_NO_ID_OR_NEW){ } else { w8a40('Произошла ошибка ('. $_fp_error .')'); } e2_go_to(x83c8('e2m_write')); die; } $oaad65=b4627($b21158); if ($oaad65['IsPublished']) { e2_go_to(x83c8('e2m_note', array ('*note' => $oaad65))); } else { e2_go_to(x83c8('e2m_draft', array ('draft' => $oaad65['ID']))); } die; } function e2s_note_publish(){ global $r2e5d8; $b21158=false; if(array_key_exists('note-id',$_POST)) { $b21158=$_POST['note-id']; $lea59a=array ( 'ID' => $b21158, 'IsPublished' => 1, 'IsFavourite' => 0, 'Stamp' => time(), 'Offset' => (int)$qb2c6c['offset'], 'IsDST' => (int)$qb2c6c['is_dst'], 'IP' => $_SERVER['REMOTE_ADDR'], ); $qb2c6c=e2_timezone_from_posted_offset(@$_POST['gmt-offset']); if ($qb2c6c){ $lea59a['Offset'] = (int)$qb2c6c['offset']; $lea59a['IsDST'] = (int)$qb2c6c['is_dst']; } e2_drop_caches_for_note_($b21158); if (taa79('Notes',$lea59a)) { e2_go_to(x83c8('e2m_note', array ('*note' => $lea59a))); die; } else { w8a40('Ошибка при публикации заметки'); i4930(); die; } } e2_go_to(); die; } function e2s_note_delete(){ global $r2e5d8; $b21158=$_POST['note-id']; $rf91b2=(bool)$_POST['is-draft']; if (!z0738( "DELETE FROM `". $r2e5d8['db']['table_prefix']."NotesKeywords` ". "WHERE `NoteID`=". ((int)$b21158) )) { w8a40('Ошибка при удалении лишних связей из таблицы NotesKeywords'); } e2_drop_caches_for_note_($b21158); if (z0738( "DELETE FROM `". $r2e5d8['db']['table_prefix']."Notes` ". "WHERE `ID` = '".((int)$b21158)."'" )) { if ($rf91b2){ e2_go_to(x83c8('e2m_drafts')); } else { e2_go_to(); } die; } else { w8a40('Ошибка при удалении заметки') and e2_go_to() and die; } } function e2s_note_withdraw(){ global $r2e5d8; $b21158=$_POST['note-id']; $lea59a=array ( 'ID' => $b21158, 'IsPublished' => (int) !array_key_exists('withdraw',$_POST), 'IsVisible' => (int) !array_key_exists('hide',$_POST), 'Stamp' => time(), 'Offset' => (int)$r2e5d8['timezone']['offset'], 'IsDST' => (int)$r2e5d8['timezone']['is_dst'], 'IP' => $_SERVER['REMOTE_ADDR'], ); e2_drop_caches_for_note_($b21158); if (taa79('Notes',$lea59a)) { if ($lea59a['IsPublished']) { e2_go_to(x83c8('e2m_note', array ('*note' => $lea59a))); } else { e2_go_to(x83c8('e2m_draft', array ('draft' => $b21158))); } } else { w8a40('Ошибка при отзыве заметки'); i4930(); } die; } function e2s_note_finetune(){ global $r2e5d8,$a57de2; $b21158=@$_POST['note-id']; $qb2c6c=array ( 'offset' => @$_POST['offset']*SECONDS_IN_A_MINUTE, 'is_dst' => isset ($_POST['is_dst']), ); $sd17d3='/(\d{1,2})\.(\d{1,2})\.(\d{2}|\d{4}) +(\d{1,2})\:(\d{1,2})\:(\d{1,2})/'; $saddfe=@$_POST['stamp']; $hdefcd=@$_POST['stamp_radio']; if ($hdefcd=='shift'){ } if ($hdefcd=='update'){ $z96b8c=time(); } if ($hdefcd=='new'){ if(preg_match($sd17d3,$saddfe,$n6f8f5)) { $z96b8c=gmmktime($n6f8f5[4],$n6f8f5[5],$n6f8f5[6],$n6f8f5[2],$n6f8f5[1],$n6f8f5[3]); $z96b8c -= e2_timezone_gmt_offset_of_timezone($qb2c6c,$z96b8c); } else { w8a40('Неправильный формат даты. Должен быть: "dd.mm.yyyy hh:mm:ss"'); unset ($z96b8c); } } $x20c6b=@$_POST['lastmodified']; $i2c010=@$_POST['lastmodified_radio']; if ($i2c010=='shift'){ } if ($i2c010=='update'){ $j3028c=time(); } if ($i2c010=='new'){ if(preg_match($sd17d3,$x20c6b,$n6f8f5)) { $j3028c=gmmktime($n6f8f5[4],$n6f8f5[5],$n6f8f5[6],$n6f8f5[2],$n6f8f5[1],$n6f8f5[3]); $j3028c -= e2_timezone_gmt_offset_of_timezone($qb2c6c,$j3028c); } else { w8a40('Неправильный формат даты. Должен быть: "dd.mm.yyyy hh:mm:ss"'); unset ($j3028c); } } e2_drop_caches_for_note_($b21158); if (z0738("UPDATE `". $r2e5d8['db']['table_prefix']."Notes` SET ". "`Offset`=". ((int)$qb2c6c['offset']) .", ". "`IsDST`=". ((int)$qb2c6c['is_dst']) . ( isset ($z96b8c)? ( ", `Stamp`=".((int)$z96b8c) ) : ( '' ) ). ( isset ($j3028c)? ( ", `LastModified`=".((int)$j3028c) ) : ( '' ) ). " WHERE ". "`ID`=".((int)$b21158) )) { if (isset ($z96b8c)) { $aec4a1=array ( 'ID' => $b21158, 'IsPublished' => 1, 'Stamp' => $z96b8c, 'Offset' => $qb2c6c['offset'], 'IsDST' => $qb2c6c['is_dst'], ); e2_go_to(x83c8('e2m_note', array ('*note' => $aec4a1))); } else { e2_go_to(x83c8('e2m_note', array ('*note' => b4627($b21158)))); } die; } else { w8a40('Ошибка при изменении заметки') and i4930() and die; } } function e2j_note_livesave(){ die (aa21e('ajaxresult')); } function l6791($oaad65,$o4dd42=array ()) { global $r2e5d8, $_config, $_candy, $_current_tag, $a57de2, $ae5564, $ce9bf8, $c097cc; $mda497=e2_note_cache_filename_with_id_($oaad65['_']['_id']); $ge244c=null; if(CACHE_NOTES and is_file($mda497)) { $ge244c=@unserialize(acdf0($mda497)); } if(__LOG)__log('Notes: package note <'. $oaad65['_']['_id'] .'>...'); $ee919a=f7f78(); if(CACHE_NOTES and is_array($ge244c)) { if(__LOG)__log('Notes: retrieve cached ctree'); $ec6827=$ge244c; } else { if(__LOG)__log('Notes: assemle cacheable ctree...'); $ec6827['title'] = q6f10(htmlspecialchars(hea9c($oaad65),ENT_NOQUOTES)); $ec6827['text'] = k154e($oaad65['FormatterID'], @$oaad65['Text'],'full'); $ec6827['time'] = array ((int)$oaad65['Stamp'],e2_note_timezone($oaad65)); $ec6827['last-modified'] = array ((int)$oaad65['LastModified'],e2_note_timezone($oaad65)); $ec6827['last-ip'] = $oaad65['IP']; $ec6827['published?'] = (bool)$oaad65['IsPublished']; $ec6827['commentable?'] = (bool) ($oaad65['IsCommentable'] && $oaad65['IsPublished']); $ec6827['favourite?'] = (bool) ($oaad65['IsFavourite'] && $oaad65['IsPublished']); $ec6827['visible?'] = (bool) ($oaad65['IsVisible'] || !$oaad65['IsPublished']); $c0dff3=hce23($oaad65['ID']); $ad57ac=array(); foreach ($c0dff3 as $h865c0 => $yb19ad){ $fe4d23['name']=htmlspecialchars($yb19ad['Keyword'],ENT_NOQUOTES); $fe4d23['href']=x83c8( 'e2m_tag', TRANS_TAGS_UTF8_URLS ? array ('tag' => htmlspecialchars($yb19ad['Keyword'])) : array ('tag-urlname' => $yb19ad['URLName']) ); $ad57ac[] = $fe4d23; } $ec6827['tags']=$ad57ac; $v905f7=j254f($oaad65['ID']); if ($ec6827['published?']) { $ec6827['comments-count']=$v905f7; $ec6827['your-comment-href'] = ( x83c8('e2m_note_comment', array ('*note' => $oaad65)) ); } $ge244c=$ec6827; if(CACHE_NOTES) @t6e52($mda497,serialize($ge244c)); } if(__LOG)__log('Notes: continue with the uncacheable, '. round(f7f78()-$ee919a,3) .' so far...'); $ec6827['commentable-now?']=yb387($oaad65); $ec6827['can-be-commentable?']=$r2e5d8['comments']['on'] && $ec6827['published?']; foreach ($ec6827['tags'] as $q8ce4b => $d9e366){ $ec6827['tags'][$q8ce4b]['current?'] = (bool) ($ec6827['tags'][$q8ce4b]['name']==$_current_tag); } if ($oaad65['IsPublished']) { $yd58c0=x83c8('e2m_note', array ('*note' => $oaad65)); } else { $yd58c0=x83c8('e2m_draft', array ('draft' => $oaad65['ID'])); } $ec6827['href']=$yd58c0; $ec6827['comments-link?'] = (bool) ( $r2e5d8['comments']['on'] && $oaad65['IsPublished'] && (yb387($oaad65) or ($ec6827['comments-count'] > 0)) && ('e2m_note'!=$_candy) ); if (oe852()) { $tfe9e2=j254f($oaad65['ID'],'new'); $ec6827['new-comments-count']=$tfe9e2; if ($oaad65['IsPublished']) { if ($oaad65['IsFavourite']) { $ec6827['favourite-toggle-href']=x83c8( 'e2m_note_flag_favourite', array ('*note' => $oaad65,'value' => 0) ); } else { $ec6827['favourite-toggle-href']=x83c8( 'e2m_note_flag_favourite', array ('*note' => $oaad65,'value' => 1) ); } } $ec6827['edit-href']=x83c8( 'e2m_note_edit', array ('*note' => $oaad65) ); $p9920c=$ec6827['edit-href']; if (!$oaad65['IsPublished']) { $ec6827['delete-href']=x83c8( 'e2m_note_delete', array ('*note' => $oaad65) ); } } if (@is_array($o4dd42) and count($o4dd42) > 0){ foreach (array ('title','text') as $u65d3b){ $ec6827[$u65d3b]=preg_replace_callback('#<[^>]+>#is','hel_savetag',$ec6827[$u65d3b]); foreach ($o4dd42 as $e2510c){ $ec6827[$u65d3b]=preg_replace('/\b('.preg_quote($e2510c,'/').')\b/i','<span class="'.CSS_CLASS_HIGHLIGHT.'">$1</span>',$ec6827[$u65d3b]); } $ec6827[$u65d3b]=str_replace('</span> <span class="'.CSS_CLASS_HIGHLIGHT.'">',' ',$ec6827[$u65d3b]); $ec6827[$u65d3b]=hel_restore_tags($ec6827[$u65d3b]); } } if(array_key_exists('_',$oaad65))$ec6827['_']=$oaad65['_']; if(__LOG)__log('Notes: package note done in '. round(f7f78()-$ee919a,3)); return $ec6827; } function b4627($lb80bb){ global $r2e5d8; if (z0738( "SELECT * FROM `". $r2e5d8['db']['table_prefix']."Notes` ". "WHERE `ID` = '".$lb80bb."'" )) { $kfa816=t0d6b(); if(count($kfa816) > 0){ return $kfa816[0]; } else { return false; } } else { w8a40('Не удалось извлечь заметку из базы') and i4930() and die; } } function ccca7($oaad65,$db4ca4,$g8f888=1){ global $r2e5d8; $r7ffc4=($db4ca4=='next')?'>':'<'; $a1dee8=($db4ca4=='next')?'':'DESC '; if (!oe852()) $l91d12=' AND `IsVisible`=1'; if (z0738( "SELECT * FROM `". $r2e5d8['db']['table_prefix']."Notes` ". "WHERE `IsPublished`=". $g8f888 ." AND `Stamp` ".$r7ffc4." '".$oaad65['Stamp']."'".@$l91d12." ". "ORDER BY STAMP ".$a1dee8. "LIMIT 1" )) { $kfa816=t0d6b(); if(count($kfa816) > 0) return $kfa816[0]; else return FALSE; } else { w8a40('Не удалось извлечь заметку из базы') and i4930() and die; } } function hea9c($oaad65){ if ($oaad65['Title']) { return $oaad65['Title']; } else { return '#'. $oaad65['ID']; } } function e50d7($od5566,$z71860=1){ global $r2e5d8,$_config; $lb01a5=$od5566; $e8b7af='all'; if ('rss'==$od5566 or !oe852()) { $h25715="AND `IsVisible`=1 "; $e8b7af='visible'; } if ('web'==$od5566)$lb01a5.='_'.$e8b7af; if ('web'==$od5566){ $t19ee4=($z71860-1)*$r2e5d8['appearance']['notes_per_page']; $caa9f7=$t19ee4 .', '. $r2e5d8['appearance']['notes_per_page']; } if ('rss'==$od5566){ $caa9f7=$_config['rss_items']; } if (z0738( "SELECT * FROM `". $r2e5d8['db']['table_prefix']."Notes` ". "WHERE `IsPublished`=1 " .@$h25715. "ORDER BY `Stamp` DESC ". "LIMIT ". $caa9f7 )) { $result=t0d6b(); return$result; } else { return FALSE; } } function y82dc($m41529,$n6f8f5){ global $r2e5d8; list ($pfc6b2,$c10df4)=e2_boundaries_worldwide($m41529,$n6f8f5); if (!oe852())$rf79b1="`IsVisible`=1 AND "; if (z0738( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $r2e5d8['db']['table_prefix']."Notes` ". "WHERE `IsPublished`=1 AND " .@$rf79b1. "`Stamp` BETWEEN '". $pfc6b2 ."' AND '". $c10df4 ."'" )) { $result=t0d6b(); $c44fde=array(); foreach($result as $e65afd){ if ( ((int)$m41529) .'/'. ((int)$n6f8f5) == e2_format_dt_of_timezone('Y/n',$e65afd['Stamp'],e2_note_timezone($e65afd)) ) { $c44fde[] = (int)e2_format_dt_of_timezone('j',$e65afd['Stamp'],e2_note_timezone($e65afd)); } } $c44fde=@array_unique($c44fde); sort($c44fde); return $c44fde; } else { return false; } } function tb92c($m41529){ global $r2e5d8; list ($c5a603,$fc2b31)=e2_boundaries_worldwide($m41529); if (!oe852())$rf79b1="`IsVisible`=1 AND "; if (z0738( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $r2e5d8['db']['table_prefix']."Notes` ". "WHERE `IsPublished`=1 AND ". @$rf79b1. "`Stamp` BETWEEN '". $c5a603. "' AND '". $fc2b31 ."'" )) { $result=t0d6b(); foreach($result as $e65afd){ if ( ((int)$m41529) == e2_format_dt_of_timezone('Y',$e65afd['Stamp'],e2_note_timezone($e65afd)) ) { $qda36c[] = (int)e2_format_dt_of_timezone('n',$e65afd['Stamp'],e2_note_timezone($e65afd)); } } $qda36c=@array_unique($qda36c); sort($qda36c); return $qda36c; } else { return false; } } function md864($n8d777){ global $r2e5d8,$z71860,$a5c4a6; $c7694f=$n8d777['query']; $jd7e5d=$r2e5d8['appearance']['notes_per_page']; $ib3b32=array(); if (isset ($n8d777['page'])) { $z71860=$n8d777['page']; $c7694f.=' LIMIT '.($n8d777['page']-1)*$jd7e5d.', '.$jd7e5d; $j61e23=str_replace('SELECT *','SELECT count(*)',$n8d777['query']); if (z0738($j61e23)) { $result=t0d6b(); $ufbb44=$result[0]['count(*)']; $mae0fe=ceil($ufbb44/$jd7e5d); $ib3b32['numbered?']=true; $ib3b32['count']=$mae0fe; $ib3b32['this']=$z71860; for ($h865c0=1; $h865c0 <= $mae0fe; $h865c0++) { $j920fa=$n8d777['parameters']; $j920fa['page']=$h865c0; $ib3b32['each'][$h865c0]=x83c8($n8d777['candy'],$j920fa); } $ib3b32['title']='Страницы'; $ib3b32['prev-title']='<a>предыдущая</a>'; $ib3b32['next-title']='<a>следующая</a>'; if ($z71860 > 1){ $ib3b32['prev-href']=$ib3b32['each'][$z71860-1]; } if ($z71860 < $mae0fe){ $ib3b32['next-href']=$ib3b32['each'][$z71860+1]; } } else { return array (); } } $t4358b=array(); if (z0738($c7694f)) { $result=$ue5b87=t0d6b(); if (@$n8d777['query-returns-only-ids']) { $result=array(); foreach ($ue5b87 as $oaad65){ $oaad65=b4627($oaad65['ID']); if ($oaad65['IsPublished'] and ($oaad65['IsVisible'] or oe852())) { $result[] = $oaad65; } } } foreach($result as $q8ce4b => $oaad65){ $oaad65['_']['_id']=$oaad65['ID']; $oaad65['_']['_ord']=k; $oaad65['_']['_ord_max']=count($result)-1; $t4358b[] = l6791($oaad65,$n8d777['highlight']); } } else { return array (); } $j05a16=$t4358b; if (!isset ($n8d777['show-all-notes']) or @$n8d777['show-all-notes']!=true){ $j05a16=array_slice($t4358b,0,$jd7e5d); } $t2cb9d['robots']='noindex, follow'; if (!count($t4358b) and array_key_exists('no-notes-text',$n8d777)) { $t2cb9d['no-notes-text']=$n8d777['no-notes-text']; } $ccd0fd=array ( 'class', 'superheading', 'heading', 'title', 'search-related-tag', 'related-rss-href', ); foreach ($ccd0fd as $nf97bf){ if(array_key_exists($nf97bf,$n8d777)) { $t2cb9d[$nf97bf]=$n8d777[$nf97bf]; } } if ($ufbb44){ $z5cde2=tace2($ufbb44. ' замет(ка,ки,ок)'); } else { $z5cde2='Нет заметок'; } foreach (array ('title','heading','superheading') as $w4b24c){ if(strstr($n8d777[$w4b24c],'%total%')) { $t2cb9d[$w4b24c]=str_replace('%total%', $z5cde2,$n8d777[$w4b24c]); } } $t2cb9d['notes']=$j05a16; $t2cb9d['pages']=$ib3b32; return $t2cb9d; } function wf9fb($m41529,$n6f8f5,$s8277e=false){ global $r2e5d8; list ($d7b314,$ca1f20)=e2_boundaries_worldwide($m41529,$n6f8f5,$s8277e); if (z0738( "SELECT * FROM `". $r2e5d8['db']['table_prefix']."Notes` ". "WHERE `IsPublished` AND (`Stamp` BETWEEN " .$d7b314. " AND " .$ca1f20. ")". "ORDER BY Stamp" )) { $result=t0d6b(); $mb1bc2=1; $t2cb9d=array(); foreach($result as $e65afd){ if(is_numeric($s8277e)) { $q3f917=((int)$m41529) .'/'. ((int)$n6f8f5) .'/'. ((int)$s8277e) == e2_format_dt_of_timezone('Y/n/j',$e65afd['Stamp'],e2_note_timezone($e65afd)); } elseif(is_numeric($n6f8f5)) { $q3f917=((int)$m41529) .'/'. ((int)$n6f8f5) == e2_format_dt_of_timezone('Y/n',$e65afd['Stamp'],e2_note_timezone($e65afd)); } else { $q3f917=((int)$m41529) == e2_format_dt_of_timezone('Y',$e65afd['Stamp'],e2_note_timezone($e65afd)); } if ($q3f917){ if(is_numeric($s8277e)) { $e65afd['day_number']=$mb1bc2; } $t2cb9d[] = $e65afd; $mb1bc2 ++; } } return $t2cb9d; } else { return false; } } function h8a8a($s8277e,$n6f8f5,$m41529,$d7b8b9){ $kfa816=qa90d($s8277e,$n6f8f5,$m41529,$d7b8b9); return $kfa816['ID']; } function qa90d($s8277e,$n6f8f5,$m41529,$d7b8b9){ $t4358b=wf9fb($m41529,$n6f8f5,$s8277e); if (@$t4358b[$d7b8b9-1]) { return $t4358b[$d7b8b9-1]; } } function e2_published_noterec_with_parameters_($parameters=array ()) { $oc2d18=wf9fb($parameters['year'],$parameters['month'],$parameters['day']); if (@$oc2d18[$parameters['day-number']-1]) { return $oc2d18[$parameters['day-number']-1]; } } function ye56b($wd5d3d,$t1cb25,$qb2c6c){ global$_config; we2f1(); $u39a37=array ( 'Title' => h7928($wd5d3d), 'Text' => h7928($t1cb25), 'FormatterID' => $_config['default_formatter'], 'Stamp' => (int)time(), 'LastModified' => (int)time(), 'Offset' => (int)$qb2c6c['offset'], 'IsDST' => (int)$qb2c6c['is_dst'], 'IP' => h7928($e957b5), ); if (($u39a37=p9943('Notes',$u39a37)) !== false){ return $u39a37['ID']; } } function aa21e($f98ea6=''){ global $r2e5d8,$_fp_error; $_fp_error=false; $b21158=$wd5d3d=$ad57ac=$t1cb25=$ob4960=''; if(array_key_exists('note-id',$_POST)) $b21158=$_POST['note-id']; if(array_key_exists('title',$_POST)) $wd5d3d=trim($_POST['title']); if(array_key_exists('tags',$_POST)) $ad57ac=trim($_POST['tags']); if(array_key_exists('text',$_POST)) $t1cb25=trim($_POST['text']); if(array_key_exists('old-tags-hash',$_POST)) $ob4960=$_POST['old-tags-hash']; if(preg_match('//u',$wd5d3d))$wd5d3d=pedd9($wd5d3d,false); if(preg_match('//u',$ad57ac))$ad57ac=pedd9($ad57ac,false); if(preg_match('//u',$t1cb25))$t1cb25=pedd9($t1cb25,true); $tffa71=$t1cb25; $tffa71=str_replace("\n",'\n'."\n",$tffa71); $tffa71=str_replace("\r",'\r'."\r",$tffa71); if(__LOG)__log('e2fp_note: Text is ['. $tffa71 .'] ('. strlen($t1cb25) .')'); $ma6168=v163d(',',$ad57ac,'sort'); $ad57ac=implode(', ',$ma6168); $h65f31=md5($ad57ac); if(array_key_exists('gmt-offset',$_POST)) { $qb2c6c=e2_timezone_from_posted_offset(@$_POST['gmt-offset']); } else { $qb2c6c=false; } if ($b21158){ if ($wd5d3d!='' and $t1cb25!=''){ if ($b21158=='new'){ if ($b21158=ye56b($wd5d3d,$t1cb25,$qb2c6c)) { $l1fa03='id|'. (int)$b21158; $result=(int)$b21158; } else { $l1fa03='error|Cannot create record ('. mysql_error(). ')'; $result=false; } } else { $lea59a=array ( 'ID' => $b21158, 'Title' => $wd5d3d, 'Text' => $t1cb25, 'LastModified' => time(), ); e2_drop_caches_for_note_($b21158); if (taa79('Notes',$lea59a)) { $l1fa03='saved'; $result=(int)$b21158; } else { $l1fa03='error|Cannot update record ('. mysql_error(). ')'; $result=false; }; } if ($h65f31!=$ob4960){ t93c2(array ('NoteID' => $b21158)); foreach ($ma6168 as $fe4d23){ $v70b77=r0188($fe4d23); if (!$v70b77){ $cd7ca3=hec0d($fe4d23); $v70b77['ID']=b478d($fe4d23,$cd7ca3,0,'',0); } z0738( "INSERT INTO `". $r2e5d8['db']['table_prefix']."NotesKeywords` ". "(`NoteID`, `KeywordID`) ". "VALUES (". ((int)$b21158) .", ". ((int)$v70b77['ID']). ")" ); } } if ( $f98ea6!='ajaxresult' and $result and $_POST['instant-publish']=='yes' ){ $_POST['note-id']=$b21158; e2s_note_publish(); } } else { $l1fa03='error|Title or text is empty'; $_fp_error=FP_TITLE_OR_TEXT_EMPTY; $result=false; } } else { $l1fa03='error|No note id/new specified'; $_fp_error=FP_NO_ID_OR_NEW; $result=false; } if ($f98ea6=='ajaxresult') return $l1fa03; else return$result; } function wcc02($k92c58){ global $r2e5d8; $e8b7af='p1'; if (!oe852()) { $e8b7af='p1v1'; $rf79b1="AND `IsVisible`=1"; } $nd29bb=CACHES_FOLDER.$k92c58 .'-stamp-'. $e8b7af .'.e2time.psa'; if(CACHE_EDGE_TIMEINFO and is_file($nd29bb)) { $result=@unserialize(acdf0($nd29bb)); } if(is_array($result)) { return$result; } else { if ($k92c58=='start'){ z0738( "SELECT Stamp, Offset, IsDST FROM `". $r2e5d8['db']['table_prefix']."Notes` ". "WHERE `IsPublished`=1 ". $rf79b1 ." ORDER BY Stamp LIMIT 1" ); } elseif ($k92c58=='end'){ z0738( "SELECT Stamp, Offset, IsDST FROM `". $r2e5d8['db']['table_prefix']."Notes` ". "WHERE `IsPublished`=1 ". $rf79b1 ." ORDER BY Stamp DESC LIMIT 1" ); } $result=t0d6b(); if(count($result)) { $result=array ( 'stamp' => $result[0]['Stamp'], 'timezone' => e2_note_timezone($result[0]), ); if(CACHE_EDGE_TIMEINFO)t6e52($nd29bb,serialize($result)); return$result; } else { return null; } } } function h8ca0($d1653c,$x0604c){ global $r2e5d8; if (!($d1653c and $x0604c) and !oe852()) { die ('API MISUSE: e2_notes_count_general cannot be called for invisible notes or drafts unsecurely :-('); } if (!is_bool($d1653c) or !is_bool($x0604c)) { die ('API MISUSE: e2_notes_count_general must be called with bool params :-('); } if (!$d1653c and !$x0604c){ die ('API MISUSE: e2_notes_count_general called with nonsensical parameters'); } $nd29bb=CACHES_FOLDER . 'notes-count-p'. (int)$d1653c . ($d1653c ? ('v'. (int)$x0604c):'') . '.txt'; $result=false; if(CACHE_NOTES_COUNTS and is_file($nd29bb)) { $result=@acdf0($nd29bb); } if(is_numeric($result) and $result > 0){ return$result; } else { z0738( "SELECT COUNT(*) As NotesCount FROM `". $r2e5d8['db']['table_prefix']."Notes` ". "WHERE `IsPublished`=". (int)$d1653c. " ". ($d1653c ? ( "AND   `IsVisible`=". (int)$x0604c ):"") ); $result=t0d6b(); $result=$result[0]['NotesCount']; if($result){ if(CACHE_NOTES_COUNTS)t6e52($nd29bb,$result); return$result; } else { return null; } } } define('DRAFT_PREVIEW_LENGTH',100); function e2m_drafts(){ global $r2e5d8; $mda3ad='Stamp'; $mda3ad='LastModified'; $sda48a=array(); if (z0738( "SELECT * FROM `". $r2e5d8['db']['table_prefix']."Notes` ". "WHERE `IsPublished`=0 ". "ORDER BY `". $mda3ad ."` DESC" )) { $result=t0d6b(); $t4358b=array(); foreach($result as $q8ce4b => $u39a37){ $oaad65['_']['_id']=$u39a37['ID']; $oaad65['_']['_ord']=k; $oaad65['_']['_ord_max']=count($result)-1; $oaad65['href']=x83c8('e2m_draft', array ( 'draft' => $u39a37['ID'], )); $oaad65['title']=q6f10(htmlspecialchars(hea9c($u39a37),ENT_NOQUOTES)); if (isset ($oaad65['image-href'])) unset ($oaad65['image-href']); if(preg_match_all('/\(\(([^ ]*)( |\)\))/',$u39a37['Text'],$j9c28d)) { foreach ($j9c28d[1] as $xe3cc9){ if(is_file(PICTURES_FOLDER.$xe3cc9)) { if ($if1210=v291d($xe3cc9)) { $oaad65['image-href']=$if1210; break; } } } } $oaad65['text-fragment']=strip_tags(k154e($u39a37['FormatterID'],str_replace("\n",' ',$u39a37['Text']), 'simple')); $j2ab2d=false; if(strlen($oaad65['text-fragment']) > DRAFT_PREVIEW_LENGTH) { $j2ab2d=strpos($oaad65['text-fragment'],'.',DRAFT_PREVIEW_LENGTH); } if ($j2ab2d!==false){ $oaad65['text-fragment']=substr($oaad65['text-fragment'],0,$j2ab2d+1); } $sda48a[] = $oaad65; } } return array ( 'title' => 'Черновики', 'heading' => 'Черновики', 'drafts' => $sda48a, ); } function e2m_draft($parameters=array ()) { global $a57de2; $oaad65=b4627($parameters['draft']); $yd58c0=x83c8('e2m_note', array ('*note' => $oaad65)); if ($oaad65['IsPublished']) { return e2_go_to($yd58c0); } $oaad65['_']['_id']=$oaad65['ID']; $oaad65['_']['_ord']=0; $oaad65['_']['_ord_max']=0; $t8e4cd=l6791($oaad65); $w45513=array ( '.note-id' => $oaad65['ID'], 'form-action' => x83c8('e2s_note_publish'), 'submit-text' => 'Опубликовать заметку', ); return array ( 'title' => hea9c($oaad65).' (черновик)', 'notes' => array ('only' => $t8e4cd), 'form' => 'form-note-publish', 'form-note-publish' => $w45513, ); } $_url_map=array ( '@build' => 'e2://e2s_build', '@sync' => 'e2://e2s_sync', '@instantiate:version' => 'e2://e2s_instantiate', '@ajax/::' => 'e2://e2j_::', '@actions/::' => 'e2://e2s_::', '' => 'e2://e2m_frontpage?page=1', ':page' => 'e2://e2m_frontpage', 'rss' => 'e2://e2m_frontpage_rss', ':year' => 'e2://e2m_year', ':year/:month' => 'e2://e2m_month', ':year/:month/:day' => 'e2://e2m_day', ':note' => 'e2://e2m_note', ':note/comment' => 'e2://e2m_note_comment', ':note/@edit' => 'e2://e2m_note_edit?is_published=1', ':note/@edit/time' => 'e2://e2m_note_finetune?is_published=1', ':note/@favourite' => 'e2://e2m_note_flag_favourite?is_published=1&value=1', ':note/@unfavourite' => 'e2://e2m_note_flag_favourite?is_published=1&value=0', ':note/@show' => 'e2://e2m_note_flag?is_published=1&flag=IsVisible&value=1', ':note/@hide' => 'e2://e2m_note_flag?is_published=1&flag=IsVisible&value=0', ':note/@discuss' => 'e2://e2m_note_flag?is_published=1&flag=IsCommentable&value=1', ':note/@quiet' => 'e2://e2m_note_flag?is_published=1&flag=IsCommentable&value=0', ':note/@withdraw' => 'e2://e2m_note_withdraw?is_published=1', ':note/@delete' => 'e2://e2m_note_delete?is_published=1', ':note/@delete-spam' => 'e2://e2m_note_delete_spam?is_published=1', ':note/:unsubscr' => 'e2://e2m_unsubscribe?is_published=1', ':note/comments-rss' => 'e2://e2m_note_comments_rss', ':comment' => 'e2://e2m_comment', ':comment/@edit' => 'e2://e2m_comment_edit', ':comment/@important' => 'e2://e2m_comment_flag_ajax?flag=IsFavourite&value=1', ':comment/@usual' => 'e2://e2m_comment_flag_ajax?flag=IsFavourite&value=0', ':comment/@replace' => 'e2://e2m_comment_flag_ajax?flag=IsVisible&value=1', ':comment/@remove' => 'e2://e2m_comment_flag_ajax?flag=IsVisible&value=0', ':comment/@spam' => 'e2://e2m_comment_flag?flag=IsSpamSuspect&value=1', ':comment/@good' => 'e2://e2m_comment_flag?flag=IsSpamSuspect&value=0', ':comment/@wipe' => 'e2://e2m_comment_delete', ':comment/reply/@edit' => 'e2://e2m_comment_reply', ':comment/reply/@important' => 'e2://e2m_comment_flag_ajax?flag=IsReplyFavourite&value=1', ':comment/reply/@usual' => 'e2://e2m_comment_flag_ajax?flag=IsReplyFavourite&value=0', ':comment/reply/@replace' => 'e2://e2m_comment_flag_ajax?flag=IsReplyVisible&value=1', ':comment/reply/@remove' => 'e2://e2m_comment_flag_ajax?flag=IsReplyVisible&value=0', ':comment/reply/@delete' => 'e2://e2m_comment_reply_delete', '@drafts' => 'e2://e2m_drafts', '@drafts/:draft' => 'e2://e2m_draft', '@drafts/:draft/edit' => 'e2://e2m_note_edit?is_published=0', '@drafts/:draft/unfavourite' => 'e2://e2m_note_flag_favourite?is_published=0&value=0', '@drafts/:draft/delete' => 'e2://e2m_note_delete?is_published=0', 'uploads/:file' => '', 'tags' => 'e2://e2m_tags', 'tags/:tag' => 'e2://e2m_tag?page=1', 'tags/:tag:page' => 'e2://e2m_tag', 'tags/:tag/rss' => 'e2://e2m_tag_rss', 'tags/:tag/edit' => 'e2://e2m_tag_edit', 'tags/:tag/delete' => 'e2://e2m_tag_delete', 'tags/:tag/pin' => 'e2://e2m_tag_flag_ajax?flag=IsFavourite&value=1', 'tags/:tag/unpin' => 'e2://e2m_tag_flag_ajax?flag=IsFavourite&value=0', 'untagged' => 'e2://e2m_untagged', 'hot' => 'e2://e2m_most_commented', 'selected' => 'e2://e2m_favourites?page=1', 'selected:page' => 'e2://e2m_favourites', 'found' => 'e2://e2m_found?page=1&query=', 'found/:query' => 'e2://e2m_found?page=1', 'found/:query:page' => 'e2://e2m_found', 'found/:query/rss' => 'e2://e2m_found_rss', 'everything' => 'e2://e2m_everything', '@new' => 'e2://e2m_write', '@settings' => 'e2://e2m_settings', '@name' => 'e2://e2m_name_and_author', '@install' => 'e2://e2m_install', '@update' => 'e2://e2m_update', '@update/install' => 'e2://e2m_update_install', '@database' => 'e2://e2m_database', '@password' => 'e2://e2m_password', '@sessions' => 'e2://e2m_sessions', '@timezone' => 'e2://e2m_timezone', '@sign-in' => 'e2://e2m_sign_in', '@sign-out' => 'e2://e2m_sign_out', ); $_url_chunks=array ( '\:page' => '\~(?P<page>\d+)', '\:year' => '(?P<year>\d{4})', '\:month' => '(?P<month>\d{1,2})', '\:day' => '(?P<day>\d{1,2})', '\:note' => '(?P<year>\d{4})\/(?P<month>\d{1,2})\/(?P<day>\d{1,2})\/(?P<day_number>\d+)', '\:comment' => '(?P<year>\d{4})\/(?P<month>\d{1,2})\/(?P<day>\d{1,2})\/(?P<day_number>\d+)\/'. 'comment\-(?P<comment_number>[0-9]+)', '\:file' => '(?P<file>.*?)', '\:tag' => TRANS_TAGS_UTF8_URLS? '(?P<tag>.*?)':'(?P<tag_urlname>.*?)', '\:query' => '(?P<query>.*?)', '\:draft' => '(?P<draft>\d+)', '\:version' => '\:(?P<version>\d+)', '\:unsubscr' => 'unsubscribe\:(?P<unsubscribe_email>.*?)\:(?P<unsubscribe_key>[0-9a-f]{32})', ); $_url_autoredirects=array ( '/^favo(u?)rites$/i' => 'selected', '/^favo(u?)rites\/(.*)/i' => 'selected/\\1', '/^search\/(.*)/i' => 'found/\\1', '/^keywords\/(.*)/i' => 'tags/\\1', '/^(\d{4}\/\d{1,2}\/\d{1,2}\/\d+)\/comments(\/?)$/i' => '\\1', ); function o7059(){ global$__synthetic_urls,$_config; $__synthetic_urls=false; if($_config['url_composition']=='auto'){ if(function_exists('apache_get_modules')) { if(in_array('mod_rewrite',apache_get_modules())) { $__synthetic_urls=true; } } } if($_config['url_composition']=='synthetic'){ $__synthetic_urls=true; } } function x83c8($lc48ba,$parameters=array ()) { global$_url_map,$_url_chunks,$_config,$__synthetic_urls,$a57de2,$ya57c1; $dc2bd7=array_flip($_url_map); if ( @$_config['preferred_domain_name'] and $_SERVER['HTTP_HOST']!=$_config['preferred_domain_name'] ) { $a57de2=$_config['preferred_domain_name']; } $z572d4='http://'. $a57de2.$ya57c1 .'/'; $g9c464='e2://'. $lc48ba; if(array_key_exists('page',$parameters)) { $z71860=$parameters['page']; } else { $z71860=1; } if($parameters){ $g9c464.='?'; $n1c61f=array(); $r21711=array(); foreach($parameters as $f3c6e0 => $j2063c){ if (@$f3c6e0[0]=='*'){ $r21711[] = $f3c6e0; $n1c61f[] = zbdf6($f3c6e0,$j2063c); } } foreach ($r21711 as $f3c6e0) unset($parameters[$f3c6e0]); foreach ($n1c61f as $k58e2a){ $parameters=array_merge($parameters,$k58e2a); } foreach($parameters as $f3c6e0 => $j2063c) if (!@$f3c6e0[0]=='_'){ if(array_key_exists('\:'. $f3c6e0,$_url_chunks)) { $q93316=$_url_chunks['\:'. $f3c6e0]; if(preg_match_all('/\<(.*?)\>/',$q93316,$j9c28d)) { foreach ($j9c28d[1] as $xe3cc9){ if(array_key_exists($xe3cc9,$parameters)) { $g9c464.=$xe3cc9 .'='. urlencode($parameters[$xe3cc9]) .'&'; } } } } else { $g9c464.=$f3c6e0 .'='. urlencode($j2063c) .'&'; } } $g9c464=substr($g9c464,0, -1); } if(0 and array_key_exists($g9c464,$dc2bd7)) { if ($dc2bd7[$g9c464]!='')$z572d4.=$dc2bd7[$g9c464] .'/'; return $z572d4; } else { $i44907=false; foreach ($dc2bd7 as $n45ea8 => $h9ea44){ $mb7365=$n45ea8; $mb7365=preg_quote($mb7365,'/'); if(strstr($n45ea8,'::')) { $mb7365=str_replace('\:\:','(.*)',$mb7365); $mb7365='/^'. $mb7365 .'$/s'; if(preg_match($mb7365,$g9c464,$j9c28d)) { $b0dc02=str_replace('_','-',$j9c28d[1]); $m95a17=str_replace('::',$b0dc02,$h9ea44); if($__synthetic_urls){ $z572d4.=$m95a17 .'/'; } else { $z572d4.='?go='. $m95a17 .'/'; } return $z572d4; } } $aebe09=parse_url($n45ea8); $v2f532=$aebe09['host']; $y54435=false; if ($lc48ba==$v2f532){ $i44907=true; if ($aebe09['query']) { $i22c38=explode('&',$aebe09['query']); foreach ($i22c38 as $r8822b){ list ($f3c6e0,$j2063c)=explode('=',$r8822b); $j2063c=urldecode($j2063c); $f3c6e0=str_replace('_','-',$f3c6e0); if ( array_key_exists($f3c6e0,$parameters) and $parameters[$f3c6e0]!=$j2063c ){ $y54435=true; break; } } } if (!$y54435){ if(preg_match_all('/\:[\-a-z]+/i',$h9ea44,$j9c28d)) { foreach ($j9c28d[0] as $bfc413){ $s05f62=$_url_chunks['\\'. $bfc413]; $pf9e1e=preg_replace( '/\(\?P\<(.*?)\>.*?\)/e','$parameters[str_replace ("_", "-", "\\1")]',$s05f62 ); $pf9e1e=stripslashes($pf9e1e); $h9ea44=str_replace($bfc413,$pf9e1e,$h9ea44); } } $h15214=array(); if ($h9ea44){ if($__synthetic_urls){ $z572d4.=$h9ea44 .'/'; } else { $h15214[] = 'go='. $h9ea44 .'/'; } } foreach($_GET as $q8ce4b => $d9e366) if(in_array($q8ce4b, array ('result','raw','themeless'))) { $h15214[] = $q8ce4b . ($d9e366? ('='. urlencode($d9e366)) : ''); } if(count($h15214)) { $z572d4.='?'. implode('&',$h15214); } return $z572d4; } } } if ($i44907){ return $z572d4; } else { die ('Cannot compose url for candy '. $lc48ba); } } } function tb7e9($z572d4){ global$_url_map,$_url_chunks,$_url_autoredirects,$_config,$__synthetic_urls,$a57de2,$ya57c1; $g196c2=$z572d4; $z572d4=trim($z572d4,'/'); $z572d4=preg_replace(array_keys($_url_autoredirects),array_values($_url_autoredirects),$z572d4); $parameters=array(); foreach($_url_map as $s12a24 => $n45ea8){ $ed532d=$s12a24; $ed532d=preg_quote($ed532d,'/'); if(strstr($s12a24,'::')) { $ed532d=str_replace('\:\:','(.*)',$ed532d); $ed532d='/^'. $ed532d .'$/s'; if(preg_match($ed532d,$z572d4,$j9c28d)) { $c53b9e=str_replace('-','_',$j9c28d[1]); $g9c464=str_replace('::',$c53b9e,$n45ea8); } } elseif(strstr($s12a24,':')) { $ed532d=str_replace( array_keys($_url_chunks), array_values($_url_chunks), $ed532d ); $ed532d='/^'. $ed532d .'$/s'; if(preg_match($ed532d,$z572d4,$j9c28d)) { $g9c464=$n45ea8; foreach ($j9c28d as $f3c6e0 => $j2063c) if (!is_numeric($f3c6e0)) { $f3c6e0=str_replace('_','-',$f3c6e0); $parameters[$f3c6e0]=$j2063c; } } } else { if ($s12a24==$z572d4){ $g9c464=$n45ea8; break; } } } $ffafdd=(bool)$g9c464; if (!$g9c464)$g9c464='e2://e2m_404'; $aebe09=parse_url($g9c464); $lc48ba=$aebe09['host']; if ($aebe09['query']) { $i22c38=explode('&',$aebe09['query']); foreach ($i22c38 as $r8822b){ list ($f3c6e0,$j2063c)=explode('=',$r8822b); $j2063c=urldecode($j2063c); $f3c6e0=str_replace('_','-',$f3c6e0); $parameters[$f3c6e0]=$j2063c; } } $t2cb9d=false; if ($ffafdd){ if($_config['force_canonical_urls']) { $w95d32=x83c8($lc48ba,$parameters); $ma37bf='http://'.$_SERVER['HTTP_HOST'].$_SERVER['REQUEST_URI']; $b5d6ba='http://'.$_SERVER['HTTP_HOST'].urldecode($_SERVER['REQUEST_URI']); if ($ma37bf!=$w95d32 and $b5d6ba!=$w95d32){ e2_go_to($w95d32); } } if(TRANS_TAGS_UTF8_URLS){ foreach($parameters as $q8ce4b => $d9e366){ $parameters[$q8ce4b]=pedd9($parameters[$q8ce4b]); } } if(is_callable($lc48ba)) { $t2cb9d=array ($lc48ba,$parameters); } else { $t2cb9d=array (null, array ()); } } else { $t2cb9d=array (null, array ()); } return $t2cb9d; } function zbdf6($f3c6e0,$j2063c){ $parameters=array(); if ($f3c6e0=='*note')$parameters=e2urls__tricky_parameters_for_note_($j2063c); return$parameters; } function e2urls__tricky_parameters_for_note_($oaad65){ global $r2e5d8,$ya57c1; if (!isset ($oaad65['IsPublished'])) { return array (); } if (!$oaad65['IsPublished']) { $parameters['draft']=$oaad65['ID']; $parameters['is-published']=0; return$parameters; } $lb80bb=$oaad65['ID']; $z96b8c=$oaad65['Stamp']; $qb2c6c=e2_note_timezone($oaad65); list ($m41529,$n6f8f5,$s8277e)=explode('/', e2_format_dt_of_timezone('Y/m/d',$z96b8c,$qb2c6c) ); $parameters['year']=$m41529; $parameters['month']=$n6f8f5; $parameters['day']=$s8277e; $parameters['is-published']=1; if (isset ($oaad65['day_number'])) { $parameters['day-number']=$oaad65['day_number']; } else { list ($id9d0f, ) = e2_boundaries_worldwide($m41529,$n6f8f5,$s8277e); if (z0738( "SELECT `ID`, `Stamp`, `Offset`, `IsDST` ". "FROM `". $r2e5d8['db']['table_prefix']."Notes` ". "WHERE `IsPublished` = 1 AND (`Stamp` BETWEEN " .$id9d0f. " AND " .$z96b8c. ") ". "ORDER BY `Stamp`" )) { $result=t0d6b(); $mb1bc2=1; foreach($result as $e65afd){ if ( $m41529.'/'.$n6f8f5.'/'.$s8277e == e2_format_dt_of_timezone('Y/m/d',$e65afd['Stamp'],e2_note_timezone($e65afd)) ) { if ($e65afd['ID']==$lb80bb){ $x444bc=1; break; } $mb1bc2 ++; } } if (@$x444bc!=1){ header('HTTP/1.1 503 Service Unavailable'); die ('<big style="background: #a00; color: #ccc; padding: .1em .33em">CANDIDATES_ENUMERATION_FAILED</big>'); } } $parameters['day-number']=$mb1bc2; } return$parameters; } function e2m_tags(){ global $r2e5d8; $result=e2_keywords(); $p59aeb=array(); foreach($result['keywords'] as $h0ac27){ $ec6827['tag']=htmlspecialchars($h0ac27['Keyword']); $ec6827['href']=x83c8( 'e2m_tag', TRANS_TAGS_UTF8_URLS ? array ('tag' => $ec6827['tag']) : array ('tag-urlname' => $h0ac27['URLName']) ); $ec6827['favourite?'] = (bool)$h0ac27['IsFavourite']; $ec6827['notes-count']=0; $ec6827['last-used']=0; $ec6827['freshness']=0; $ec6827['weight']=0; $p59aeb[$h0ac27['ID']] = $ec6827; } $v9fdd5=0; $g8f57c=0; $n06894=0; foreach($result['ordering_info'] as $g28a42){ $ec6827 =& $p59aeb[$g28a42['KeywordID']]; $ec6827['notes-count']=$g28a42['Count']; if (@$ec6827['last-used'] < $g28a42['LastUsed']) { $ec6827['last-used']=$g28a42['LastUsed']; $x452b4=(time()-$ec6827['last-used']) / SECONDS_IN_A_YEAR; $ec6827['freshness']=pow(1/2,$x452b4); } $v9fdd5=max($v9fdd5,$ec6827['notes-count']); $g8f57c=max($g8f57c,$ec6827['freshness']); $n06894=max($n06894,$ec6827['notes-count']*$ec6827['freshness']); } $w86d7e=array(); foreach ($p59aeb as $h865c0 => $d9e366){ $t95e80=strtolower($d9e366['tag']); $w86d7e[$t95e80]=$d9e366; if ($g8f57c!=0){ $w86d7e[$t95e80]['freshness']=$d9e366['freshness']/$g8f57c; } else { $w86d7e[$t95e80]['freshness']=0; } if ($n06894!=0){ $w86d7e[$t95e80]['weight'] = ( $d9e366['freshness']*$d9e366['notes-count']/$n06894 ); } else { $w86d7e[$t95e80]['weight']=0; } if ($w86d7e[$t95e80]['favourite?'])$w86d7e[$t95e80]['weight']=1; } ksort($w86d7e); $t2cb9d=array ( 'title' => 'Теги', 'heading' => 'Теги', ); if(count($w86d7e) > 0){ $t2cb9d['tags'] = array ( 'many?' => count($w86d7e) > KEYWORDS_MANY_THRESH, 'each' => $w86d7e, ); } return $t2cb9d; } function e2m_tag($parameters=array ()) { global $r2e5d8, $_config, $_current_tag, $z71860,$lf97aa; if(array_key_exists('_tagrec',$parameters)) { $ld7df5=$parameters['_tagrec']; $e7186e=$parameters['tag-urlname']; } else { return e2_error404_mode(); } $_current_tag=$ld7df5['Keyword']; $z71860=$parameters['page']; $rf79b1='AND `IsVisible`=1'; if (oe852())$rf79b1=''; $ic2b7b=$r2e5d8['db']['table_prefix']; $p56790[] = "`". $ic2b7b."NotesKeywords`.KeywordID=". $ld7df5['ID']; $p56790=implode(' OR ',$p56790); $v76595=( "SELECT DISTINCT `". $ic2b7b."Notes`.* FROM `". $ic2b7b."Notes` ". "INNER JOIN `". $ic2b7b."NotesKeywords` ". "ON `". $ic2b7b."NotesKeywords`.NoteID=`". $ic2b7b."Notes`.ID ". "WHERE `IsPublished`=1 AND (". $p56790 .") ". $rf79b1 ." ". "ORDER BY `". $ic2b7b."Notes`.`Stamp` DESC" ); $jd7e5d=$r2e5d8['appearance']['notes_per_page']; $c7694f=$v76595.' LIMIT '.($z71860-1)*$jd7e5d.', '.$jd7e5d; $j61e23=str_replace( "SELECT DISTINCT `". $r2e5d8['db']['table_prefix']."Notes`.*", "SELECT COUNT(DISTINCT `". $r2e5d8['db']['table_prefix']."Notes`.`ID`) AS NotesCount", $v76595 ); $ib3b32=array(); if (z0738($j61e23)) { $result=t0d6b(); $ufbb44=$result[0]['NotesCount']; $mae0fe=ceil($ufbb44/$jd7e5d); $ib3b32['numbered?']=true; $ib3b32['count']=$mae0fe; $ib3b32['this']=$z71860; for ($h865c0=1; $h865c0 <= $mae0fe; $h865c0++) { $j920fa=$parameters; $j920fa['page']=$h865c0; $ib3b32['each'][$h865c0]=x83c8('e2m_tag',$j920fa); } $ib3b32['title']='Страницы'; $ib3b32['prev-title']='<a>предыдущая</a>'; $ib3b32['next-title']='<a>следующая</a>'; if ($z71860 > 1){ $ib3b32['prev-href']=$ib3b32['each'][$z71860-1]; } if ($z71860 < $mae0fe){ $ib3b32['next-href']=$ib3b32['each'][$z71860+1]; } } if (z0738($c7694f)) { $result=t0d6b(); foreach($result as $q8ce4b => $oaad65){ $oaad65['_']['_id']=$oaad65['ID']; $oaad65['_']['_ord']=k; $oaad65['_']['_ord_max']=count($result)-1; $t4358b[] = l6791($oaad65); } } if (oe852()) { $r97a59['edit-href']=x83c8( 'e2m_tag_edit', TRANS_TAGS_UTF8_URLS ? array ('tag' => htmlspecialchars($ld7df5['Keyword'])) : array ('tag-urlname' => $e7186e) ); } if (''!=$ld7df5['Description']) { $r67daf=wb7f1($ld7df5['Description'],'simple','nocache'); $r97a59['description']=$r67daf; } if(TRANS_TAGS_UTF8_URLS){ $j3ad42=x83c8('e2m_tag_rss', array ('tag' => htmlspecialchars($ld7df5['Keyword']))); } else { $j3ad42=x83c8('e2m_tag_rss', array ('tag-urlname' => $e7186e)); } x3010( 'Заметки с тегом: '. htmlspecialchars($ld7df5['Keyword']), $j3ad42 ); $q96963=tace2($ufbb44. ' замет(ка,ки,ок)'). ' с тегом'; $t2cb9d=array ( 'title' => $q96963 .': '. $ld7df5['Keyword'], 'superheading' => $q96963, 'heading' => $ld7df5['Keyword'], 'related-rss-href' => $j3ad42, 'pages' => $ib3b32, 'notes' => $t4358b, 'tag' => $r97a59, ); if (oe852()) { $t2cb9d['related-edit-href']=$r97a59['edit-href']; $t2cb9d['related-edit-title']='Править параметры и описание тега'; } return $t2cb9d; } function e2m_tag_edit($parameters=array()) { global $r2e5d8; if(array_key_exists('_tagrec',$parameters)) { $ld7df5=$parameters['_tagrec']; } else { return e2_error404_mode(); } $qcd831=array ( '.tag-id' => $ld7df5['ID'], 'form-action' => x83c8('e2s_tag_edit'), 'submit-text' => 'Сохранить изменения', 'tag' => htmlspecialchars($ld7df5['Keyword']), 'urlname' => htmlspecialchars($ld7df5['URLName']), 'description' => htmlspecialchars($ld7df5['Description']), 'favourite?' => (bool)$ld7df5['IsFavourite'], 'delete-href' => x83c8( 'e2m_tag_delete', TRANS_TAGS_UTF8_URLS ? array ('tag' => htmlspecialchars($ld7df5['Keyword'])) : array ('tag-urlname' => $ld7df5['URLName']) ), ); $t2cb9d=array ( 'title' => 'Изменение тега:'. $ld7df5['Keyword'], 'heading' => 'Изменение тега', 'form' => 'form-tag', 'form-tag' => $qcd831, ); return $t2cb9d; } function e2m_tag_flag_ajax($parameters){ if (a2e88($parameters)) { $z67142=$parameters; $z67142['value'] = !$parameters['value']; if($parameters['value']==1){ $k99859=x83c8('e2m_tag_flag_ajax',$z67142); $l1fa03='on-rehref|'. $k99859; } else { $k99859=x83c8('e2m_tag_flag_ajax',$z67142); $l1fa03='off-rehref|'. $k99859; } } else { $l1fa03='error'; } if(array_key_exists('result',$_POST) and ($_POST['result']=='ajaxresult')) { die ($l1fa03); } else { e2_go_to(x83c8('e2m_tag',$parameters)); die; } } function a2e88($parameters){ if(array_key_exists('_tagrec',$parameters)) { $ld7df5=$parameters['_tagrec']; } else { return false; } @unlink(CACHE_FILENAME_FAVTAGS); $result=taa79('Keywords', array ( 'ID' => $ld7df5['ID'], $parameters['flag'] => (int) ($parameters['value']==1), )); return$result; } function e2m_tag_delete($parameters=array()) { global $r2e5d8; if(array_key_exists('_tagrec',$parameters)) { $ld7df5=$parameters['_tagrec']; } else { return e2_error404_mode(); } $recc14=array ( '.tag-id' => $ld7df5['ID'], 'form-action' => x83c8('e2s_tag_delete'), 'submit-text' => 'Удалить', 'tag' => htmlspecialchars($ld7df5['Keyword']), ); $t2cb9d=array ( 'title' => 'Удаление тега: '. $ld7df5['Keyword'], 'heading' => 'Удаление тега', 'form' => 'form-tag-delete', 'form-tag-delete' => $recc14, ); return $t2cb9d; } function e2m_untagged(){ global $r2e5d8; $rf79b1='AND `IsVisible`=1'; if (oe852())$rf79b1=''; return md864(array ( 'query' => "SELECT n.* FROM `". $r2e5d8['db']['table_prefix']."Notes` n ". "LEFT OUTER JOIN `". $r2e5d8['db']['table_prefix']."NotesKeywords` nk ". "ON nk.NoteID = n.ID ". "WHERE `IsPublished`=1 AND nk.KeywordID IS NULL ".$rf79b1." ". "ORDER BY n.Stamp DESC", 'title' => 'Заметки без тегов', 'heading' => 'Заметки без тегов', 'no-notes-text' => 'Заметок без тегов нет', 'show-all-notes' => true, )); } function e2s_tag_edit(){ global $r2e5d8; $h89e37=1; if (!k01d3($_POST['urlname'])) { w8a40('Такой вид в адресной строке не может быть использован'); $h89e37=0; } if (z0738( "SELECT Keyword, URLName FROM `". $r2e5d8['db']['table_prefix']."Keywords` ". "WHERE (Keyword = '".h7928($_POST['tag'])."' ". "OR URLName = '".h7928($_POST['urlname'])."') ". "AND (ID != ".((int)$_POST['tag-id']).")")) { if(count(t0d6b()) == 0){ j7996(); @unlink(CACHE_FILENAME_FAVTAGS); if (z0738( "UPDATE `". $r2e5d8['db']['table_prefix']."Keywords` "."SET ". "`Keyword`='".h7928($_POST['tag'])."', ". ($h89e37? "`URLName`='".h7928($_POST['urlname'])."', ":''). "`Description`='".h7928($_POST['description'])."'". ' WHERE `ID`='.((int)$_POST['tag-id']))) { if ($h89e37 and TRANS_TAGS_UTF8_URLS){ e2_go_to(x83c8('e2m_tag', array ('tag' => $_POST['tag']))); } elseif (!TRANS_TAGS_UTF8_URLS){ e2_go_to(x83c8('e2m_tag', array ('tag-urlname' => $_POST['urlname']))); } else { i4930(); } die; } else { w8a40('Ошибка при обновлении описания в таблице тегов'); i4930(); die; } } else { w8a40('Такое имя или вид в адресной строке уже используются другим тегом') and i4930() and die; } } else { w8a40('Ошибка при обновлении описания в таблице тегов') and i4930() and die; } } function e2s_tag_delete(){ global $r2e5d8; $lb80bb=((int)$_POST['tag-id']); j7996(); @unlink(CACHE_FILENAME_FAVTAGS); $x444bc=( z0738( "DELETE FROM `". $r2e5d8['db']['table_prefix']."Keywords` WHERE `ID`=". $lb80bb ) and z0738( "DELETE FROM `". $r2e5d8['db']['table_prefix']."NotesKeywords` WHERE `KeywordID`=". $lb80bb ) ); if ($x444bc){ e2_go_to(x83c8('e2m_tags')); die; } else { w8a40('Ошибка при удалении тега'); i4930(); die; } } function e2_unfold_tag_parameters($parameters=array ()) { global $r2e5d8; if(TRANS_TAGS_UTF8_URLS){ if(array_key_exists('tag',$parameters)) { $q8ce4b=r0188($parameters['tag']); if ($q8ce4b)$parameters['_tagrec']=$q8ce4b; $parameters['tag-urlname']=$parameters['_tagrec']['URLName']; } } else { if(array_key_exists('tag-urlname',$parameters)) { $q8ce4b=u812d($parameters['tag-urlname']); if ($q8ce4b)$parameters['_tagrec']=$q8ce4b; $parameters['tag']=$parameters['_tagrec']['Keyword']; } } return$parameters; } function e2_keywords(){ global $r2e5d8; z0738( "SELECT * FROM `". $r2e5d8['db']['table_prefix']."Keywords`" ); $p59aeb=t0d6b(); z0738( "SELECT nk.KeywordID, COUNT(DISTINCT n.ID) as Count, max(n.Stamp) as LastUsed ". "FROM `". $r2e5d8['db']['table_prefix']."NotesKeywords` nk, ". "`". $r2e5d8['db']['table_prefix']."Notes` n ". "WHERE nk.NoteID = n.ID AND n.IsPublished ". (oe852()? "":"AND n.IsVisible=1 " ). "GROUP BY nk.KeywordID" ); $x0c6dc=t0d6b(); return array ('keywords' => $p59aeb,'ordering_info' => $x0c6dc); } function paf16($y07f25){ global $r2e5d8,$c097cc,$_current_tag; $q9df9d=null; if(CACHE_FAVTAGS and is_file(CACHE_FILENAME_FAVTAGS)) { $q9df9d=@unserialize(acdf0(CACHE_FILENAME_FAVTAGS)); } if (!is_array($q9df9d)) { z0738( "SELECT * FROM `". $r2e5d8['db']['table_prefix']."Keywords` ". "WHERE IsFavourite = 1 ORDER BY `Keyword`" ); $p9cdff=t0d6b(); $q9df9d=array(); foreach ($p9cdff as $d04ff0){ $ec6827['tag']=htmlspecialchars($d04ff0['Keyword'],ENT_NOQUOTES); $ec6827['href']=x83c8( 'e2m_tag', TRANS_TAGS_UTF8_URLS ? array ('tag' => $ec6827['tag']) : array ('tag-urlname' => $d04ff0['URLName']) ); $q9df9d[] = $ec6827; } if(CACHE_FAVTAGS)t6e52(CACHE_FILENAME_FAVTAGS,serialize($q9df9d)); } $t8a4f1=false; foreach ($q9df9d as $q8ce4b => $d9e366){ $q9df9d[$q8ce4b]['current?'] = ( $q9df9d[$q8ce4b]['tag']==$_current_tag ); if ($q9df9d[$q8ce4b]['current?']) { $t8a4f1=true; $v08187=$y07f25; $v08187['flag']='IsFavourite'; $v08187['value']=0; if (oe852()) { $q9df9d[$q8ce4b]['pinnable?']=true; $q9df9d[$q8ce4b]['pinned?']=true; $q9df9d[$q8ce4b]['pinned-toggle-href'] = ( x83c8('e2m_tag_flag_ajax',$v08187) ); } } } if (oe852()) { if (!$t8a4f1 and array_key_exists('_tagrec',$y07f25)) { $aa55a9=$y07f25; $aa55a9['flag']='IsFavourite'; $aa55a9['value']=1; $fd5a7a=array ( 'tag' => htmlspecialchars($y07f25['_tagrec']['Keyword'],ENT_NOQUOTES), 'href' => x83c8('e2m_tag',$y07f25), 'current?' => true, 'pinnable?' => true, 'pinned?' => false, 'pinned-toggle-href' => x83c8('e2m_tag_flag_ajax',$aa55a9), ); $q9df9d[] = $fd5a7a; } } return $q9df9d; } function hce23($b21158,$parameters=''){ global $r2e5d8; $c0dff3=array(); if (z0738( "SELECT `". $r2e5d8['db']['table_prefix']."Keywords`.* ". "FROM `". $r2e5d8['db']['table_prefix']."Keywords`, ". "`". $r2e5d8['db']['table_prefix']."NotesKeywords` ". "WHERE `". $r2e5d8['db']['table_prefix']."NotesKeywords`.NoteID=". ((int)$b21158) ." ". "AND `". $r2e5d8['db']['table_prefix']."Keywords`.ID=`". $r2e5d8['db']['table_prefix']."NotesKeywords`.KeywordID" )) { $c0dff3=t0d6b(); } return $c0dff3; } function t93c2($weaa60){ global $r2e5d8; $i316e8=array(); foreach (array ( 'ID', 'NoteID', 'KeywordID', ) as $m06e3d) if(array_key_exists($m06e3d,$weaa60)) { $f6a7f2[] = '`'. $m06e3d .'`'."='". h7928($weaa60[$m06e3d]) ."'"; if ($m06e3d=='ID')$v729d6='tagbinging-id'; if ($m06e3d=='NoteID')$v729d6='tagbinging-note-id'; if ($m06e3d=='KeywordID')$v729d6='tagbinging-tag-id'; $i316e8[$v729d6]=$weaa60[$m06e3d]; } $g1b1cc=( "DELETE FROM `". $r2e5d8['db']['table_prefix']."NotesKeywords` ". "WHERE ". implode(' AND ',$f6a7f2) ); if (z0738($g1b1cc)) { return true; } } function ycbd4($weaa60){ global $r2e5d8; if (!array_key_exists('ID',$weaa60) or !is_numeric($weaa60['ID'])) { die ('API MISUSE: e2q_update_tagbinding must be called with an ID field in $tagbinding_record'); } $f6a7f2=array(); foreach (array ( 'NoteID', 'KeywordID', ) as $m06e3d) if(array_key_exists($m06e3d,$weaa60)) { $f6a7f2[] = '`'. $m06e3d .'`'."='". h7928($weaa60[$m06e3d]) ."'"; } if(count($f6a7f2) > 0){ $g1b1cc = "UPDATE `". $r2e5d8['db']['table_prefix']."NotesKeywords` ". "SET ". implode(', ',$f6a7f2) ." ". "WHERE `ID`=". $weaa60['ID']; if (z0738($g1b1cc)) { return true; } } } function b478d( $ld7df5,$cd7ca3,$e71883,$r67daf,$e8b087 ){ global $r2e5d8; $x444bc=z0738( "INSERT INTO `". $r2e5d8['db']['table_prefix']."Keywords` (". "`Keyword`, `URLName`, `ParentKeywordID`, `Description`, `IsFavourite`". ") VALUES (". "'". h7928($ld7df5) ."', ". "'". h7928($cd7ca3) ."', ". "'". h7928($e71883) ."', ". "'". h7928($r67daf) ."', ". "'".((int)$e8b087)."' ". ")" ); if ($x444bc){ return mysql_insert_id(); } else { return false; } } function b9298( $ld7df5, $cd7ca3='', $e71883=0, $r67daf='', $e8b087=false ){ $be8c6e=$ld7df5; $sea599=$ld7df5; $kce0b4=2; while (r0188($ld7df5)) { $ld7df5=$sea599 .' ('. ($kce0b4 ++) .')'; } if ($ld7df5!=$be8c6e){ w8a40( 'Тег &laquo;'. $be8c6e .'&raquo; уже есть, '. 'поэтому был создан тег &laquo;'. $ld7df5 .'&raquo;' ); } if(strstr($ld7df5,',') or strstr($ld7df5,'/')) { $ld7df5=str_replace(',','-',$ld7df5); $ld7df5=str_replace('/','-',$ld7df5); w8a40( 'Тег не может содержать символов &laquo;,&raquo; и &laquo;/&raquo;, '. 'т.к. они используются как разделители в списке '. 'и иерархии. Неправильные символы заменены на дефисы.' ); } $ybb832=$cd7ca3; if (''==$cd7ca3){ $cd7ca3=hec0d($ld7df5); } if (!k01d3($cd7ca3)) { $cd7ca3=hec0d($ld7df5); $oc0fe7=true; w8a40( 'Такой вид в адресной строке не может быть использован. '. 'Корректный вид сгенерирован автоматически.' ); } $e6274a=$cd7ca3; $defa7d=2; while (u812d($cd7ca3)) { $cd7ca3=$e6274a .'-'. ($defa7d ++); } if ($ybb832 and !$oc0fe7 and $cd7ca3!=$ybb832){ w8a40( 'Тег с видом в адресной строке &laquo;'. $ybb832 .'&raquo; уже есть, '. 'поэтому вид в адресной строке будет &laquo;'. $cd7ca3.'&raquo;' ); } $lb80bb=b478d( $ld7df5, $cd7ca3, $e71883, $r67daf, $e8b087 ); return $lb80bb; } function hec0d($lb45cf){ $lb45cf=strtr($lb45cf, array ( 'а' => 'a', 'б' => 'b', 'в' => 'v', 'г' => 'g', 'д' => 'd', 'е' => 'e', 'ё' => 'yo', 'ж' => 'zh', 'з' => 'z', 'и' => 'i', 'й' => 'y', 'к' => 'k', 'л' => 'l', 'м' => 'm', 'н' => 'n', 'о' => 'o', 'п' => 'p', 'р' => 'r', 'с' => 's', 'т' => 't', 'у' => 'u', 'ф' => 'f', 'х' => 'kh', 'ц' => 'ts', 'ч' => 'ch', 'ш' => 'sh', 'щ' => 'sch', 'ъ' => '', 'ы' => 'y', 'ь' => '', 'э' => 'e', 'ю' => 'yu', 'я' => 'ya', 'А' => 'A', 'Б' => 'B', 'В' => 'V', 'Г' => 'G', 'Д' => 'D', 'Е' => 'E', 'Ё' => 'Yo', 'Ж' => 'Zh', 'З' => 'Z', 'И' => 'I', 'Й' => 'Y', 'К' => 'K', 'Л' => 'L', 'М' => 'M', 'Н' => 'N', 'О' => 'O', 'П' => 'P', 'Р' => 'R', 'С' => 'S', 'Т' => 'T', 'У' => 'U', 'Ф' => 'F', 'Х' => 'Kh', 'Ц' => 'Ts', 'Ч' => 'Ch', 'Ш' => 'Sh', 'Щ' => 'Sch', 'Ъ' => '', 'Ы' => 'Y', 'Ь' => '', 'Э' => 'E', 'Ю' => 'Yu', 'Я' => 'Ya', ' ' => '-', '/' => '-', '<' => '-', '>' => '-', '.' => '-', ',' => '-', ':' => '-', '"' => '\'\'', '&' => '-and-', )); $lb45cf=preg_replace('/\-+/','-',$lb45cf); $lb45cf=preg_replace('/[^a-z0-9-\']*/i','',$lb45cf); $lb45cf=strtolower($lb45cf); if(__LOG)__log('Gen urlname'); $result=$lb45cf; $mb1bc2='2'; while (u812d($result)!==false){ $result=$lb45cf .'-'. $mb1bc2; ++ $mb1bc2; } return$result; } function o3873($mda3ad='Keyword'){ global $r2e5d8; if (z0738( "SELECT * FROM `". $r2e5d8['db']['table_prefix']."Keywords` ORDER BY `".$mda3ad."`") ) { $kfa816=t0d6b(); } else { $kfa816=array(); } $p59aeb=array(); foreach ($kfa816 as $we358e)$p59aeb[] = $we358e; return $p59aeb; } function ma463($b21158,$mda3ad='Keyword'){ global $r2e5d8; if (z0738( "SELECT `". $r2e5d8['db']['table_prefix']."Keywords`.* ". "FROM `". $r2e5d8['db']['table_prefix']."Keywords`, ". "`". $r2e5d8['db']['table_prefix']."NotesKeywords` ". "WHERE `". $r2e5d8['db']['table_prefix']."NotesKeywords`.NoteID=".((int)$b21158)." AND ". "`". $r2e5d8['db']['table_prefix']."Keywords`.ID=". "`". $r2e5d8['db']['table_prefix']."NotesKeywords`.KeywordID ". "ORDER BY `".$mda3ad."`" ))$kfa816=t0d6b(); else $kfa816=array(); $p59aeb=array(); foreach ($kfa816 as $we358e)$p59aeb[] = $we358e; return $p59aeb; } function j7d5e($ld7df5){ global $r2e5d8; if (z0738( "SELECT `URLName` FROM `". $r2e5d8['db']['table_prefix']."Keywords` ". "WHERE `Keyword`='".h7928($ld7df5)."'" )) $kfa816=t0d6b(); else $kfa816=array(); if (isset ($kfa816[0]['URLName'])) return $kfa816[0]['URLName']; else return false; } function r0188($ld7df5){ global $r2e5d8; if (($x5b0b7=strrpos($ld7df5,'/')) !== FALSE) $ld7df5=substr($ld7df5,$x5b0b7+1); if (z0738( "SELECT * FROM `". $r2e5d8['db']['table_prefix']."Keywords` ". "WHERE `Keyword`='".h7928($ld7df5)."'" )) { $q8ce4b=t0d6b(); if (isset ($q8ce4b[0])) return $q8ce4b[0]; } return NULL; } function u812d($cd7ca3){ global $r2e5d8; $f6a7f2=explode('/',trim($cd7ca3,'/')); $zb17d0=array_pop($f6a7f2); if (z0738( "SELECT * FROM `". $r2e5d8['db']['table_prefix']."Keywords` ". "WHERE `URLName`='".h7928($zb17d0)."'" )) $kfa816=t0d6b(); else $kfa816=array(); if (isset ($kfa816[0])) return $kfa816[0]; else return FALSE; } function n4e28($lb80bb){ global $r2e5d8; if (z0738( "SELECT * FROM `". $r2e5d8['db']['table_prefix']."Keywords` ". "WHERE `ID`='".((int)$lb80bb)."'" )) { $q8ce4b=t0d6b(); if (isset ($q8ce4b[0])) { $q8ce4b=$q8ce4b[0]; return $q8ce4b; } else { return NULL; } } return NULL; } function e2m_comment($parameters=array ()) { e2_go_to(x83c8('e2m_note',$parameters)); die; } function e2m_comment_edit($parameters=array ()) { return p4fb7('edit',$parameters); } function e2m_note_comment($parameters=array ()) { return p4fb7('write',$parameters); } function p4fb7($p60cd8,$parameters=array ()) { global $lf97aa,$r2e5d8; if (!@$r2e5d8['comments']['on']) { return e2_error404_mode(); } $wd5d3d='Новый комментарий'; $lf74f5='Новый комментарий'; $u69b97='new'; if ($p60cd8=='edit'){ $c4032b=e2_commentrec_with_parameters_($parameters); $dc50d0='Сохранить'; $u39a37=$c4032b['noterec']; $wd5d3d='Правка комментария'; $lf74f5='Правка комментария'; $u69b97=$gaca8d['ID']; if (!$c4032b){ return e2_error404_mode(); } $g80f02=array ( '.note-id' => $c4032b['NoteID'], '.comment-id' => $c4032b['ID'], '.already-subscribed?' => false, '.from' => substr($_SERVER['HTTP_REFERER'],strlen($lf97aa)+1), 'create:edit?' => false, 'form-action' => x83c8('e2s_comment_process'), 'submit-text' => 'Сохранить', 'show-subscribe?' => true, 'subscribe?' => (bool)$c4032b['IsSubscriber'], 'name' => htmlspecialchars($c4032b['AuthorName']), 'email' => htmlspecialchars($c4032b['AuthorEmail']), 'text' => htmlspecialchars($c4032b['Text'],ENT_NOQUOTES), 'email-field-name' => 'elton-john', ); } else { $u39a37=e2_published_noterec_with_parameters_($parameters); $dc50d0='Отправить'; $g80f02=r66aa($u39a37); } return array ( 'title' => $wd5d3d, 'heading' => $lf74f5, 'form' => 'form-comment', 'form-comment' => $g80f02, ); } function e2m_comment_reply($parameters=array ()) { global $r2e5d8; if (!@$r2e5d8['comments']['on']) return e2_error404_mode(); $c4032b=e2_commentrec_with_parameters_($parameters); if (!$c4032b){ return e2_error404_mode(); } $u39a37=$c4032b['noterec']; $q1aec6=a86f8($u39a37,$c4032b,$parameters['comment-number']); $q1aec6['_']['_id']=$c4032b['ID']; $q1aec6['_']['_ord']=0; $q1aec6['_']['_ord_max']=0; $q1aec6['replying?'] = (bool)true; $k817c7=($c4032b['Reply']=='' or !$c4032b['IsReplyVisible']); $wd5d3d=$k817c7? 'Ответ на комментарий':'Правка ответа на комментарий'; $y4dc70=array ( '.note-id' => $u39a37['ID'], '.comment-id' => $c4032b['ID'], '.reply-action' => $k817c7? 'new':'edit', 'form-action' => x83c8('e2s_comment_edit_reply'), 'submit-text' => $k817c7? 'Опубликовать':'Сохранить изменения', 'create:edit?' => (bool) ($k817c7), 'reply-text' => htmlspecialchars($c4032b['Reply'],ENT_NOQUOTES), 'mail-back?' => (bool) ($k817c7), ); return array ( 'title' => $wd5d3d, 'heading' => $wd5d3d, 'comments' => array ('only' => $q1aec6), 'form' => 'form-comment-reply', 'form-comment-reply' => $y4dc70, ); } function e2m_comment_delete($parameters=array ()) { global $r2e5d8,$ycbcce; if (!@$r2e5d8['comments']['on']) return e2_error404_mode(); $c4032b=e2_commentrec_with_parameters_($parameters); $b21158=$c4032b['NoteID']; if (!$c4032b){ return e2_error404_mode(); } e2_drop_caches_for_note_($b21158); if (z0738( "DELETE FROM `". $r2e5d8['db']['table_prefix']."Comments` ". "WHERE `ID` = '".((int)$c4032b['ID'])."'" )) { @unlink(USER_FOLDER. '/last-comment.psa'); } else { w8a40('Ошибка при удалении комментария'); } i4930(); die; } function e2m_comment_reply_delete($parameters=array ()) { global $r2e5d8; if (!@$r2e5d8['comments']['on']) return e2_error404_mode(); $c4032b=e2_commentrec_with_parameters_($parameters); if (!$c4032b){ return e2_error404_mode(); } if (z0738( "UPDATE `". $r2e5d8['db']['table_prefix']."Comments` SET ". "`Reply`='', ". "`IsReplyFavourite`='0' ". "WHERE `ID`=".((int)$c4032b['ID']) )) { } else { w8a40('Ошибка при удалении ответа на комментарий'); } i4930(); die; } function e2m_unsubscribe($parameters){ global $r2e5d8; $b70a17="ORDER BY `ID` DESC"; $u39a37=e2_published_noterec_with_parameters_($parameters); $b21158=$u39a37['ID']; $z0c83f=$parameters['unsubscribe-email']; $j1bc29=$parameters['unsubscribe-key']; $z0c83f=str_replace(' ','+',$z0c83f); if ($b21158){ if (z0738( "SELECT `ID`, `Stamp` FROM `". $r2e5d8['db']['table_prefix']."Comments` ". "WHERE `NoteID`=". $b21158 ." AND `IsSubscriber`=1 AND `AuthorEmail`='". $z0c83f ."' ". $b70a17 )) { $result=t0d6b(); if(count($result) < 1) { $t2cb9d['unsubscription-status']['success?']=false; $t2cb9d['unsubscription-status']['error-message']='Кажется, вы и так не подписаны на комментарии к этой заметке'; } else { $x06d4c=@$result[0]; $v97f69=md5($x06d4c['ID'].$x06d4c['Stamp'] .'x'); $a260ca=false; if ($j1bc29==$v97f69){ if (z0738( "UPDATE `". $r2e5d8['db']['table_prefix']."Comments` SET `IsSubscriber`=0 ". "WHERE `NoteID`=". $b21158 ." AND `AuthorEmail` = '".h7928($z0c83f)."'" )) { $a260ca=true; $t2cb9d['unsubscription-status']['success?']=true; $t2cb9d['unsubscription-status']['note-title']=q6f10( htmlspecialchars(hea9c($u39a37),ENT_NOQUOTES) ); $t2cb9d['unsubscription-status']['note-href']=x83c8( 'e2m_note', array ('*note' => $u39a37) ); } } if (!$a260ca){ $t2cb9d['unsubscription-status']['success?']=false; $t2cb9d['unsubscription-status']['error-message']='Почему-то отписка не сработала'; } } } else { $t2cb9d['unsubscription-status']['success?']=false; $t2cb9d['unsubscription-status']['error-message']='Комментарий не найден'; } } else { $t2cb9d['unsubscription-status']['success?']=false; $t2cb9d['unsubscription-status']['error-message']='Заметка не найдена'; } return $t2cb9d; } function e2m_comment_flag($parameters){ n6e30($parameters); e2_go_to(x83c8('e2m_note',$parameters)); die; } function e2m_comment_flag_ajax($parameters){ if (n6e30($parameters)) { $z67142=$parameters; $z67142['value'] = !$parameters['value']; if($parameters['value']==1){ $k99859=x83c8('e2m_comment_flag_ajax',$z67142); $l1fa03='on-rehref|'. $k99859; } else { $k99859=x83c8('e2m_comment_flag_ajax',$z67142); $l1fa03='off-rehref|'. $k99859; } } else { $l1fa03='error'; } if(array_key_exists('result',$_POST) and ($_POST['result']=='ajaxresult')) { die ($l1fa03); } else { e2_go_to(x83c8('e2m_note',$parameters)); die; } } function n6e30($parameters){ $c4032b=e2_commentrec_with_parameters_($parameters); $b21158=$c4032b['NoteID']; $result=false; if ($c4032b){ $result=taa79('Comments', array ( 'ID' => $c4032b['ID'], $parameters['flag'] => (int) ($parameters['value']==1), )); e2_drop_caches_for_note_($b21158); } return$result; } function e2s_comment_process(){ global $r2e5d8,$_fp_error; list ($b21158,$u69b97,$a9d090)=x1a90(); if (!$u69b97){ $l05c36=''; if($_fp_error==FP_NOT_COMMENTABLE){ w8a40('Эту заметку нельзя комментировать'); } elseif($_fp_error==FP_EMPTY_FIELD){ w8a40('И имя, и эл. адрес, и текст комментария обязательно должны быть указаны'); } elseif($_fp_error==FP_COMMENT_TOO_LONG){ $daa731='Слишком длинный комментарий'; $l05c36='Вы отправили слишком длинный комментарий, поэтому он не был сохранён.'; } elseif($_fp_error==FP_COMMENT_DOUBLE_POST){ $daa731='Повторный комментарий'; $l05c36='Вы отправили комментарий дважды, сохранён был только один.'; } elseif($_fp_error==FP_COMMENT_SPAM_SUSPECT){ $daa731='Комментарий похож на спам'; $l05c36='Простите, но робот решил, что это спам, поэтому комментарий не был отправлен.'; } else { w8a40('Произошла ошибка ('. $_fp_error .')'); } if ($l05c36){ $t2cb9d['title']=$daa731; $t2cb9d['heading']=$daa731; $t2cb9d['form']='form-unaccepted-comment'; $t2cb9d['form-unaccepted-comment'] = array ( 'reason' => $l05c36, 'text' => @htmlspecialchars($a9d090['text'],ENT_NOQUOTES), ); return $t2cb9d; } } e2_go_to(x83c8('e2m_note', array ('*note' => b4627($b21158)))); die; } function e2s_comment_edit_reply(){ global $r2e5d8,$a57de2; $te84af=@$_POST['text']; if(trim($te84af)=='')$te84af=''; $b21158=@$_POST['note-id']; $oaad65=b4627($b21158); $u69b97=@$_POST['comment-id']; $x06d4c=qb559($u69b97); $g54eb6=isset ($_POST['mail-back']); $u54fa9=time(); if(preg_match('//u',$te84af))$te84af=pedd9($te84af,true); if (@$_POST['reply-action']=='new'){ $he0e30=time(); } @unlink(e2_note_cache_filename_with_id_($b21158 .'-comments')); if (z0738( "UPDATE `". $r2e5d8['db']['table_prefix']."Comments` SET ". "`Reply`='". h7928($te84af) ."', ". ( isset ($he0e30)? ( "`ReplyStamp`='". $he0e30 ."', " ) : ( "" ) ). "`ReplyLastModified`='". $u54fa9 ."', ". "`IsReplyVisible`='1' ". "WHERE `ID`=".((int)$u69b97) )) { $yd58c0=x83c8('e2m_note', array ('*note' => $oaad65)); if ($g54eb6 and $te84af!=''){ $ec6827['comment-time'] = array ($x06d4c['Stamp'],e2_current_timezone()); $ec6827['commenter']=$x06d4c['AuthorName']; $ec6827['commenter-email']=$x06d4c['AuthorEmail']; $ec6827['comment-text']=$x06d4c['Text']; $ec6827['note-title']=q6f10(hea9c($oaad65)); $ec6827['reply-time'] = array (time(),e2_current_timezone()); $ec6827['blog-author']=k2640(); $ec6827['note-href']=$yd58c0; $ec6827['comment-href']=$yd58c0; $ec6827['reply-text']=$te84af; if(1){ list ($rb904c,$wde7a3)=ff8c7( 'comment-reply',$ec6827 ); $a77613=$x06d4c['AuthorEmail']; $b1a49b='From: '. iaed2(); ua41b($a77613,$rb904c,$wde7a3,$b1a49b); } if(1){ unset ($ec6827['commenter-email']); $b1a49b='From: '. iaed2(); foreach (y4975($oaad65,$x06d4c['AuthorEmail']) as $u39c63){ $oba570=$u39c63['AuthorEmail']; $f6fd85=md5($u39c63['ID'].$u39c63['Stamp'].'x'); $ec6827['unsubscribe-href']=x83c8('e2m_unsubscribe', array ( '*note' => $oaad65, 'unsubscribe-email' => $oba570, 'unsubscribe-key' => $f6fd85, ) ); $a77613=$oba570; list ($rb904c,$wde7a3)=ff8c7('comment-reply-to-public',$ec6827); ua41b($a77613,$rb904c,$wde7a3,$b1a49b); } } } e2_go_to($yd58c0); die; } else { w8a40('Ошибка при изменении ответа'); i4930(); die; } } function a86f8($oaad65,$x06d4c,$mb1bc2=false){ global $r2e5d8,$_config; if(__LOG)__log('Comments: package comment <'. $x06d4c['ID'] .'>...'); if ($oaad65===null){ $oaad65=b4627($x06d4c['NoteID']); } if ($mb1bc2!==false)$ec6827['number']=$mb1bc2; $ec6827['name']=htmlspecialchars($x06d4c['AuthorName']); if (oe852()) { $ec6827['email']=htmlspecialchars($x06d4c['AuthorEmail']); if (''!=trim($x06d4c['IP'])) { $ec6827['ip']=$x06d4c['IP']; $ec6827['ip-href']=$_config['whois_service'].$ec6827['ip']; } } $ec6827['author-name']=k2640(); $ec6827['visible?'] = (bool)$x06d4c['IsVisible']; $ec6827['important?'] = (bool)$x06d4c['IsFavourite']; $ec6827['reply-visible?'] = (bool) ($x06d4c['IsVisible'] && $x06d4c['IsReplyVisible']); $ec6827['reply-important?'] = (bool)$x06d4c['IsReplyFavourite']; $ec6827['spam-suspect?'] = (bool)$x06d4c['IsSpamSuspect']; $y10a7e=array ((int)$x06d4c['Stamp'],e2_note_timezone($oaad65)); $ec6827['time']=$y10a7e; $ec6827['last-modified']=$y10a7e; if ($x06d4c['LastModified']) $ec6827['last-modified'] = array ((int)$x06d4c['LastModified'],e2_note_timezone($oaad65)); if ($x06d4c['ReplyStamp']) $ec6827['reply-time'] = array ((int)$x06d4c['ReplyStamp'],e2_note_timezone($oaad65)); if ($x06d4c['ReplyLastModified']) $ec6827['reply-last-modified'] = array ((int)$x06d4c['ReplyLastModified'],e2_note_timezone($oaad65)); if (oe852()) { $ec6827['subscriber?'] = (bool)$x06d4c['IsSubscriber']; $ec6827['new?'] = (bool)$x06d4c['IsNew']; $ec6827['first-new?']=false; if ($x06d4c['IsFavourite']) { $ec6827['important-toggle-href']=x83c8( 'e2m_comment_flag_ajax', array ('*note' => $oaad65,'comment-number' => $mb1bc2,'flag' => 'IsFavourite','value' => 0) ); } else { $ec6827['important-toggle-href']=x83c8( 'e2m_comment_flag_ajax', array ('*note' => $oaad65,'comment-number' => $mb1bc2,'flag' => 'IsFavourite','value' => 1) ); } if ($x06d4c['IsReplyFavourite']) { $ec6827['reply-important-toggle-href']=x83c8( 'e2m_comment_flag_ajax', array ( '*note' => $oaad65,'comment-number' => $mb1bc2,'flag' => 'IsReplyFavourite','value' => 0 ) ); } else { $ec6827['reply-important-toggle-href']=x83c8( 'e2m_comment_flag_ajax', array ( '*note' => $oaad65,'comment-number' => $mb1bc2,'flag' => 'IsReplyFavourite','value' => 1 ) ); } $ec6827['edit-href']=x83c8( 'e2m_comment_edit', array ('*note' => $oaad65,'comment-number' => $mb1bc2) ); $ec6827['removed-toggle-href']=x83c8( 'e2m_comment_flag_ajax', array ( '*note' => $oaad65,'comment-number' => $mb1bc2, 'flag' => 'IsVisible','value' => !$x06d4c['IsVisible'] ) ); $ec6827['removed-reply-toggle-href']=x83c8( 'e2m_comment_flag_ajax', array ( '*note' => $oaad65,'comment-number' => $mb1bc2, 'flag' => 'IsReplyVisible','value' => !$x06d4c['IsReplyVisible'] ) ); $me36ef=x83c8( 'e2m_comment_reply', array ('*note' => $oaad65,'comment-number' => $mb1bc2) ); if ($x06d4c['Reply']=='' or !$x06d4c['IsReplyVisible']) { $ec6827['reply-href']=$me36ef; } else { $ec6827['edit-reply-href']=$me36ef; } } $ec6827['text']=k154e($oaad65['FormatterID'],$x06d4c['Text'],'simple'); if ($x06d4c['IsSpamSuspect']) { $ec6827['text']=preg_replace('/\< *a +href *= *\".*?\".*?\>/is','',$ec6827['text']); $ec6827['text']=preg_replace('/\< *\/ *a *\>/is','',$ec6827['text']); $ec6827['text']=str_replace('http://','',$ec6827['text']); } $ec6827['replying?'] = (bool)false; $ec6827['replied?'] = (bool) ( (trim($x06d4c['Reply']) != '') && ($x06d4c['IsReplyVisible']) ); $ec6827['reply']=k154e($oaad65['FormatterID'],$x06d4c['Reply'],'full'); if(array_key_exists('_',$x06d4c))$ec6827['_']=$x06d4c['_']; if(__LOG)__log('Comments: done'); return $ec6827; } function vbf30($n8d777){ global $r2e5d8; $se35b1=array(); if (z0738($n8d777['query'])) { $result=t0d6b(); foreach($result as $q8ce4b => $c4032b){ if (!isset ($c4032b['Text']))$c4032b=qb559($c4032b['ID']); if ($c4032b['IsVisible'] or oe852()) { $se35b1[] = a86f8(null,$c4032b); } } } if ($n8d777['title']) { $t2cb9d['title']=$n8d777['title']; } if ($n8d777['heading']) { $t2cb9d['heading']=$n8d777['heading']; } if ($n8d777['related-rss-href']) { $t2cb9d['related-rss-href']=$n8d777['related-rss-href']; } $t2cb9d['comments']=$se35b1; return $t2cb9d; } function qb559($lb80bb){ global $r2e5d8; if (z0738( "SELECT * FROM `". $r2e5d8['db']['table_prefix']."Comments` ". "WHERE `ID` = '".$lb80bb."'" )) { $kfa816=t0d6b(); if(count($kfa816) > 0) return $kfa816[0]; else w8a40('Комментарий не найден') and i4930() and die; } else w8a40('Не удалось извлечь комментарий из базы') and i4930() and die; } function me5b6($x0604c){ e2_comment_set_flag('IsVisible',$x0604c); } function t3183($t0dd2c){ e2_comment_set_flag('IsReplyVisible',$t0dd2c); } function r66aa($oaad65){ $ve3cb9=@$_COOKIE[o8c3b('commenter_name')]; $cf92ee=@$_COOKIE[o8c3b('commenter_email')]; $r3d682=@$_COOKIE[o8c3b('commenter_ph')]; $t92399=false; if ($cf92ee and cookie_unsubscribe_key){ foreach (y4975($oaad65) as $u39c63){ $v97f69=md5($u39c63['ID'].$u39c63['Stamp'] .'x'); if ( $u39c63['AuthorEmail']==$cf92ee and $r3d682==$v97f69 ){ $t92399=true; break; } } } $g80f02=array ( '.note-id' => $oaad65['ID'], '.comment-id' => 'new', '.already-subscribed?' => (bool)$t92399, 'create:edit?' => true, 'form-action' => x83c8('e2s_comment_process'), 'submit-text' => 'Отправить', 'show-subscribe?' => (bool) !$t92399, 'subscribe?' => (bool)$t92399, 'subscription-status' => $t92399? 'Вы подписаны на комментарии. Ссылка для отписки приходит в каждом письме с новым комментарием.':'', 'visible?' => true, 'email-field-name' => 'elton-john', 'name' => htmlspecialchars($ve3cb9), 'email' => htmlspecialchars($cf92ee), 'text' => htmlspecialchars($x06d4c['Text'],ENT_NOQUOTES), ); return $g80f02; } function j254f($b21158,$edaf19=0){ global $r2e5d8; if (!$edaf19)$rf79b1=' AND `IsVisible`=1'; if ('all'===$edaf19){ $rf79b1=''; } if ('new'===$edaf19){ $rf79b1=' AND `IsNew`=1'; } $bbc751=0; if (z0738( "SELECT count(*) FROM `". $r2e5d8['db']['table_prefix']."Comments` ". "WHERE `NoteID`=". @$b21158 . @$rf79b1 )) { $result=t0d6b(); $result=(int)$result[0]['count(*)']; $bbc751=$result; } return (int)$bbc751; } function b2a6b(){ global $r2e5d8; $oe2942=0; $e7ec7e=''; $ce8fab=''; if (z0738( "SELECT `NoteID`, `Text` FROM `". $r2e5d8['db']['table_prefix']."Comments` ". "WHERE `IsNew`=1 ORDER BY `Stamp`" )) { $result=t0d6b(); $oe2942=count($result); $e7ec7e=array(); foreach($result as $vf1965){ $e7ec7e[] = strip_tags(wb7f1(str_replace("\n",' ',$vf1965['Text']), 'simple')); } $e7ec7e=implode(' &bull; ',$e7ec7e); if(strlen($e7ec7e) > 512){ $e7ec7e=substr($e7ec7e,0,509). '...'; } if ($oe2942){ $b21158=$result[0]['NoteID']; $ce8fab=x83c8( 'e2m_note', array ('*note' => b4627($b21158)) ); } else { $ce8fab=''; } } return array ((int)$oe2942,$e7ec7e,$ce8fab); } function s1baf($b21158,$b641f6){ global $r2e5d8; if (z0738( "SELECT * FROM `". $r2e5d8['db']['table_prefix']."Comments` ". "WHERE `NoteID`=". @$b21158." ". @$rf79b1 ." ". $b641f6 )) { $result=t0d6b(); return$result; } else { w8a40('Ошибка при попытке вытащить комментарии к заметке из базы'); return FALSE; } } function y4975($oaad65,$ad1cc6=''){ global $r2e5d8; $b70a17="ORDER BY `ID` DESC"; $t2cb9d=$iaf67c=array(); if (z0738( "SELECT DISTINCT `ID`, `Text`, `IsSubscriber`, `AuthorName`, `AuthorEmail`, `Stamp` ". "FROM `". $r2e5d8['db']['table_prefix']."Comments` ". "WHERE `NoteID`=". @$oaad65['ID'] ." ". "AND `IsSubscriber`=1 ". "AND `AuthorEmail`!='". mysql_escape_string($ad1cc6) ."' ". $b70a17 )) { $result=t0d6b(); foreach($result as $u39c63){ if (!in_array($u39c63['AuthorEmail'],$iaf67c)) { $t2cb9d[] = $u39c63; } $iaf67c[] = $u39c63['AuthorEmail']; } } return $t2cb9d; } function yb387($oaad65,$q3f917=NOTE_COMMENTABLE_NOW){ global $r2e5d8,$_config; $v61f40=$r2e5d8['comments']['on']; $g8f888=$oaad65['IsPublished']; $hbdb20=true; if (@$r2e5d8['comments']['fresh_only']) if (isset ($_config['comment_freshness_days'])) if ($oaad65['Stamp'] < time()-$_config['comment_freshness_days']*SECONDS_IN_A_DAY) $hbdb20=false; $mc770a=$oaad65['IsCommentable']; if ($q3f917==NOTE_COMMENTABLE_NOW_CONDITIONALLY){ $mc770a=true; } $v825ff=$oaad65['IsVisible']; return $v61f40 and $g8f888 and $hbdb20 and $mc770a and $v825ff; } function e2_commentrec_with_parameters_($parameters=array ()) { $u39a37=e2_published_noterec_with_parameters_($parameters); $ga5d49=s1baf($u39a37['ID'],"ORDER BY `Stamp`"); $c4032b=@$ga5d49[$parameters['comment-number']-1]; if ($c4032b){ $c4032b['noterec']=$u39a37; return $c4032b; } } function x1a90($f98ea6=''){ global $r2e5d8,$ycbcce,$_config,$_fp_error; $_fp_error=false; $kbe16c='elton-john'; $b21158=$u69b97=$ab0689=$z0c83f=$t1cb25=''; if(array_key_exists('note-id',$_POST)) $b21158=trim(@$_POST['note-id']); if(array_key_exists('comment-id',$_POST)) $u69b97=trim(@$_POST['comment-id']); if(array_key_exists('name',$_POST)) $ab0689=trim(@$_POST['name']); if(array_key_exists($kbe16c,$_POST)) $z0c83f=trim(@$_POST[$kbe16c]); if(array_key_exists('text',$_POST)) $t1cb25=trim(@$_POST['text']); $y07d3d=( (array_key_exists('already-subscribed',$_POST) and $_POST['already-subscribed']) or (array_key_exists('subscribe',$_POST) and $_POST['subscribe']) ); $p20612=time(); if(preg_match('//u',$ab0689))$ab0689=pedd9($ab0689,false); if(preg_match('//u',$z0c83f))$z0c83f=pedd9($z0c83f,false); if(preg_match('//u',$t1cb25))$t1cb25=pedd9($t1cb25,true); $a9d090['text']=$t1cb25; if ($u69b97=='new'){ rc64a('commenter_name',$ab0689); rc64a('commenter_email',$z0c83f); } $s848b5=( $u69b97=='new' and (array_key_exists('email',$_POST) and $_POST['email']!='') ); $pc2b1a=1; $result=false; if (!$u69b97){ $_fp_error=FP_NO_ID_OR_NEW; } else { if ($u69b97 and $ab0689=='' or $z0c83f=='' or $t1cb25==''){ $_fp_error=FP_EMPTY_FIELD; } if ($u69b97=='new'){ $l795f1=@unserialize(acdf0(USER_FOLDER. '/last-comment.psa')); if(md5($ab0689.$z0c83f.$t1cb25)==$l795f1['md5']) { $_fp_error=FP_COMMENT_DOUBLE_POST; } if ( isset ($_config['max_comment_length']) and strlen(@$_POST['text']) > ($_config['max_comment_length']) ) { $_fp_error=FP_COMMENT_TOO_LONG; } if ($u69b97=='new' and !yb387(b4627($b21158))) { $_fp_error=FP_NOT_COMMENTABLE; } if ($s848b5){ $_fp_error=FP_COMMENT_SPAM_SUSPECT; } } } if (!$_fp_error){ e2_drop_caches_for_note_($b21158); if ($u69b97=='new'){ $c4032b=array ( 'NoteID' => (int)$b21158, 'AuthorName' => h7928($ab0689), 'AuthorEmail' => h7928($z0c83f), 'Text' => h7928($t1cb25), 'IsVisible' => 1, 'IsAnswerAware' => 1, 'IsSubscriber' => (int)$y07d3d, 'IsSpamSuspect' => (int)$s848b5, 'IsNew' => (int)$pc2b1a, 'Stamp' => (int)time(), 'LastModified' => (int)time(), 'IP' => h7928($_SERVER['REMOTE_ADDR']), ); if (($c4032b=p9943('Comments',$c4032b)) !== false){ $u69b97=$c4032b['ID']; $l795f1=array ( 'id' => $u69b97, 'md5' => md5($ab0689.$z0c83f.$t1cb25), ); t6e52(USER_FOLDER. '/last-comment.psa',serialize($l795f1)); $result=(int)$u69b97; $s303ee=md5($c4032b['ID'].$c4032b['Stamp'].'x'); rc64a('commenter_ph',$s303ee); $r60422=j254f($b21158,'all')-1+1; $oaad65=b4627($b21158); $yd58c0=x83c8('e2m_note', array ('*note' => $oaad65)); $ec6827['comment-time'] = array ($p20612,e2_current_timezone()); $ec6827['commenter']=$ab0689; $ec6827['commenter-email']=$z0c83f; $ec6827['comment-text']=$t1cb25; $ec6827['note-title']=hea9c($oaad65); $ec6827['note-href']=$yd58c0; $ec6827['comment-href']=$yd58c0; $ec6827['comments-disable-href']=x83c8('e2m_note_flag', array ( '*note' => $oaad65, 'flag' => 'IsCommentable', 'value' => 0 )); $ec6827['reply-href']=x83c8( 'e2m_comment_reply', array ('*note' => $oaad65,'comment-number' => $r60422) ); if (isset ($r2e5d8['user']['email']) and @$r2e5d8['notifications']['new_comments']) { list ($rb904c,$wde7a3)=ff8c7( 'comment-new-to-author',$ec6827 ); $a77613=$r2e5d8['user']['email']; $b1a49b = 'From: '. iaed2() ."\r\n". 'Reply-to: '. $ab0689 .' <'. $z0c83f .">"; ua41b($a77613,$rb904c,$wde7a3,$b1a49b); } if (!$s848b5){ unset ($ec6827['commenter-email']); $b1a49b='From: '. iaed2(); foreach (y4975($oaad65,$z0c83f) as $u39c63){ $oba570=$u39c63['AuthorEmail']; $f6fd85=md5($u39c63['ID'].$u39c63['Stamp'].'x'); $ec6827['unsubscribe-href']=x83c8('e2m_unsubscribe', array ( '*note' => $oaad65, 'unsubscribe-email' => $oba570, 'unsubscribe-key' => $f6fd85 ) ); $a77613=$oba570; list ($rb904c,$wde7a3)=ff8c7('comment-new-to-public',$ec6827); ua41b($a77613,$rb904c,$wde7a3,$b1a49b); } } } else { $_fp_error=FP_INSERT_ERROR; } } else { $gfd6f3=array ( 'ID' => $u69b97, 'AuthorName' => $ab0689, 'AuthorEmail' => $z0c83f, 'Text' => $t1cb25, 'IsSubscriber' => ((int)$y07d3d), 'LastModified' => time(), ); if (taa79('Comments',$gfd6f3)) { $result=(int)$u69b97; } else { $_fp_error=FP_UPDATE_ERROR; }; } } if ($f98ea6=='ajaxresult') return $l1fa03; else return array ((int)$b21158,$result,$a9d090); } function e2m_most_commented(){ global $r2e5d8,$_config; $ha0acf=@$_GET['period']; if ($ha0acf=='')$ha0acf=$_config['hot_period']; $x632a2=time()-f35c3($ha0acf); $rf79b1="AND `IsVisible`=1 "; if (oe852())$rf79b1=''; return md864(array ( 'query' => "SELECT `IsVisible`, `Stamp`, `NoteID` ID, count(*) c ". "FROM `". $r2e5d8['db']['table_prefix']."Comments` ". "WHERE (`Stamp` > ". $x632a2.") ". $rf79b1. "GROUP BY `NoteID` ". "ORDER BY c ". "DESC ". "LIMIT ".$r2e5d8['appearance']['notes_per_page'], 'query-returns-only-ids' => 1, 'limit' => $r2e5d8['appearance']['notes_per_page'], 'class' => 'most-commented', 'title' => 'Самые комментируемые за '. m54aa($ha0acf), 'heading' => 'Самые комментируемые за '. m54aa($ha0acf), 'no-notes-text' => 'Таких заметок нет.', )); } function e2m_favourites($parameters=array ()) { global $r2e5d8; $rf79b1="AND `IsVisible`=1 "; if (oe852())$rf79b1=''; return md864(array ( 'query' => "SELECT * FROM `". $r2e5d8['db']['table_prefix']."Notes` ". "WHERE `IsPublished`=1 AND `IsFavourite`=1 ". $rf79b1 . "ORDER BY `Stamp` DESC", 'page' => $parameters['page'], 'candy' => 'e2m_favourites', 'parameters' => $parameters, 'class' => 'favourites', 'title' => 'Избранное', 'heading' => 'Избранное', 'no-notes-text' => 'Избранного нет.', )); } function f35c3($ha0acf){ if ('year'==$ha0acf) return SECONDS_IN_A_YEAR; elseif ('month'==$ha0acf) return SECONDS_IN_A_MONTH; elseif ('week'==$ha0acf) return SECONDS_IN_A_DAY*7; elseif ('day'==$ha0acf) return SECONDS_IN_A_DAY; else return PHP_INT_MAX; } function m54aa($ha0acf){ if ('year'==$ha0acf) return 'год'; elseif ('month'==$ha0acf) return 'месяц'; elseif ('week'==$ha0acf) return 'неделю'; elseif ('day'==$ha0acf) return 'день'; else return 'всю историю'; } function n09d1(){ global $r2e5d8,$c097cc,$_config; $ha0acf=$_config['hot_period']; if(__LOG)__log('Hot list: working...'); $ee919a=f7f78(); $ea44c0=null; if(CACHE_HOT and is_file(CACHE_FILENAME_HOT) and is_file(CACHE_FILENAME_HOT_EXPIRES)) { $ea44c0=@unserialize(acdf0(CACHE_FILENAME_HOT)); $t85e91=(int) @acdf0(CACHE_FILENAME_HOT_EXPIRES); } if(CACHE_HOT and is_array($ea44c0) and (time() < $t85e91)) { if(__LOG)__log('Hot list: retrieve cached ctree'); $cdbb0c=$ea44c0; } else { if(__LOG)__log('Hot list: assemle cacheable ctree...'); $x632a2=time()-f35c3($ha0acf); $t4358b=array(); if (z0738( "SELECT `Stamp`, `NoteID` ID, count(*) c ". "FROM `". $r2e5d8['db']['table_prefix']."Comments` ". "WHERE `Stamp` > ". $x632a2 ." ". "GROUP BY `NoteID` ". "ORDER BY c DESC LIMIT 10" )) { $result=t0d6b(); $cdbb0c=array(); foreach($result as $q8ce4b => $u39a37){ $u39a37=b4627($u39a37['ID']); if ($u39a37['IsVisible'] and $u39a37['IsPublished']) { $oaad65['_']['_id']=$u39a37['ID']; $oaad65['_']['_ord']=$q8ce4b; $oaad65['_']['_ord_max']=count($result)-1; $oaad65['href']=x83c8('e2m_note', array ('*note' => $u39a37)); $oaad65['time'] = array ($u39a37['Stamp'],e2_note_timezone($u39a37)); $oaad65['title']=q6f10(htmlspecialchars(hea9c($u39a37))); $cdbb0c[] = $oaad65; } } $ea44c0=$cdbb0c; if(CACHE_HOT){ t6e52(CACHE_FILENAME_HOT,serialize($ea44c0)); t6e52(CACHE_FILENAME_HOT_EXPIRES,time()+SECONDS_IN_A_DAY); } } } foreach ($cdbb0c as $q8ce4b => $d9e366){ $cdbb0c[$q8ce4b]['current?'] = ($cdbb0c[$q8ce4b]['href']==$c097cc); } if(__LOG)__log('Hot list: done in '. round(f7f78()-$ee919a,3)); return $cdbb0c; } function n3385(){ global $r2e5d8,$c097cc; if(__LOG)__log('Favourites list: working...'); $ee919a=f7f78(); $xffbd2=null; if(CACHE_FAVS and is_file(CACHE_FILENAME_FAVS)) { $xffbd2=@unserialize(acdf0(CACHE_FILENAME_FAVS)); } if(CACHE_FAVS and is_array($xffbd2)) { if(__LOG)__log('Favourites list: retrieve cached ctree'); $cdbb0c=$xffbd2; } else { if(__LOG)__log('Favourites list: assemle cacheable ctree...'); $cdbb0c=array(); if (z0738( "SELECT `IsPublished`, `ID`, `Title`, `Stamp`, `Offset`, `IsDST` ". "FROM `". $r2e5d8['db']['table_prefix']."Notes` ". "WHERE `IsPublished`=1 AND `IsFavourite`=1 AND `IsVisible`=1 ". "ORDER BY `Stamp` DESC" )) { $result=t0d6b(); foreach($result as $q8ce4b => $u39a37){ $oaad65['_']['_id']=$u39a37['ID']; $oaad65['_']['_ord']=$q8ce4b; $oaad65['_']['_ord_max']=count($result)-1; $oaad65['href']=x83c8('e2m_note', array ('*note' => $u39a37)); $oaad65['time'] = array ($u39a37['Stamp'],e2_note_timezone($u39a37)); $oaad65['title']=q6f10(htmlspecialchars(hea9c($u39a37))); $cdbb0c[] = $oaad65; } $xffbd2=$cdbb0c; if(CACHE_FAVS)t6e52(CACHE_FILENAME_FAVS,serialize($xffbd2)); } } foreach ($cdbb0c as $q8ce4b => $d9e366){ $cdbb0c[$q8ce4b]['current?'] = ($cdbb0c[$q8ce4b]['href']==$c097cc); } if(__LOG)__log('Favourites list: done in '. round(f7f78()-$ee919a,3)); return $cdbb0c; } function e2m_password(){ global $r2e5d8; $t2cb9d['title']='Пароль'; $t2cb9d['heading']='Пароль для доступа к блогу'; $t2cb9d['form']='form-password'; $t2cb9d['form-password'] = array ( 'form-action' => x83c8('e2s_password_save'), 'submit-text' => 'Поменять', ); return $t2cb9d; } function e2m_sessions(){ global $r2e5d8; $w2d6d8=u7785(); $t2cb9d['title']='Открытые сессии'; $t2cb9d['heading']='Открытые сессии'; $m161bc=array(); $f3c6e0=$_COOKIE[o8c3b('key')]; foreach ($w2d6d8['sessions'] as $q8ce4b => $d9e366){ $m161bc[] = array ( 'current?' => h4c49($f3c6e0)==$d9e366['key_hash'], 'opened' => array ((int)$d9e366['stamp'],e2_no_timezone()), 'ip-address' => $d9e366['remote_ip'], 'source' => ($d9e366['remote_ip']=='127.0.0.1')? 'локально':$d9e366['remote_ip'], 'title' => ucc31($d9e366['ua']), 'user-agent' => $d9e366['ua']? $d9e366['ua']:'неизвестен', ); } $m161bc=array_reverse($m161bc); $t2cb9d['sessions']['each']=$m161bc; if(count($m161bc) > 1){ $t2cb9d['form']='form-sessions'; $t2cb9d['form-sessions'] = array ( 'form-action' => x83c8('e2s_drop_other_sessions'), 'submit-text' => 'Завершить все сессии кроме текущей', ); } return $t2cb9d; } function e2m_sign_in(){ if (oe852()) { e2_go_to(x83c8('e2m_frontpage')); } else { return array (); } } function e2m_sign_out(){ $w2d6d8=u7785(); $x48bb9=-1; if(array_key_exists('sessions',$w2d6d8) and is_array($w2d6d8['sessions'])) { foreach ($w2d6d8['sessions'] as $q8ce4b => $d9e366){ $f3c6e0=$_COOKIE[o8c3b('key')]; if (h4c49($f3c6e0)==$d9e366['key_hash']) { $x48bb9=$q8ce4b; break; } } } if ($x48bb9 > -1) unset ($w2d6d8['sessions'][$x48bb9]); d1d21($w2d6d8); rc64a('key',''); i4930(); die; } function e2s_password_save(){ global $r2e5d8; $e88162=trim($_POST['password']); if ( $e88162!='' and t6e52(USER_FOLDER. '/password-hash.psa',serialize(h4c49($e88162))) ) {; w8a40('Пароль изменён'); e2_go_to(); } else { w8a40('Не получилось изменить пароль'); e2_go_to(x83c8('e2m_password')); } die; } function e2s_sign_in_necessary(){ e2_go_to(x83c8('e2m_sign_in')); die; } function e2s_sign_in(){ $w2d6d8=u7785(); if($_SERVER['REQUEST_METHOD']=='POST'){ $h5f4dc=@$_POST['password']; $z6bc8e=@$_POST['is_public_pc']; } else { $h5f4dc=@$_GET['password']; $z6bc8e=false; } if (fa8cf($h5f4dc)) { $e21d6f=array ( 'stamp' => time(), 'remote_ip' => $_SERVER['REMOTE_ADDR'], 'key_hash' => me8ed($z6bc8e), 'ua' => $_SERVER['HTTP_USER_AGENT'], ); $w2d6d8['sessions'][] = $e21d6f; } elseif(strlen(trim($h5f4dc)) > 0){ w8a40('Неправильный пароль'); } d1d21($w2d6d8); i4930(); die; } function e2s_drop_other_sessions(){ $w2d6d8=u7785(); foreach ($w2d6d8['sessions'] as $q8ce4b => $d9e366){ $f3c6e0=$_COOKIE[o8c3b('key')]; if (h4c49($f3c6e0)==$d9e366['key_hash']) { $e21d6f=$d9e366; break; } } $w2d6d8['sessions'] = array ($e21d6f); d1d21($w2d6d8); i4930(); die; } function fa8cf($h5f4dc){ $q8e9a8=@unserialize(acdf0(USER_FOLDER. '/password-hash.psa')); return (h4c49($h5f4dc)==$q8e9a8 and trim($h5f4dc)!=''); } function me8ed($e2a2a4=false){ global $r2e5d8; $f3c6e0=o2a24(); $g3f363=h4c49($f3c6e0); rc64a('key',$f3c6e0, !$e2a2a4); return $g3f363; } function oe852(){ global $f1c0b7,$r2e5d8,$_auth_sessions; if (isset ($f1c0b7)) return $f1c0b7; $f1c0b7=false; if (isset ($_COOKIE[o8c3b('key')])) { $f3c6e0=$_COOKIE[o8c3b('key')]; $w2d6d8=u7785(); $i0f83b=array(); if(array_key_exists('sessions',$w2d6d8) and is_array($w2d6d8['sessions'])) { foreach ($w2d6d8['sessions'] as $e21d6f){ $i0f83b[] = $e21d6f['key_hash']; } $_auth_sessions['count']=count($w2d6d8['sessions']); } if(1){ $f1c0b7=(bool)in_array(h4c49($f3c6e0),$i0f83b); } if (!$f1c0b7){ rc64a('key',''); } } return $f1c0b7; } function h4c49($h25d90){ if(function_exists('sha1')) { return sha1($h25d90); } else { return substr(md5($h25d90).md5(' '.$h25d90),0,40); } } function u7785(){ if(is_file(USER_FOLDER.'auth.psa')) { $w2d6d8=unserialize(@file_get_contents(USER_FOLDER.'auth.psa')); if ($w2d6d8) return $w2d6d8; } return array (); } function d1d21($w2d6d8){ return scd2d(USER_FOLDER.'auth.psa',serialize($w2d6d8)); } function uff2e(){ if ($f3c6e0=$_COOKIE[o8c3b('key')]) { return 'Cookie: '. o8c3b('key') .'='. $f3c6e0 ."\r\n"; } return ''; } function de68c($lc48ba){ $g74546=array ( 'e2m_write' => 'написать заметку', 'e2m_note_edit' => 'править заметку', 'e2m_note_finetune' => 'настраивать эту заметку', 'e2m_note_withdraw' => 'отозвать эту заметку', 'e2m_comment_edit' => 'править этот комментарий', 'e2m_comment_reply' => 'ответить на этот комментарий', 'e2m_drafts' => 'открыть черновики', 'e2m_draft' => 'открыть этот черновик', 'e2m_tag_edit' => 'править этот тег', 'e2m_name_and_author' => 'изменять название блога', 'e2m_settings' => 'настраивать блог', 'e2m_password' => 'изменять параметры безопасности', 'e2m_database' => 'изменять параметры базы данных', 'e2m_sessions' => 'просматривать сессии', ); if(array_key_exists($lc48ba,$g74546)) { return 'Чтобы '. $g74546[$lc48ba] .',<br />зайдите под своим паролем'; } else { return 'Зайдите под своим паролем'; } } function ucc31($q5269f){ if(strstr($q5269f,'iPhone')) return 'Айфон'; if(strstr($q5269f,'iPad')) return 'Айпад'; if(strstr($q5269f,'Opera'))$t2cb9d='Опера'; if(strstr($q5269f,'Firefox'))$t2cb9d='Фаерфокс'; if(strstr($q5269f,'Chrome'))$t2cb9d='Хром'; if(strstr($q5269f,'Safari') and !strstr($q5269f,'Chrome'))$t2cb9d='Сафари'; if (!$t2cb9d)$t2cb9d='Неизв.'; if(strstr($q5269f,'Macintosh')) { if ($t2cb9d)$t2cb9d.=' на Маке'; } return $t2cb9d; } function e2j_check_password(){ $q8e9a8=@unserialize(acdf0(USER_FOLDER. '/password-hash.psa')); $h5f4dc=''; if(array_key_exists('password',$_POST))$h5f4dc=$_POST['password']; if (h4c49($h5f4dc)==$q8e9a8 and trim($h5f4dc)!='') die ('password-correct'); die ('password-wrong'); } function o2a24(){ $qb04ec=''; $db8d1b='0123456789abcdef'; for ($h865c0=0; $h865c0 < 40; $h865c0++)$qb04ec.=$db8d1b{mt_rand(0,15)}; $qb04ec.=time(); $qb04ec=h4c49($qb04ec); return $qb04ec; } $_candies_installer=array ( 'e2s_build', 'e2m_install', 'e2j_check_db_config', 'e2j_list_databases', 'e2s_instantiate', 'e2s_install', 'e2s_update_perform', ); $_candies_public=array ( 'e2m_frontpage', 'e2m_frontpage_rss', 'e2m_note', 'e2m_note_comment', 'e2m_note_comments_rss', 'e2m_tags', 'e2m_tag', 'e2m_tag_rss', 'e2m_favourites', 'e2m_most_commented', 'e2m_found', 'e2m_comments', 'e2m_everything', 'e2m_year', 'e2m_month', 'e2m_day', 'e2m_unsubscribe', 'e2m_sign_out', 'e2s_sign_in', 'e2s_comment_process', 'e2s_search', 'e2j_check_password', ); $_candies_sidebarable=array ( 'e2m_frontpage', 'e2m_note', 'e2m_tags', 'e2m_tag', 'e2m_favourites', 'e2m_most_commented', 'e2m_found', 'e2m_comments', 'e2m_everything', 'e2m_year', 'e2m_month', 'e2m_day', ); $_candies_spawning=array ( 'e2m_frontpage', 'e2m_note', 'e2m_year', 'e2m_month', 'e2m_day', 'e2m_write', 'e2m_drafts', 'e2m_draft', 'e2m_name_and_author', 'e2m_settings', 'e2m_password', 'e2m_database', 'e2m_timezone', 'e2m_sessions', 'e2m_update', ); $_candies_public=array_merge($_candies_public,$_candies_installer); $_candies_unabortable=array ( ); $_candies_parents=array ( 'e2m_note' => 'e2m_tag', 'e2m_tag' => 'e2m_tags', ); $_candies_indexable=array ( 'e2m_note', ); $_candies_indexable_conditionally=array ( 'e2m_frontpage', 'e2m_tag', 'e2m_favourites', 'e2m_most_commented', 'e2m_found', 'e2m_tags', 'e2m_everything', ); define('E2_WEBSITE_HOST','blogengine.ru'); define('E2_WEBSITE','http://'. E2_WEBSITE_HOST .'/'); function e2_modes($parameters){ global $d11755,$content,$r2e5d8,$n1e2ad,$lf97aa,$h589b3,$_config,$s_addurl,$stopwatch,$_candy,$_db_error,$_candies_sidebarable; if (!is_array($parameters))$parameters=array(); if(array_key_exists('~',$parameters)) { $z71860=$parameters['~']; } $c45e8f='frontpage'; if(e2_is_installed()) { if(0){ if(__LOG)__log('Modes: archive years'); $yb2442=wcc02('start'); $x8dbc7=wcc02('end'); if (!($yb2442===false or $bd0dac===false)) { $obaab5=e2_format_dt_of_timezone('Y',$x8dbc7['stamp'],$x8dbc7['timezone']); if($_candy!='e2m_year' or $obaab5!=$content['year']) { $content['archive']['href']=x83c8('e2m_year', array ('year' => $obaab5)); } $content['archive']['years'] = array (); for ($h865c0=e2_format_dt_of_timezone('Y',$yb2442['stamp'],$yb2442['timezone']); $h865c0 <= $obaab5; ++ $h865c0){ $content['archive']['years'][] = array ( 'year' => $h865c0, 'href' => x83c8('e2m_year', array ('year' => $h865c0)), 'current?' => ((bool) ($content['year']==$h865c0) && ($_candy=='e2m_year')), ); } } } $content['content-page?']=false; if(in_array($_candy,$_candies_sidebarable)) { $content['content-page?']=true; if(__LOG)__log('Modes: favourites block'); $q8d029=n3385(); if(count($q8d029) > 0){ $content['favourites'] = array ( 'title' => 'Избранное', 'href' => x83c8('e2m_favourites'), ); if (@$r2e5d8['appearance']['favourites_frontpage']) { $content['favourites']['each']=$q8d029; } } if(__LOG)__log('Modes: hot block'); $r2888a=n09d1(); if(count($r2888a) > 0){ $content['most-commented'] = array ( 'title' => 'Обсуждаемое', 'href' => x83c8('e2m_most_commented'), ); if ((@$r2e5d8['appearance']['hot_frontpage'])) { $content['most-commented']['each']=$r2888a; } } if(__LOG)__log('Modes: tags block'); if(count(o3873()) > 0){ $content['tags-menu']['each']=paf16($parameters); $content['tags-menu']['not-empty?']=count($content['tags-menu']['each']); } } if (oe852()) { $content['blog']['drafts-count'] = (int)h8ca0(false,true); $content['admin-hrefs'] = array ( 'new-note' => x83c8('e2m_write'), 'drafts' => x83c8('e2m_drafts'), 'name-and-author' => x83c8('e2m_name_and_author'), 'settings' => x83c8('e2m_settings'), 'password' => x83c8('e2m_password'), 'database' => x83c8('e2m_database'), 'timezone' => x83c8('e2m_timezone'), 'sessions' => x83c8('e2m_sessions'), 'update' => x83c8('e2m_update'), 'logout' => x83c8('e2m_sign_out'), ); } else { $content['form-login']['form-action']=x83c8('e2s_sign_in'); $content['form-login']['form-check-password-action']=x83c8('e2j_check_password'); $content['form-login']['login-name'] = @$r2e5d8['author']; $content['form-login']['public-pc?']=false; if(array_key_exists('_login_request_message',$content)) { $content['form-login']['request']=$content['_login_request_message']; } } } if (@$_config['request_logging']) { $o8fa14=fopen(USER_FOLDER. 'log-'. date('Y-m-d') .'.txt','a'); fwrite($o8fa14,date('d.m.Y H:i:s') ."\tT = ". $content['pgt'] ."\tQ = ". $content['total_queries'] ."\tIP = ". $_SERVER['REMOTE_ADDR'] ."\tRequest = ". $_SERVER['REQUEST_URI'] ."\r\n"); fclose($o8fa14); } } function r6f51(){ global $r2e5d8; if ( array_key_exists('site_title',$r2e5d8) and trim($r2e5d8['site_title']) != '' ){ return trim($r2e5d8['site_title']); } else { return DEFAULT_BLOG_TITLE; } } function k2640(){ global $r2e5d8; if ( array_key_exists('author',$r2e5d8) and trim($r2e5d8['author']) != '' ){ return trim($r2e5d8['author']); } else { return DEFAULT_BLOG_AUTHOR; } } function ba208(){ if ( ((bool)ini_get('magic_quotes_gpc')) or ((bool)ini_get('magic_quotes_runtime')) or ((bool)ini_get('magic_quotes_sybase')) ) { if ((bool)ini_get('magic_quotes_gpc'))$o8fa14[] = 'magic_quotes_gpc'; if ((bool)ini_get('magic_quotes_runtime'))$o8fa14[] = 'magic_quotes_runtime'; if ((bool)ini_get('magic_quotes_sybase'))$o8fa14[] = 'magic_quotes_sybase'; echo '<big style="background: #a00; color: #ccc; padding: .1em .33em">FUCK_MAGIC_QUOTES</big><br /><br />'; echo '<b>Please ask your hosting support for assistance disabling magic quotes functionality.</b><br />'; echo 'Magic quotes features detected: <i>'. implode(', ',$o8fa14). '</i><br />'; die; } } function r8e95(){ if ((strpos($_SERVER['SERVER_SOFTWARE'],'Apache')===0) and !is_file('.htaccess')) { if(is_file('htaccess')) { if (@rename('htaccess','.htaccess')) { e2_go_to(); } } echo 'Looks like you are using Apache and have lost or forgot to put in place "htaccess" file. Please obtain it from E2 installation package and put into your installation directory.'; die; } } function e2m_frontpage($parameters=array ()) { global $r2e5d8,$a5c4a6, $_config; $z71860=$parameters['page']; $jd7e5d=$r2e5d8['appearance']['notes_per_page']; $z06d2e=h8ca0(true,true); if (oe852())$z06d2e+=h8ca0(true,false); $mae0fe=ceil($z06d2e/$jd7e5d); $nd29bb=CACHE_FILENAME_FRONTPAGE; if (oe852())$nd29bb=CACHE_FILENAME_FRONTPAGE_AUTHOR; if(CACHE_FRONTPAGE and $z71860==1 and is_file($nd29bb)) { $t4358b=@unserialize(acdf0($nd29bb)); } if(CACHE_FRONTPAGE and $z71860==1 and is_array($t4358b)) { } else { if (($result=e50d7('web',$z71860)) === false){ w8a40('Невозможно отобразить последние заметки'); return array ( 'title' => htmlspecialchars(r6f51(),ENT_NOQUOTES), ); } $t4358b=array(); if(count($result) > 0){ foreach($result as $q8ce4b => $oaad65){ $oaad65['_']['_id']=$oaad65['ID']; $oaad65['_']['_title']=hea9c($oaad65); $oaad65['_']['_ord']=$q8ce4b; $oaad65['_']['_ord_max']=count($result)-1; $ge244c=l6791($oaad65); $t4358b[] = $ge244c; } } else { if ($z71860!=1) return e2_error404_mode(); } if(CACHE_FRONTPAGE and $z71860==1)t6e52($nd29bb,serialize($t4358b)); } $ib3b32['numbered']=true; $ib3b32['count']=$mae0fe; $ib3b32['this'] = (int)$z71860; if ($mae0fe > 0){ if ($z71860 > 1)$a5c4a6['navigation_links']['prev'] = x83c8('e2m_frontpage', array ('page' => $z71860-1)); if ($z71860 < $mae0fe)$a5c4a6['navigation_links']['next'] = x83c8('e2m_frontpage', array ('page' => $z71860+1)); if ($z71860 > $mae0fe){ $a5c4a6['navigation_links']['prev'] = $a5c4a6['navigation_links']['next'] = x83c8('e2m_frontpage', array ('page' => $mae0fe)); } if (@$_config['invert_prevnext_order']) { $s3d801=$a5c4a6['navigation_links']['next']; $a5c4a6['navigation_links']['next']=$a5c4a6['navigation_links']['prev']; $a5c4a6['navigation_links']['prev']=$s3d801; $ib3b32['title']='Заметки'; $ib3b32['prev-title']='<a>предыдущие</a>'; $ib3b32['next-title']='<a>следующие</a>'; } else { $ib3b32['title']='Заметки'; $ib3b32['prev-title']='<a>следующие</a>'; $ib3b32['next-title']='<a>предыдущие</a>'; } } if ($a5c4a6['navigation_links']['prev']) $ib3b32['prev-href']=$a5c4a6['navigation_links']['prev']; if ($a5c4a6['navigation_links']['next']) $ib3b32['next-href']=$a5c4a6['navigation_links']['next']; $e05df2=r6f51(); $wd5d3d=''; if(1==$z71860 and @$t4358b[0]['_']['_title']) { $wd5d3d=$e05df2 .': '. $t4358b[0]['_']['_title']; } elseif (@$t4358b[0]['_']['_title']) { $wd5d3d=$t4358b[0]['_']['_title']; } else { $wd5d3d=$e05df2; } return array ( 'frontpage?' => (bool) ($z71860==1), 'title' => $wd5d3d, 'notes' => $t4358b, 'pages' => $ib3b32, ); } function e2m_frontpage_rss($parameters=array ()) { global $r2e5d8; $i8bb85=''; $if0e70=0; if (($result=e50d7('rss')) !== false){ foreach($result as $oaad65){ if ($oaad65['IsVisible']) { $i8bb85.=i307d($oaad65); $if0e70=max($if0e70,$oaad65['Stamp']); } } } qd371( CACHE_FILENAME_FRONTPAGE_RSS,$i8bb85,$if0e70, $r2e5d8['site_title'], x83c8('e2m_frontpage') ); die; } function e2m_note_comments_rss($parameters=array ()) { global $r2e5d8,$_config; $oaad65=e2_published_noterec_with_parameters_($parameters); $if0e70=0; if ( ($result=s1baf($oaad65['ID'],"AND `Stamp` > ". (time()-SECONDS_IN_A_MONTH) ." ORDER BY `Stamp` DESC LIMIT ". $_config['rss_items'])) !== false ){ foreach($result as $x06d4c){ if ($x06d4c['IsVisible'] and !$x06d4c['IsSpamSuspect']) { $i8bb85.=kc6e2($oaad65,$x06d4c); $if0e70=max($if0e70,$x06d4c['Stamp']); } } } qd371( '',$i8bb85,$if0e70, $r2e5d8['site_title'] .', комментарии к заметке: '. $oaad65['Title'], x83c8('e2m_note', array ('*note' => $oaad65)) ); die; } function e2m_tag_rss($parameters=array ()) { global $r2e5d8,$_config; if(array_key_exists('_tagrec',$parameters)) { $fe4d23=$parameters['_tagrec']; } else { return e2_error404_mode(); } $p56790[] = ( "`". $r2e5d8['db']['table_prefix'] . "NotesKeywords`.KeywordID=". $fe4d23['ID'] ); $p56790=implode(' OR ',$p56790); $ic2b7b=$r2e5d8['db']['table_prefix']; return xcbfb( "INNER JOIN `". $ic2b7b."NotesKeywords` ". "ON `". $ic2b7b."NotesKeywords`.NoteID=`". $ic2b7b."Notes`.ID ". "WHERE (". $p56790 .") ". "ORDER BY `". $ic2b7b ."Notes`.`Stamp` DESC LIMIT ". $_config['rss_items'], $r2e5d8['site_title'] .', заметки с тегом: '. $fe4d23['Keyword'], x83c8('e2m_tag',$parameters) ); } function e2m_found_rss($parameters=array ()) { global$_config,$r2e5d8; $parameters['query']=pedd9(trim($parameters['query'])); $g1b1cc=$parameters['query']; return xcbfb( "WHERE MATCH (`Title`, `Text`) AGAINST ('".h7928(preg_quote($g1b1cc))."') ORDER BY `Stamp` DESC LIMIT ". $_config['rss_items'], $r2e5d8['site_title'] .', результаты поиска: '. $g1b1cc, x83c8('e2m_found',$parameters) ); } function xcbfb($g15c46,$wd5d3d,$t2a304){ global $r2e5d8; $i8bb85=''; $if0e70=0; if ((z0738( "SELECT `". $r2e5d8['db']['table_prefix']."Notes`.* ". "FROM `". $r2e5d8['db']['table_prefix']."Notes` ". $g15c46 )) !== false){ $result=t0d6b(); foreach($result as $oaad65){ if ($oaad65['IsVisible']) { $i8bb85.=i307d($oaad65); $if0e70=max($if0e70,$oaad65['Stamp']); } } } qd371( '',$i8bb85,$if0e70, $wd5d3d, $t2a304 ); die; } function x3010($wd5d3d,$ce8fab){ global $a5c4a6; $q336a4=array ('title' => $wd5d3d,'href' => $ce8fab); $a5c4a6['newsfeeds'][] = $q336a4; } function i307d($oaad65){ global $r2e5d8,$a57de2; $f90141=x83c8('e2m_note', array ('*note' => $oaad65)); $p59aeb=hce23($oaad65['ID']); foreach ($p59aeb as $h865c0 => $ld7df5){ $p59aeb[$h865c0] = ( '<a href="'. x83c8('e2m_tag', array ('tag-urlname' => $ld7df5['URLName'])). '">'. htmlspecialchars($ld7df5['Keyword'],ENT_NOQUOTES). '</a>' ); } $i8bb85=''; $i8bb85.='<item>'; $i8bb85.='<title>'. (htmlspecialchars(hea9c($oaad65),ENT_NOQUOTES)) .'</title>'; $i8bb85.='<guid isPermaLink="true">'. $f90141 .'</guid>'; $i8bb85.='<link>'. $f90141 .'</link>'; if (@$r2e5d8['comments']['on']) { $i8bb85.='<comments>'. $f90141 .'</comments>'; } $r67daf=k154e($oaad65['FormatterID'], @$oaad65['Text'],'full'); $l8e238[] = '<small>'.implode(', ',$p59aeb).'</small>'; if (@$l8e238){ $r67daf.='<hr />'. implode('<br /><br />',$l8e238); } $i8bb85.='<description>'; $i8bb85.=htmlspecialchars($r67daf,ENT_NOQUOTES); $i8bb85.='</description>'; $j588e0 = e2_format_dt_of_current_timezone('D, d M Y H:i:s ',$oaad65['Stamp']) . e2_timezone_gmt_offset_of_current_timezone_rfc2822($oaad65['Stamp']); $i8bb85.='<pubDate>'. $j588e0 .'</pubDate>'; $i8bb85.='</item>'; return $i8bb85; } function kc6e2($oaad65,$x06d4c){ global $r2e5d8,$a57de2; $f90141=x83c8('e2m_note', array ('*note' => $oaad65)); $i0ad4f = '<b>'. htmlspecialchars($x06d4c['AuthorName'],ENT_NOQUOTES) .'</b>, комментарий к заметке <a href="'. $f90141 .'">"'. q6f10(htmlspecialchars(hea9c($oaad65),ENT_NOQUOTES)) .'"</a>'; $i8bb85=''; $i8bb85.='<item>'; $i8bb85.='<title>'. strip_tags($i0ad4f) .'</title>'; $i8bb85.='<link>'. $f90141 .'</link>'; $r67daf=$i0ad4f.':'; $r67daf.='<br /><br />'; $i64be6=k154e($oaad65['FormatterID'],$x06d4c['Text'],'simple'); $r67daf.=$i64be6; $i8bb85.='<description>'; $i8bb85.=htmlspecialchars($r67daf,ENT_NOQUOTES); $i8bb85.='</description>'; $j588e0 = e2_format_dt_of_current_timezone('D, d M Y H:i:s ',$x06d4c['Stamp']) . e2_timezone_gmt_offset_of_current_timezone_rfc2822($x06d4c['Stamp']); $i8bb85.='<pubDate>'. $j588e0 .'</pubDate>'; $i8bb85.='</item>'; return $i8bb85; } function qd371($w1cd44,$f691d5,$if0e70,$wd5d3d,$t2a304){ global $r2e5d8; $i8bb85 = '<?xml version="1.0" encoding="utf-8"?>'. '<rss version="2.0">'. '<channel><title>'. htmlspecialchars($wd5d3d,ENT_NOQUOTES) .'</title>'. '<link>'. $t2a304 .'</link>'. '<description>'.'</description>'. '<language>'. RSS_LANGUAGE .'</language>'. '<generator>e2 ('. E2_WEBSITE .')</generator>'. $f691d5. '</channel>'. '</rss>'; $i54870=gmdate('r',$if0e70); $b1872a=md5($if0e70); header('Content-type: application/xml; charset=utf-8'); header('Last-modified: '.$i54870); header('Etag: '.$b1872a); header('Cache-Control: public'); header('Expires: '. date('r',$if0e70+SECONDS_IN_A_DAY)); $w0c3cd=isset($_SERVER['HTTP_IF_MODIFIED_SINCE'])? stripslashes($_SERVER['HTTP_IF_MODIFIED_SINCE']): false; $mc3522=isset($_SERVER['HTTP_IF_NONE_MATCH'])? stripslashes($_SERVER['HTTP_IF_NONE_MATCH']): false; if ( !$w0c3cd && !$mc3522 or $mc3522 && $mc3522!=$b1872a or $w0c3cd && $w0c3cd!=$i54870 ){ $i8bb85=ufd97($i8bb85); if (!empty ($w1cd44) and !oe852()) { t6e52($w1cd44,$i8bb85); } echo $i8bb85; } else { header('HTTP/1.1 304 Not Modified'); } return true; } function e2m_year($parameters=array ()) { global $r2e5d8; $h84cdc=$parameters['year']; $c09d6c=''. $h84cdc .' год'; if (!t1665($h84cdc)) { return e2_error404_mode(); } $ve6e7d=gmmktime(0,0,0,1,1,$h84cdc-1); $p029bd=gmmktime(0,0,0,1,1,$h84cdc+1); list ($i8aebd,$m5a7f3)=e2__fruitful_neighbours_with_ymd_($h84cdc); $ta6d40='e2m_year'; if ($i8aebd){ $ib3b32['prev-href']=x83c8( $ta6d40,e2__parameters_with_timestamp_($i8aebd) ); $ib3b32['prev-jump?'] = (bool) (gmdate('Y',$ve6e7d)!=gmdate('Y',$i8aebd)); $ib3b32['prev-title']='<a>'. gmdate('Y',$i8aebd) .'</a>'; } if ($m5a7f3){ $ib3b32['next-href']=x83c8( $ta6d40,e2__parameters_with_timestamp_($m5a7f3) ); $ib3b32['next-jump?'] = (bool) (gmdate('Y',$p029bd)!=gmdate('Y',$m5a7f3)); $ib3b32['next-title']='<a>'. gmdate('Y',$m5a7f3) .'</a>'; } $ib3b32['numbered?']=false; $ib3b32['title']='Годы'; $ib3b32['this']=$h84cdc; $ib3b32['this-title']=$h84cdc; $yb2442=wcc02('start'); $x8dbc7=wcc02('end'); if ( $h84cdc==e2_format_dt_of_timezone('Y',$yb2442['stamp'],$yb2442['timezone']) ) { $vfa098=e2_format_dt_of_timezone('m',$yb2442['stamp'],$yb2442['timezone']); } else { $vfa098=1; } if ( $h84cdc==e2_format_dt_of_current_timezone('Y',time()) ) { $pfd384=e2_format_dt_of_current_timezone('m',time()); } else { $pfd384=12; } $r6eac3=tb92c($h84cdc); for ($t7436f=1; $t7436f <= 12; ++ $t7436f){ $f7f769=gmmktime(0,0,0,$t7436f,1,$h84cdc); $jd039b[$t7436f] = array ( 'number' => $t7436f, 'start-time' => array ($f7f769,e2_no_timezone()), 'href' => gmdate('Y/m/',$f7f769), 'real?' => $t7436f >= $vfa098 and $t7436f <= $pfd384, 'fruitful?' => @in_array(gmdate('n',$f7f769),$r6eac3), ); } list ($d7b314,$ca1f20)=e2_boundaries_worldwide($h84cdc); z0738( "SELECT * FROM `". $r2e5d8['db']['table_prefix']."Notes` ". "WHERE `IsPublished` = 1 AND `IsVisible` = 1 ". "AND `Stamp` BETWEEN ". $d7b314 ." ". "AND ". $ca1f20 ." ". "ORDER BY `Stamp`" ); $result=t0d6b(); $t4358b=s28df($result,$h84cdc); return array ( 'title' => $c09d6c, 'heading' => $c09d6c, 'pages' => $ib3b32, 'year' => (int)$h84cdc, 'year-months' => $jd039b, 'notes-list' => $t4358b, ); } function e2m_month($parameters=array ()) { global $r2e5d8; $h84cdc= $parameters['year']; $t7436f=$parameters['month']; $f1a560=e2_ru_month_nominative($t7436f); $c09d6c=$f1a560 .' '. $h84cdc.' года'; if (!t1665($h84cdc,$t7436f)) { return e2_error404_mode(); } $ve6e7d=gmmktime(0,0,0,$t7436f-1,1,$h84cdc); $p029bd=gmmktime(0,0,0,$t7436f+1,1,$h84cdc); list ($i8aebd,$m5a7f3)=e2__fruitful_neighbours_with_ymd_($h84cdc,$t7436f); $ta6d40='e2m_month'; if ($i8aebd){ $ib3b32['prev-href']=x83c8( $ta6d40,e2__parameters_with_timestamp_($i8aebd) ); $ib3b32['prev-jump?'] = (bool) (gmdate('Y/m',$ve6e7d)!=gmdate('Y/m',$i8aebd)); $ib3b32['prev-title'] = '<a>'. strtolower(e2_ru_month_nominative(gmdate('n',$i8aebd))) .' '. gmdate('Y',$i8aebd) .'-го</a>'; } if ($m5a7f3){ $ib3b32['next-href']=x83c8( $ta6d40,e2__parameters_with_timestamp_($m5a7f3) ); $ib3b32['next-jump?'] = (bool) (gmdate('Y/m',$p029bd)!=gmdate('Y/m',$m5a7f3)); $ib3b32['next-title'] = '<a>'. strtolower(e2_ru_month_nominative(gmdate('n',$m5a7f3))) .' '. gmdate('Y',$m5a7f3) .'-го</a>'; } $ib3b32['numbered?']=false; $ib3b32['title']='Месяцы'; $ib3b32['this-title']=$c09d6c; list ($d7b314,$ca1f20)=e2_boundaries_worldwide($h84cdc,$t7436f); z0738( "SELECT * FROM `". $r2e5d8['db']['table_prefix']."Notes` ". "WHERE `IsPublished` = 1 AND `IsVisible` = 1 ". "AND `Stamp` BETWEEN ". $d7b314 ." ". "AND ". $ca1f20 ." ". "ORDER BY `Stamp`" ); $result=t0d6b(); $t4358b=s28df($result,$h84cdc,$t7436f); $se70c4['title']=$c09d6c; $se70c4['heading']=$c09d6c; $se70c4['pages']=$ib3b32; $se70c4['year'] = (int)$h84cdc; $se70c4['month'] = (int)$t7436f; $se70c4['month-days']=e2_pack_month_days_with_ymd_($h84cdc,$t7436f,false); $se70c4['notes-list']=$t4358b; return $se70c4; } function e2m_day($parameters=array ()) { $h84cdc= (int)$parameters['year']; $t7436f=(int)$parameters['month']; $r628b7= (int)$parameters['day']; if (!(t1665($h84cdc,$t7436f,$r628b7))) { return e2_error404_mode(); } $c09d6c=$r628b7 .' '. e2_ru_month_genitive($t7436f) .' '. $h84cdc; $ve6e7d=gmmktime(0,0,0,$t7436f,$r628b7-1,$h84cdc); $p029bd=gmmktime(0,0,0,$t7436f,$r628b7+1,$h84cdc); list ($i8aebd,$m5a7f3)=e2__fruitful_neighbours_with_ymd_($h84cdc,$t7436f,$r628b7); $ta6d40='e2m_day'; if ($i8aebd){ $ib3b32['prev-href']=x83c8( $ta6d40,e2__parameters_with_timestamp_($i8aebd) ); $ib3b32['prev-jump?'] = (bool) (gmdate('Y/m/d',$ve6e7d)!=gmdate('Y/m/d',$i8aebd)); $ib3b32['prev-title']='<a>'. gmdate('j',$i8aebd) .' '. e2_ru_month_genitive(gmdate('n',$i8aebd)) .' '. gmdate('Y',$i8aebd). '</a>'; } if ($m5a7f3){ $ib3b32['next-href']=x83c8( $ta6d40,e2__parameters_with_timestamp_($m5a7f3) ); $ib3b32['next-jump?'] = (bool) (gmdate('Y/m/d',$p029bd)!=gmdate('Y/m/d',$m5a7f3)); $ib3b32['next-title']='<a>'. gmdate('j',$m5a7f3) .' '. e2_ru_month_genitive(gmdate('n',$m5a7f3)) .' '. gmdate('Y',$m5a7f3) .'</a>'; } $ib3b32['numbered?']=false; $ib3b32['title']='Дни'; $ib3b32['this-title']=$c09d6c; if (($result=wf9fb($h84cdc,$t7436f,$r628b7)) !== false){ $result=array_reverse($result); foreach($result as $q8ce4b => $oaad65){ if ($oaad65['IsVisible'] or oe852()) { $oaad65['_']['_id']=$oaad65['ID']; $oaad65['_']['_ord']=k; $oaad65['_']['_ord_max']=count($result)-1; $t4358b[] = l6791($oaad65); } } } $se70c4['title']=$c09d6c; $se70c4['heading']=$c09d6c; $se70c4['pages']=$ib3b32; $se70c4['notes']=$t4358b; $se70c4['month-days']=e2_pack_month_days_with_ymd_($h84cdc,$t7436f,$r628b7); return $se70c4; } function e2m_everything($parameters=array ()) { global $r2e5d8; $t4358b=null; if(CACHE_FULLLIST and is_file(CACHE_FILENAME_FULLLIST)) { $t4358b=@unserialize(acdf0(CACHE_FILENAME_FULLLIST)); if(__LOG)__log('Everything: retrieving from cache...'); } if (!is_array($t4358b)) { if(__LOG)__log('Everything: retrieving from database...'); z0738( "SELECT * FROM `". $r2e5d8['db']['table_prefix']."Notes` ". "WHERE `IsPublished` = 1 AND `IsVisible` = 1 ". "ORDER BY `Stamp`" ); $result=t0d6b(); if(__LOG)__log('Everything: preparing notes list...'); $t4358b=s28df($result); if(__LOG)__log('Everything: saving cache...'); if(CACHE_FULLLIST)t6e52(CACHE_FILENAME_FULLLIST,serialize($t4358b)); } $q1f525=count($t4358b); $c09d6c=tace2($q1f525 .' замет(ка,ки,ок)'); if(array_key_exists('part',$_GET) and array_key_exists('of',$_GET)) { if(__LOG)__log('Everything: splitting into parts...'); $mf4c93=$_GET['part']; $h8bf88=$_GET['of']; $c09d6c.=' (часть '. $mf4c93 .' из '. $h8bf88 .')'; $w895e3=$q1f525/$h8bf88; $sd98a0=($mf4c93-1)*$w895e3; $x01b6e=$mf4c93*$w895e3; $t4358b=array_slice($t4358b,round($sd98a0),round($x01b6e-round($sd98a0))); } if(__LOG)__log('Everything: done, returning'); return array ( 'class' => 'everything', 'title' => $c09d6c, 'heading' => $c09d6c, 'notes-list' => $t4358b, ); } function e2_pack_month_days_with_ymd_($h84cdc,$t7436f,$r628b7){ $ra6933=e2_format_dt_of_timezone('t',gmmktime(0,0,0,$t7436f,1,$h84cdc),e2_no_timezone()); $yb2442=wcc02('start'); $x8dbc7=wcc02('end'); if ( $h84cdc .'/'. $t7436f == e2_format_dt_of_timezone('Y/n',$yb2442['stamp'],$yb2442['timezone']) ) { $e42eb4=e2_format_dt_of_timezone('d',$yb2442['stamp'],$yb2442['timezone']); } else { $e42eb4=1; } if ( $h84cdc .'/'. $t7436f == e2_format_dt_of_current_timezone('Y/n',time()) ) { $fd5f50=e2_format_dt_of_current_timezone('d',time()); } else { $fd5f50=$ra6933; } $qe4602=y82dc($h84cdc,$t7436f); for ($h865c0=1; $h865c0 <= $ra6933; ++ $h865c0){ $f7f769=gmmktime(0,0,0,$t7436f,$h865c0,$h84cdc); $o271c1[$h865c0] = array ( 'number' => $h865c0, 'start-time' => array ($f7f769,e2_no_timezone()), 'href' => gmdate('Y/m/d/',$f7f769), 'this?' => (bool) ($h865c0==$r628b7), 'real?' => $h865c0 >= $e42eb4 and $h865c0 <= $fd5f50, 'fruitful?' => @in_array(gmdate('d',$f7f769),$qe4602), ); } return $o271c1; } function t1665($h84cdc,$t7436f=false,$r628b7=false){ $yb2442=wcc02('start'); if ($yb2442===false){ return false; } $kc1f1e=e2_format_dt_of_timezone('Y',$yb2442['stamp'],$yb2442['timezone']); $oebeb3=e2_format_dt_of_current_timezone('Y',time()); if ($t7436f===false){ return (bool) ( $h84cdc >= $kc1f1e and $h84cdc <= $oebeb3 ); } else { $p782fc=e2_format_dt_of_timezone('n',$yb2442['stamp'],$yb2442['timezone']); $g13dd1=e2_format_dt_of_current_timezone('n',time()); if ($r628b7===false){ return (bool) ( $t7436f >= 1 and $t7436f <= 12 and ( ($h84cdc > $kc1f1e and $h84cdc < $oebeb3) or ($h84cdc==$kc1f1e and $t7436f >= $p782fc) or ($h84cdc==$oebeb3 and $t7436f <= $g13dd1) ) ); } else { $a7a9c0=e2_format_dt_of_timezone('j',$yb2442['stamp'],$yb2442['timezone']); $x23209=e2_format_dt_of_current_timezone('j',time()); if(1){ return (bool) ( checkdate($t7436f,$r628b7,$h84cdc) and ( ($h84cdc > $kc1f1e and $h84cdc < $oebeb3) or ($h84cdc==$kc1f1e and $t7436f > $p782fc) or ($h84cdc==$kc1f1e and $t7436f==$p782fc and $r628b7 >= $a7a9c0) or ($h84cdc==$oebeb3 and $t7436f < $g13dd1) or ($h84cdc==$oebeb3 and $t7436f==$g13dd1 and $r628b7 <= $x23209) ) ); } } } } function e2__fruitful_neighbours_with_ymd_($m41529,$n6f8f5=false,$s8277e=false){ global $r2e5d8,$u3afe6; list ($i3d2fa,$v9468c)=e2_boundaries_worldwide($m41529,$n6f8f5,$s8277e); $nada4b=SECONDS_IN_A_DAY; if ($s8277e===false)$nada4b=SECONDS_IN_A_MONTH; if ($n6f8f5===false)$nada4b=SECONDS_IN_A_YEAR; if (!oe852())$rf79b1="`IsVisible`=1 AND "; if (q0f7c()) { $u3afe6['result']=mysql_query( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $r2e5d8['db']['table_prefix']. "Notes` ". "WHERE `IsPublished`=1 AND " .@$rf79b1. "Stamp < '". ($v9468c-$nada4b) ."' ". "ORDER BY Stamp DESC", $u3afe6['link'] ); while ($m6438c=@mysql_fetch_array($u3afe6['result'],MYSQL_ASSOC)) { list ($h84cdc,$t7436f,$r628b7)=explode('/', e2_format_dt_of_timezone('Y/n/j',$m6438c['Stamp'],e2_note_timezone($m6438c)) ); $r7474d=$m41529*10000 + ($n6f8f5? ($n6f8f5*100):0) + ($s8277e? $s8277e:0); $ibd8da=$h84cdc*10000 + ($n6f8f5? ($t7436f*100):0) + ($s8277e? $r628b7:0); if ($ibd8da < $r7474d){ $gbf025=gmmktime(0,0,0,$t7436f,$r628b7,$h84cdc); break; } } $u3afe6['result']=mysql_query( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $r2e5d8['db']['table_prefix']. "Notes` ". "WHERE `IsPublished`=1 AND " .@$rf79b1. "Stamp > '". ($i3d2fa+$nada4b) ."' ". "ORDER BY Stamp", $u3afe6['link'] ); while ($m6438c=@mysql_fetch_array($u3afe6['result'],MYSQL_ASSOC)) { list ($h84cdc,$t7436f,$r628b7)=explode('/', e2_format_dt_of_timezone('Y/n/j',$m6438c['Stamp'],e2_note_timezone($m6438c)) ); $r7474d=$m41529*10000 + ($n6f8f5? ($n6f8f5*100):0) + ($s8277e? $s8277e:0); $ibd8da=$h84cdc*10000 + ($n6f8f5? ($t7436f*100):0) + ($s8277e? $r628b7:0); if ($ibd8da > $r7474d){ $n8dc98=gmmktime(0,0,0,$t7436f,$r628b7,$h84cdc); break; } } return array ($gbf025,$n8dc98); } } function e2__parameters_with_timestamp_($z96b8c){ list ( $parameters['year'], $parameters['month'], $parameters['day'] ) = explode('/',gmdate('Y/m/d',$z96b8c)); return$parameters; } function s28df($oc2d18,$h84cdc=false,$t7436f=false){ $g229c3=0; $t4358b=array(); $xf09d8=''; $t4358b=array(); foreach ($oc2d18 as $q8ce4b => $u39a37){ $xa88c7=e2_format_dt_of_timezone( 'Y/m/d',$u39a37['Stamp'],e2_note_timezone($u39a37) ); if ($xa88c7!=$xf09d8)$g229c3=0; $xf09d8=$xa88c7; ++ $g229c3; list ($m41529,$n6f8f5,$s8277e)=explode('/',$xa88c7); $oaad65['href']=x83c8('e2m_note', array ( 'year' => $m41529, 'month' => $n6f8f5, 'day' => $s8277e, 'day-number' => $g229c3, )); $oaad65['time'] = array ((int)$u39a37['Stamp'],e2_note_timezone($u39a37)); $oaad65['last-modified'] = array ((int)$u39a37['LastModified'],e2_note_timezone($u39a37)); $oaad65['favourite?'] = (bool) ($u39a37['IsFavourite'] && $u39a37['IsPublished']); $oaad65['title']=htmlspecialchars(hea9c($u39a37),ENT_NOQUOTES); if ( ($h84cdc and $t7436f and ( ((int)$h84cdc) .'/'. ((int)$t7436f) == e2_format_dt_of_timezone('Y/n',$u39a37['Stamp'],e2_note_timezone($u39a37)) )) or ($h84cdc and !$t7436f and ( (int)$h84cdc == e2_format_dt_of_timezone('Y',$u39a37['Stamp'],e2_note_timezone($u39a37)) )) or (!$h84cdc and !$t7436f) ) { array_unshift($t4358b,$oaad65); } } return $t4358b; } function qdefb($mb1bc2,$g151be,$n418f6=true,$dddef8=true){ if (!is_array($g151be))$g151be=explode('|',$g151be); $sc78bd=array (2,0,1,1,1,2,2,2,2,2); if ($mb1bc2%100 > 10 && $mb1bc2%100 < 20)$ecd14c=2; else $ecd14c=$sc78bd[$mb1bc2%10]; $wd5d3d=$g151be[$ecd14c]; if ($wd5d3d{0} != '-')$wd5d3d=' '. $wd5d3d; if (!$dddef8 and $mb1bc2==1)$mb1bc2=''; if ($n418f6)$wd5d3d=$mb1bc2.$wd5d3d; return $wd5d3d; } function e6b8c($l435ed){ $v599dc=qfd08($l435ed); if ($v599dc==1 and function_exists('imagecreatefromgif')) return array (imagecreatefromgif($l435ed),'gif'); elseif ($v599dc==2 and function_exists('imagecreatefromjpeg')) return array (imagecreatefromjpeg($l435ed),'jpeg'); elseif ($v599dc==3 and function_exists('imagecreatefrompng')) return array (imagecreatefrompng($l435ed),'png'); elseif ($v599dc==16 and function_exists('imagecreatefromxbm')) return array (imagecreatefromxbm($l435ed),'xbm'); } function qfd08($l435ed,$p1b736=0,$vbfe4b=0){ $dcaf9b=getimagesize($l435ed); if (!$dcaf9b) return; if ($p1b736>0 and $vbfe4b>0){ if ($dcaf9b[0]>$p1b736) return; if ($dcaf9b[1]>$vbfe4b) return; } if ($dcaf9b[2]>3) return; return $dcaf9b[2]; } function w15e4($jfce75,$hc69cd,$md35fb,$vd6663,$p1c925=''){ if (!extension_loaded('gd')) { if (!dl('gd.so')) { header('Content-type: image/gif'); return false; } } list ($j73beb,$v599dc)=e6b8c($jfce75); if (!$j73beb){ return false; } $seaae2=imagesx($j73beb); $hb435e=imagesy($j73beb); $n0cb47=min($hc69cd/$seaae2,$md35fb/$hb435e); if ($n0cb47 < 1){ $hc69cd=round($seaae2*$n0cb47); $md35fb=round($hb435e*$n0cb47); } else { $hc69cd=$seaae2; $md35fb=$hb435e; } $y28e3d=imagecreatetruecolor($hc69cd,$md35fb); imageinterlace($y28e3d,1); if (empty ($p1c925)) { $v19229=stat($jfce75); $v19229=date('r',$v19229['mtime']); header('Last-Modified: '.$v19229); } imagecopyresampled($y28e3d,$j73beb,0,0,0,0,$hc69cd,$md35fb,$seaae2,$hb435e); imagejpeg($y28e3d,$p1c925,$vd6663); return true; } function e2s_sync(){ e2_drop_all_kinds_of_cache(); die ('Sync done.'); } function e2_note_cache_filename_with_id_($lb80bb){ return str_replace('*',$lb80bb,CACHE_FILENAMES_NOTES); } function e2_drop_caches_for_note_($b21158){ we2f1(); q22e7(); @unlink(e2_note_cache_filename_with_id_($b21158)); @unlink(e2_note_cache_filename_with_id_($b21158 .'-comments')); @unlink(CACHE_FILENAME_HOT); @unlink(CACHE_FILENAME_FAVS); @unlink(CACHE_FILENAME_FRONTPAGE); @unlink(CACHE_FILENAME_FRONTPAGE_AUTHOR); @unlink(CACHE_FILENAME_FRONTPAGE_RSS); @unlink(CACHE_FILENAME_FULLLIST); } function j7996(){ vc5a6(CACHE_FILENAMES_NOTES); vc5a6(CACHE_FILENAMES_NOTES_COMMENTS); @unlink(CACHE_FILENAME_FRONTPAGE); @unlink(CACHE_FILENAME_FRONTPAGE_AUTHOR); @unlink(CACHE_FILENAME_FRONTPAGE_RSS); } function we2f1(){ vc5a6(CACHE_FILENAMES_NOTES_COUNTS); } function q22e7(){ vc5a6(CACHE_FILENAMES_EDGE_TIMEINFO); } function e2_drop_all_kinds_of_cache(){ vc5a6(CACHES_FOLDER.'*'); return true; } function y4e27($x139c8){ global$_template; $maf10b=array(); $l8598c=$x139c8; $e620f7=TEMPLATES_FOLDER.$l8598c .'/'; if ( e2_is_installed() and $x139c8!='' and !array_key_exists('themeless',$_GET) ) { if ( is_dir($e620f7) and is_file($e620f7 .'/theme-info.php') ) { while (1){ $e620f7=TEMPLATES_FOLDER.$l8598c .'/'; array_push($maf10b,$e620f7); $n38226=include $e620f7 .'/theme-info.php'; $i4e502[$e620f7]=$n38226; if(array_key_exists('based_on',$n38226)) { $l8598c=$n38226['based_on']; } else { break; } } } else { } } array_push($maf10b,DEFAULT_TEMPLATE_FOLDER); $_template['name']=$x139c8; $_template['stack']=$maf10b; $_template['infos']=$i4e502; return$_template; }; function e53ee($nd436e){ global$content; ++ $_olba_includes; include $nd436e; } function k6a97($j52678){ if(0){ echo '<div style="background: #ff0">'.$j52678.'</div>'; } if(is_dir(EXTRAS_FOLDER)) { $v71cae=EXTRAS_FOLDER.$j52678 .'.tmpl.php'; if(is_file($v71cae)) { e53ee($v71cae); } } return ''; } function b166b($j52678){ global$_template,$_olba_includes; $v71cae='templates/'. $j52678 .'.tmpl.php'; if ($nd436e=e2o__usable_file_with_basename_($v71cae)) { e53ee($nd436e); } else { n1928($v71cae); } } function ybc21(){ global$_config; if (@$_config['raw_template_data'] or array_key_exists('raw',$_GET)) { $f3f7d9='raw'; } else { $f3f7d9='main'; } return b166b($f3f7d9); } function n1928($e8b7af){ ff1da($e8b7af,'_olba_missing_templates'); } function wd4c1($r45ac4){ ff1da($r45ac4,'_olba_used_stylesheets'); } function md00a($c3205c){ ff1da($c3205c,'_olba_used_scripts'); } function fe655(){ global$_olba_missing_templates; if (isset ($_olba_missing_templates)) { return array_unique($_olba_missing_templates); } } function h94dd(){ global$_template; $sccf6b['']=DEFAULT_TEMPLATE_FOLDER; if ($oe1260=@opendir(TEMPLATES_FOLDER)) { while (false !== ($z1f769=readdir($oe1260))) { if(is_dir(TEMPLATES_FOLDER. $z1f769) and $z1f769!='.' and $z1f769!='..'){ if(is_file(TEMPLATES_FOLDER.$z1f769 .'/theme-info.php')) { $sccf6b[$z1f769]=TEMPLATES_FOLDER.$z1f769 .'/'; } } } closedir($oe1260); } $y10ae9=array(); foreach ($sccf6b as $ab0689 => $c85114){ $n38226=include $c85114 .'theme-info.php'; $dc2657=$n38226['display_name']; if (!is_file($nbe5fb=$c85114.$s8c7dd .'preview.png')) { $nbe5fb=DEFAULTS_FOLDER.'preview.png'; } $y10ae9[] = array ( 'name' => $ab0689, 'display-name' => $dc2657, 'current?' => (bool) ($ab0689==$_template['name']), 'preview' => $nbe5fb, ); } return $y10ae9; } function o1492($l435ed){ return e2o__usable_file_with_basename_('images/'. $l435ed); } function w576f($r45ac4){ global$_template; $y954eb='styles/'. $r45ac4 .'.css'; $m95aa1=array(); foreach($_template['stack'] as $e620f7){ if(is_file($l435ed=$e620f7.$y954eb)) { $m95aa1[] = $l435ed; } if ( array_key_exists('reset_styles',$_template['infos'][$e620f7]) and in_array($r45ac4,$_template['infos'][$e620f7]['reset_styles']) ) { break; } } $m95aa1=array_reverse($m95aa1); } function e37ca(){ global$_olba_used_stylesheets,$_template; $_olba_used_stylesheets=array_unique($_olba_used_stylesheets); $vc7f50=array(); foreach($_olba_used_stylesheets as $r45ac4){ $y954eb='styles/'. $r45ac4 .'.css'; $m95aa1=array(); foreach($_template['stack'] as $e620f7){ if(is_file($l435ed=$e620f7.$y954eb)) { $m95aa1[] = $l435ed; } if ( array_key_exists('reset_styles',$_template['infos'][$e620f7]) and in_array($r45ac4,$_template['infos'][$e620f7]['reset_styles']) ) { break; } } $m95aa1=array_reverse($m95aa1); $vc7f50=array_merge($vc7f50,$m95aa1); } return $vc7f50; } function l4753(){ global$_olba_used_scripts; $_olba_used_scripts=array_unique($_olba_used_scripts); $ld6c58=array(); foreach($_olba_used_scripts as $c3205c){ $y954eb='js/'. $c3205c .'.js'; if ($h9d679=e2o__usable_file_with_basename_($y954eb)) { $ld6c58[] = $h9d679; } } return $ld6c58; } function ff1da($j2063c,$kf1f71){ if (!isset ($GLOBALS[$kf1f71])) { $GLOBALS[$kf1f71] = array ($j2063c); } else { $GLOBALS[$kf1f71][] = $j2063c; } } function e2o__usable_file_with_basename_($y954eb){ global$_template; foreach($_template['stack'] as $e620f7){ if(is_file($l435ed=$e620f7.$y954eb)) { return $l435ed; } } return ''; } function e2s_search(){ global $r2e5d8; $g1b1cc=@$_POST['query']; $g1b1cc=ufd97($g1b1cc); e2_go_to(x83c8('e2m_found', array ('query' => $g1b1cc))); die; } function e2m_found($parameters=array ()) { global $r2e5d8; $parameters['query']=pedd9(trim($parameters['query'])); $g1b1cc=$parameters['query']; if (!$g1b1cc){ return array ( 'title' => 'Текст для поиска пуст', 'heading' => 'Поиск', 'no-notes-text' => 'Текст для поиска пуст, напишите что-нибудь.', ); } if(strlen($g1b1cc) < 4){ return array ( 'title' => 'Слишком короткий текст', 'heading' => 'Поиск', 'no-notes-text' => 'Слишком короткий текст, напишите хотя бы 4 буквы.', ); } $a099fb=$g1b1cc; $rf79b1="AND `IsVisible`=1 "; if (oe852())$rf79b1=''; $h11128=false; if (z0738( "SELECT * FROM `". $r2e5d8['db']['table_prefix']."Keywords` ". "WHERE `Keyword`='".h7928($g1b1cc)."'" )) { $kfa816=t0d6b(); if (isset ($kfa816[0]['ID'])) { $h11128=array ( 'href' => x83c8( 'e2m_tag', TRANS_TAGS_UTF8_URLS ? array ('tag' => htmlspecialchars($kfa816[0]['Keyword'])) : array ('tag-urlname' => $kfa816[0]['URLName']) ), 'name' => htmlspecialchars($g1b1cc), ); } } $m75006='Ничего не найдено.'; $j3ad42=x83c8('e2m_found_rss', array ('query' => $g1b1cc)); x3010( 'Результаты поиска: '. htmlspecialchars($g1b1cc),$j3ad42 ); $f36a38=h7928(preg_quote($g1b1cc)); $leb31b=( "SELECT * FROM `". $r2e5d8['db']['table_prefix']."Notes` ". "WHERE `IsPublished`=1 AND MATCH (`Title`, `Text`) AGAINST ('". $f36a38 ."')". $rf79b1 ); $n8d777=array ( 'query' => $leb31b, 'page' => $parameters['page'], 'candy' => 'e2m_found', 'parameters' => $parameters, 'title' => '%total% по запросу: '. $a099fb, 'superheading' => '%total% по запросу', 'heading' => $a099fb, 'related-rss-href' => $j3ad42, 'highlight' => v163d(' ',$g1b1cc), 'no-notes-text' => $m75006, ); if ($h11128){ $n8d777['search-related-tag']=$h11128; } return md864($n8d777); } function ff8c7($y0c426,$content){ $k52766=MTMPL_FOLDER.$y0c426 .'.mtmpl.php'; if(is_file($k52766)) { ob_start(); include $k52766; $yb4a11=ob_get_contents(); ob_end_clean(); $yb4a11=explode("\n",trim($yb4a11),2); $gc7191=trim($yb4a11[0]); $wde7a3=trim(@$yb4a11[1]); return array ($gc7191,$wde7a3); } } function iaed2(){ global$_config; $y9e35a=$_config['mail_from']; if ($y9e35a[strlen($y9e35a)-1]=='@'){ $y9e35a.=$_SERVER['SERVER_NAME']; } return $y9e35a; } function ua41b($x01b6e,$subject,$h78e73,$c145a2='',$db2cb3=''){ global $a57de2; if ($a57de2==DEV_HOST){ $o8fa14=tempnam('mail-debug',''); $t1cb25=( 'To:       '.$x01b6e."\n". 'Subject:  '.$subject."\n". "——————————————————————————————————————————————————\n". $h78e73 ); t6e52($o8fa14,$t1cb25); chmod($o8fa14,NEW_FILES_RIGHTS); rename($o8fa14,$o8fa14.'.txt'); } else { $subject='=?Windows-1251?B?'. base64_encode($subject) .'?='; $c145a2.="\r\nContent-Type: text/plain; charset=windows-1251"; mail($x01b6e,$subject,$h78e73,$c145a2,$db2cb3); } } function _A($t1cb25){ global$_candy,$a57de2,$ya57c1,$c097cc; if ( preg_match('/\<a href\=\"(.*?)\"\>(.*?)\<\/a\>/si',$t1cb25,$j9c28d) and ( $j9c28d[1]=='' or $j9c28d[1]==$c097cc or 'http://'. $a57de2.$j9c28d[1]==$c097cc or 'http://'. $a57de2.$ya57c1 .'/'. $j9c28d[1]==$c097cc or $_candy=='e2m_install' ) ) { return '<span class="current">'. $j9c28d[2] .'</span>'; } else { return $t1cb25; } } function _AT($ce8fab){ global$_candy,$a57de2,$ya57c1,$c097cc; return ( $ce8fab=='' or $ce8fab==$c097cc or 'http://'. $a57de2.$ce8fab==$c097cc or 'http://'. $a57de2.$ya57c1 .'/'. $ce8fab==$c097cc ); } function _IMGSRC($l435ed){ return o1492($l435ed); } function _COLOR($zf97c5,$fb8a9f,$vcc321,$n4efa2=1){ if(strlen($zf97c5)!=3 and strlen($zf97c5)!=6) return 'f0f'; if(strlen($fb8a9f)!=3 and strlen($fb8a9f)!=6) return 'f0f'; if(strlen($zf97c5)==3)$zf97c5=$zf97c5{0}.$zf97c5{0}.$zf97c5{1}.$zf97c5{1}.$zf97c5{2}.$zf97c5{2}; if(strlen($fb8a9f)==3)$fb8a9f=$fb8a9f{0}.$fb8a9f{0}.$fb8a9f{1}.$fb8a9f{1}.$fb8a9f{2}.$fb8a9f{2}; $vf09cc=array ( $zf97c5{0}.$zf97c5{1}, $zf97c5{2}.$zf97c5{3}, $zf97c5{4}.$zf97c5{5}, $fb8a9f{0}.$fb8a9f{1}, $fb8a9f{2}.$fb8a9f{3}, $fb8a9f{4}.$fb8a9f{5}, ); foreach ($vf09cc as $q8ce4b => $d9e366){ $vf09cc[$q8ce4b]=hexdec($d9e366); } $e22af6=array ( $vf09cc[0]+pow($vcc321,$n4efa2) * ($vf09cc[3]-$vf09cc[0]), $vf09cc[1]+pow($vcc321,$n4efa2) * ($vf09cc[4]-$vf09cc[1]), $vf09cc[2]+pow($vcc321,$n4efa2) * ($vf09cc[5]-$vf09cc[2]), ); $t70dda=''; foreach ($e22af6 as $q8ce4b => $d9e366){ $t70dda.=str_pad(dechex($d9e366),2,'0',STR_PAD_LEFT); } return $t70dda; } function _DT($j1ddcb,$pb35c6){ if (!$pb35c6) return ''; list ($z96b8c,$qb2c6c)=$pb35c6; $t2cb9d=$j1ddcb; $t7436f=e2_format_dt_of_timezone('m',$z96b8c,$qb2c6c); $t2cb9d=str_replace('{zone}',cada7(e2_format_timezone_offset($qb2c6c['offset'])), $t2cb9d); $t2cb9d=str_replace('{month}',cada7(e2_ru_month_nominative($t7436f)), $t2cb9d); $t2cb9d=str_replace('{month-short}',cada7(e2_ru_month_short_nominative($t7436f)), $t2cb9d); $t2cb9d=str_replace('{month-g}',cada7(e2_ru_month_genitive($t7436f)), $t2cb9d); $t2cb9d=e2_format_dt_of_timezone($t2cb9d,$z96b8c,$qb2c6c); return $t2cb9d; } function _AGO($pb35c6){ return e2_ru_ago($pb35c6[0], array ('offset' => $pb35c6[1]['offset'],'is_dst' => $pb35c6[1]['is_dst']) ); } function _NUM($t1cb25){ return tace2($t1cb25); } function _SIZE($size,$i3e34b=_SIZE_AUTO){ return p2d88($size,$i3e34b); } function _FIRST($h437b9){ return ($h437b9['_']['_ord']==0); } function _LAST($h437b9){ return ($h437b9['_']['_ord']==$h437b9['_']['_ord_max']); } function _CSS($oc7a62){ return wd4c1($oc7a62); } function _CSS_HREF($oc7a62){ return w576f($oc7a62); } function _JS($u32981){ return md00a($u32981); } function _T($j52678){ return b166b($j52678); } function _X($j52678){ return k6a97($j52678); } function _T_FOR($j52678,$od5566=null){ global$content; if ($od5566===null)$od5566=$j52678; if(array_key_exists($od5566,$content)) { b166b($j52678); } else { return ''; } } function _GUIDES($ceca07=false){ global$_olba_guides; if(is_array($ceca07))$_olba_guides=$ceca07; if (!is_array($_olba_guides)) return; $z88408='<div style="position: fixed; width: 100%; height: 100%; z-index: -100">'; $c1d623=0; $m07d43=$_olba_guides; $m07d43[] = 100; foreach ($m07d43 as $h865c0 => $td89e2){ if ($td89e2==100) break; $c1d623+=$td89e2; $z88408.='<div style="position: fixed; left: '. $td89e2 .'%; width: 0; height: 100%; border-left: 1px #000 dotted; opacity: .2; -webkit-opacity: .2; -moz-opacity: .2"></div>'; $ca1b01='position: absolute; padding: 2px 3px; top: 0; font-size: 9px; background: #ccc; color: #000; font-family: "Verdana", sans-serif; opacity: .8; -webkit-opacity: .8; -moz-opacity: .8'; if ($m07d43 [$h865c0+1]-$m07d43 [$h865c0] < 4){ $z88408.='<div style="'. $ca1b01.'; right: '. (100-$td89e2) .'%; border-bottom-left-radius: .5em; -webkit-border-bottom-left-radius: .5em; -moz-border-bottom-left-radius: .5em;">'. $td89e2 .'%</div>'; } else { $z88408.='<div style="'. $ca1b01.'; left: '. $td89e2 .'%; border-bottom-right-radius: .5em; -webkit-border-bottom-right-radius: .5em; -moz-border-bottom-right-radius: .5em;">'. $td89e2 .'%</div>'; } } $z88408.='</div>'; $_olba_current_col=0; return $z88408; } function _SHORTCUT($ab0689){ return sbb8d($ab0689); } if (!$h589b3) @include 'builder.php'; function e2(){ global $a57de2,$r2e5d8,$errors,$e15d61,$baaabf,$content, $ya57c1,$lf97aa,$stopwatch,$d11755,$c097cc, $a5c4a6, $_instance, $_candy, $_config, $_auth_sessions, $_route, $_candies_installer, $_candies_public, $_candies_spawning, $_candies_unabortable, $_candies_indexable, $_candies_indexable_conditionally, $_update_info, $_olba_includes; r8e95(); ba208(); if(__LOG)__log('System: go'); $errors=array(); $a5c4a6=array(); header('Content-type: text/html; charset='. OUTPUT_CHARSET); $_instance=false; if(is_file(USER_FOLDER.'instance.psa')) { $b0d149=@acdf0(USER_FOLDER.'instance.psa') or $b0d149=false; if ($b0d149){ $b0d149=@unserialize($b0d149) or $b0d149=false; if ($b0d149){ $_instance=$b0d149; } } } $v66f61=y4e27(@$r2e5d8['template']); if(__LOG)__log('System: resolve url <'. $_GET['go'] .'>'); o7059(); list ($lc48ba,$parameters)=tb7e9($_GET['go']); if(__LOG)__log( 'System: candy <'. $lc48ba .'>' ); $_candy=$lc48ba; if ( @$_config['debug_slow_ajax'] and ( @$parameters['result']=='ajaxresult' or (array_key_exists('result',$_POST) and ($_POST['result']=='ajaxresult')) ) ) { sleep(1+2 * (rand()/getrandmax())); } if (!in_array($lc48ba,$_candies_installer)) { e2_make_sure_that_installed(); } if(in_array($lc48ba,$_candies_unabortable)) { ignore_user_abort(1); } $r58387=(bool)oe852(); $h0b448=!in_array($lc48ba,$_candies_public); $n49ecc=$h0b448 && !$r58387; if(__LOG)__log('System: Security check '. (int)$r58387); $pc1f6f=array ( 'done?' => $r58387, 'required?' => $h0b448, 'necessary?' => $n49ecc, ); $a5c4a6['newsfeeds'] = array (); x3010( htmlspecialchars(r6f51(),ENT_NOQUOTES), x83c8('e2m_frontpage_rss') ); $parameters=e2_unfold_tag_parameters($parameters); if(is_callable($lc48ba)) { if ($n49ecc){ if(substr($lc48ba,0,4)=='e2s_'){ $content=call_user_func('e2s_sign_in_necessary'); } else { $content['title']='Вход'; $content['sign-in-prompt']=de68c($lc48ba); } } else { if(__LOG)__log('System: Candy call'); $content=call_user_func($lc48ba,$parameters); if(__LOG)__log('System: Candy return'); } } else { $pc1f6f['required?']=false; $pc1f6f['necessary?']=false; $content=e2_error404_mode(); } $content['class']=str_replace('_','-',str_replace('e2m_','',$lc48ba)); $te1671=eec07(); if ($te1671){ $content['message']=$te1671; } $content['_debug'] = array ( '_candy' => $lc48ba, '_parameters' => $parameters, ); $content['sign-in']=$pc1f6f; $content['sessions']['count']=$_auth_sessions['count']; $content['sessions']['multiple?'] = ($_auth_sessions['count'] > 1); if(e2_is_installed()) { if($_config['update_check'] and oe852()) { if(__LOG)__log('System: reading update info...'); $_update_info=@unserialize(acdf0(USER_FOLDER. '/update-info.psa')); if($_update_info){ if(DOWNLOAD_UPDATES){ $content['update-info']['downloaded?']=$content['update-info']['ready?']=array_key_exists('version-downloaded',$_update_info); } else { $content['update-info']['ready?'] = (bool)$_update_info['status']['available?']; } if($content['update-info']['ready?']) { $content['update-info']['important?'] = (bool) @$_update_info['status']['important?']; $content['update-info']['changesets-count'] = @$_update_info['status']['changesets-count']; } } if(in_array($lc48ba,$_candies_spawning)) { if ( !@$_update_info['last-check'] or @$_update_info['last-check'] < time()-$_config['update_check_interval'] ) { if (!tcc38(x83c8('e2s_check_updates', array ()))) { $_update_info['last-check-failed']=true; } } } if(__LOG)__log('System: done with update check'); } if(array_key_exists('pages',$content)) { $s6ea04=false; if(array_key_exists('prev-href',$content['pages'])) { $a5c4a6['navigation_links']['prev']=$content['pages']['prev-href']; $s6ea04=true; } if(array_key_exists('next-href',$content['pages'])) { $a5c4a6['navigation_links']['next']=$content['pages']['next-href']; $s6ea04=true; } if ($s6ea04){ md00a('e2-navigation'); } } $content['navigation-links'] = array (array ( 'rel' => 'index', 'href' => x83c8('e2m_frontpage'), 'id' => 'link-index', )); if(array_key_exists('navigation_links',$a5c4a6)) { foreach ($a5c4a6['navigation_links'] as $r7ffc4 => $ce8fab){ if ($r7ffc4=='prev')$m20512='id="link-prev" '; if ($r7ffc4=='next')$m20512='id="link-next" '; $content['navigation-links'][] = array ( 'rel' => $r7ffc4, 'href' => $ce8fab, 'id' => 'link-'. $r7ffc4, ); } } if(array_key_exists('query',$parameters)) { $g1b1cc=pedd9(trim($parameters['query'])); } else { $g1b1cc=''; } $content['form-search'] = array ( 'form-action' => x83c8('e2s_search'), 'query' => htmlspecialchars(@$g1b1cc), ); } $n1e2ad='noindex, follow'; if (@$_config['index_follow_everything']) { $n1e2ad='index, follow'; } if(in_array($lc48ba,$_candies_indexable)) { $content['robots']='index, follow'; } if(in_array($lc48ba,$_candies_indexable_conditionally)) { $content['robots']=$n1e2ad; } $content['output-charset']=OUTPUT_CHARSET; $content['base-href']=$lf97aa. '/'; $content['current-href']=$c097cc; $content['title']=strip_tags(q6f10(htmlspecialchars($content['title'],ENT_NOQUOTES))); if (@$content['heading']) { $content['heading']=strip_tags(q6f10(htmlspecialchars($content['heading'],ENT_NOQUOTES))); } $content['blog']['author']=htmlspecialchars(k2640(),ENT_NOQUOTES); if(array_key_exists('description',$r2e5d8)) { $content['blog']['description']=htmlspecialchars($r2e5d8['description'],ENT_NOQUOTES); } $content['blog']['live-author'] = '<span id="e2-blog-author">'. $content['blog']['author'] .'</span>'; $content['blog']['live-description'] = '<span id="e2-blog-description">'. $content['blog']['description'] .'</span>'; $content['blog']['title']=htmlspecialchars(r6f51(),ENT_NOQUOTES); $content['blog']['live-title'] = '<span id="e2-blog-title">'. $content['blog']['title'] .'</span>'; $content['blog']['userpic-href']=DEFAULTS_FOLDER.'userpic.png'; if(is_file(USER_FOLDER .'userpic.png')) { $content['blog']['userpic-href']=USER_FOLDER .'userpic.png'; } elseif(is_file(USER_FOLDER .'userpic.jpg')) { $content['blog']['userpic-href']=USER_FOLDER .'userpic.jpg'; } $content['blog']['href']=x83c8('e2m_frontpage'); $content['blog']['rss-href']=x83c8('e2m_frontpage_rss'); $p97bc5=array (time(),e2_current_timezone()); $w5f36b=e2_format_dt_of_current_timezone('Y',$p97bc5[0]); $content['blog']['now']=$p97bc5; $qaa103=$w5f36b; $u33b09=wcc02('start'); if(array_key_exists('stamp',$u33b09)) { $qaa103=e2_format_dt_of_current_timezone('Y',$u33b09['stamp']); $content['blog']['start-time'] = array ((int)$u33b09['stamp'],$u33b09['timezone']); } $z40d73=(int)h8ca0(true,true); if (oe852()) { list ($tfe9e2,$t85ee4,$t20699)=b2a6b(); if ($tfe9e2)$content['new-comments'] = array ( 'count' => $tfe9e2, 'texts' => $t85ee4, 'href' => $t20699, ); } if (oe852()) { $ed0a87=(($z40d73 + (int)h8ca0(true,false)) == 0); } else { $ed0a87=($z40d73==0); } if($_db_error){ $ed0a87=false; } $p9fbfe=$_config['years_range_separator']? $_config['years_range_separator']:'&mdash;'; $content['blog']['years-range']=$qaa103 . (($qaa103==$w5f36b)? '':($p9fbfe.$w5f36b)); $content['blog']['notes-count']=$z40d73; $content['blog']['virgin?']=$ed0a87; if ($ya57c1){ $content['blog']['parent-site-href']=substr($ya57c1, (int)strpos('/',$ya57c1)); } $content['hrefs'] = array ( 'sign-in' => x83c8('e2m_sign_in'), 'tags' => x83c8('e2m_tags'), 'everything' => x83c8('e2m_everything'), ); if(__LOG)__log('System: e2_modes call'); e2_modes($parameters); if(__LOG)__log('System: e2_modes return'); $content['misc']['sape-link']='http://www.sape.ru/r.206a4276c2.php'; $gc8542=round(f7f78()-$stopwatch,3); $content['engine']['pgt']=str_replace('.',',',$gc8542); if(function_exists('memory_get_peak_usage')) { $content['engine']['mp']=p2d88(memory_get_peak_usage(),_SIZE_MB); } $content['engine']['qc'] = (int) @$d11755; $content['engine']['built?']=$h589b3; $content['engine']['installed?']=e2_is_installed(); $content['engine']['version']='v'. E2_VERSION; $content['engine']['version-description']=E2_VERSION_DESCRIPTION; $content['engine']['href']=E2_WEBSITE; $content['engine']['about']='<span title="E2 '.E2_VERSION_DESCRIPTION .'">Движок&nbsp;&mdash; <a href="'. E2_WEBSITE .'">'. E2_VERSION_NAME .'</a></span>'; $content['_debug']['_current_url']=$c097cc; $content['_debug']['_folder_on_server']=$ya57c1; $content['stylesheets']=e37ca(); $content['scripts']=l4753(); ob_start(); ybc21(); $i78e62=ob_get_contents(); ob_end_clean(); $content['stylesheets']=e37ca(); $content['scripts']=l4753(); if(array_key_exists('newsfeeds',$a5c4a6)) { $content['newsfeeds']=$a5c4a6['newsfeeds']; } ob_start(); b166b('head'); $i96e89=ob_get_contents(); ob_end_clean(); $i78e62=str_replace('<e2:head-data />',$i96e89,$i78e62); if ( $wa0856=fe655() and !$_config['ignore_missing_template_files'] ) { echo '<h1>Templates missing</h1>'; echo '<ul>'; foreach ($wa0856 as $q380ec){ echo '<li>'. $q380ec.' </li>'; } echo '</ul>'; echo '<pre>'; print_r($content); echo '</pre>'; } else { echo $i78e62; } if(__LOG)__log('System: end'); if(DEV_TRACK_TIME and $a57de2==DEV_HOST){ $q06bc4=str_replace('.',',',round(f7f78()-$stopwatch,3)-$gc8542); echo '<div style="font-size: 300%; text-align: center; position: fixed; bottom: 0; width: 100%; background: #ffc; opacity: .88">'. '<span style="color: #f80">'. $content['engine']['pgt'] .' '. '<small>'. $content['engine']['qc'] .'q</small></span>'. '<span style="color: #08f"> + '. $q06bc4.' '. '<small>'. $_olba_includes .'i</small></span>'. '</div>'; } } if(__LOG)__log(''); ?>